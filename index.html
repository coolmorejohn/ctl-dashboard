<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coolmore Truck Lines - Daily Operating Report</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .status-active { background: #22c55e; color: white; }
    .status-routine { background: #facc15; color: #1f2937; }
    .status-breakfix { background: #f97316; color: white; }
    .status-nodriver { background: #ef4444; color: white; }
    .status-spare { background: #9ca3af; color: white; }

    /* Mobile table improvements */
    @media (max-width: 768px) {
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      .overflow-x-auto::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 20px;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
        pointer-events: none;
      }
      .overflow-x-auto { position: relative; }
    }

    /* Print styles */
    @media print {
      .no-print { display: none !important; }
      body { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useCallback, useRef } = React;

    // ============================================
    // CONSTANTS
    // ============================================
    const CONSTANTS = {
      FLAGGED_MARGIN_THRESHOLD: 95,      // Flag loads with margin >= this %
      FLAGGED_REVENUE_THRESHOLD: 500,    // Only flag if revenue > this $
      CONNECTION_TIMEOUT_MS: 5000,       // API connection check timeout
      WARNING_THRESHOLD_PERCENT: 0.9,    // Yellow warning at 90% of target
    };

    // ============================================
    // GOOGLE SHEETS CONFIGURATION
    // ============================================
    // TODO: Move to environment config for production deployment
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZ0714JE5nUYsEby7oSclteaNo5UsAtk4sAKgB7vjWkAJAvZU8Fnp3UD4ggcaY2D-xuQ/exec';

    const SheetsDB = {
      async read(sheetName) {
        try {
          const url = `${SCRIPT_URL}?action=read&sheet=${encodeURIComponent(sheetName)}&t=${Date.now()}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          if (result.data) {
            localStorage.setItem(`CTL_${sheetName}`, JSON.stringify(result.data));
            return result.data;
          }
          return null;
        } catch (error) {
          console.warn(`Sheets read failed for ${sheetName}:`, error.message);
          const cached = localStorage.getItem(`CTL_${sheetName}`);
          return cached ? JSON.parse(cached) : null;
        }
      },

      async write(sheetName, data, reportDate = null) {
        localStorage.setItem(`CTL_${sheetName}`, JSON.stringify(data));
        try {
          const payload = { action: 'write', sheet: sheetName, data };
          if (reportDate) payload.reportDate = reportDate;
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return { success: true, synced: true };
        } catch (error) {
          console.warn(`Sheets write failed for ${sheetName}:`, error.message);
          return { success: false, synced: false, error: error.message };
        }
      },

      async readAll() {
        try {
          const url = `${SCRIPT_URL}?action=readAll&t=${Date.now()}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          if (result.data) {
            Object.keys(result.data).forEach(key => {
              localStorage.setItem(`CTL_${key}`, JSON.stringify(result.data[key]));
            });
            return { data: result.data, source: 'sheets' };
          }
        } catch (error) {
          console.warn('Sheets readAll failed:', error.message);
        }
        const sheets = ['Fleet', 'Goals', 'TruckStatus', 'DailyLogs', 'Shipments', 'MonthlyPlan'];
        const data = {};
        sheets.forEach(name => {
          const cached = localStorage.getItem(`CTL_${name}`);
          if (cached) data[name] = JSON.parse(cached);
        });
        return { data, source: 'localStorage' };
      },

      async checkConnection() {
        try {
          const url = `${SCRIPT_URL}?action=init&t=${Date.now()}`;
          const response = await fetch(url, { signal: AbortSignal.timeout(CONSTANTS.CONNECTION_TIMEOUT_MS) });
          return response.ok;
        } catch {
          return false;
        }
      }
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    const fmt = (n) => n?.toLocaleString('en-US', { maximumFractionDigits: 0 }) || '0';
    const fmtCurrency = (n) => '$' + fmt(Math.round(n || 0));
    const fmtDecimal = (n, d = 2) => (n || 0).toFixed(d);
    const fmtPercent = (n) => fmtDecimal(n || 0, 1) + '%';

    // Normalize truck ID from TORO format to internal format
    // TORO exports: "0", "7", "9", "57" -> Internal: "000", "007", "009", "0057"
    // This maps single/double digit trucks to their padded versions
    const TRUCK_ID_MAP = {
      '0': '000',
      '1': '001',
      '7': '007',
      '9': '009',
      '57': '0057',
    };

    const normalizeTruckId = (id) => {
      if (!id || id === 'Unassigned') return '';
      const str = String(id).trim();
      // Check if there's a mapping for this truck ID
      if (TRUCK_ID_MAP[str]) {
        return TRUCK_ID_MAP[str];
      }
      // Otherwise return as-is (for trucks like 555, 1970, 4649, etc.)
      return str;
    };

    // Safe division helper to prevent NaN/Infinity
    const safeDivide = (numerator, denominator, fallback = 0) => {
      if (!denominator || denominator === 0) return fallback;
      return numerator / denominator;
    };

    // Validate and clamp numeric inputs
    const validateGoalInput = (value, min, max, defaultVal) => {
      const num = parseFloat(value);
      if (isNaN(num)) return defaultVal;
      if (min !== null && num < min) return min;
      if (max !== null && num > max) return max;
      return num;
    };

    const getStatusClass = (status) => {
      const classes = {
        'Active': 'status-active',
        'Shop - Routine': 'status-routine',
        'Shop - Break/Fix': 'status-breakfix',
        'Needs Driver': 'status-nodriver',
        'Spare': 'status-spare',
      };
      return classes[status] || 'bg-gray-200 text-gray-700';
    };

    const getColorClass = (value, target, floor = null) => {
      if (floor !== null && value < floor) return 'text-red-600';
      if (value >= target) return 'text-green-600';
      if (value >= target * CONSTANTS.WARNING_THRESHOLD_PERCENT) return 'text-yellow-600';
      return 'text-red-600';
    };

    // ============================================
    // ERROR BOUNDARY COMPONENT
    // ============================================
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true };
      }

      componentDidCatch(error, errorInfo) {
        this.setState({ error, errorInfo });
        console.error('Dashboard Error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
                <h1 className="text-xl font-bold text-red-600 mb-4">‚ö†Ô∏è Something went wrong</h1>
                <p className="text-gray-600 mb-4">
                  The dashboard encountered an error. Your data is safe - it's stored locally and will sync when the issue is resolved.
                </p>
                <details className="mb-4">
                  <summary className="cursor-pointer text-sm text-gray-500 hover:text-gray-700">Technical details</summary>
                  <pre className="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-40">
                    {this.state.error?.toString()}
                    {this.state.errorInfo?.componentStack}
                  </pre>
                </details>
                <div className="flex gap-3">
                  <button
                    onClick={() => window.location.reload()}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                  >
                    Reload Dashboard
                  </button>
                  <button
                    onClick={() => {
                      localStorage.clear();
                      window.location.reload();
                    }}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium"
                  >
                    Clear Cache & Reload
                  </button>
                </div>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // ============================================
    // CONFIRMATION MODAL COMPONENT
    // ============================================
    function ConfirmModal({ isOpen, title, message, onConfirm, onCancel }) {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4">
            <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
            <p className="text-gray-600 mb-6">{message}</p>
            <div className="flex justify-end gap-3">
              <button onClick={onCancel}
                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">
                Cancel
              </button>
              <button onClick={onConfirm}
                className="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 font-medium">
                Remove
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // MAIN DASHBOARD COMPONENT
    // ============================================
    function CTLDashboard() {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [loading, setLoading] = useState(true);
      const [syncing, setSyncing] = useState(false);
      const [connectionStatus, setConnectionStatus] = useState('checking');
      const [saveStatus, setSaveStatus] = useState('');
      const dashboardRef = useRef(null);
      const statusTimeoutRef = useRef(null);

      // Confirmation modal state
      const [confirmModal, setConfirmModal] = useState({ isOpen: false, truckIndex: null, truckId: '' });

      // Report date
      const [reportDate, setReportDate] = useState(() => new Date().toISOString().split('T')[0]);
      const reportMonth = useMemo(() => {
        const d = new Date(reportDate);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      }, [reportDate]);

      // Core data
      const [shipments, setShipments] = useState([]);
      const [dailyLogs, setDailyLogs] = useState([]);

      // Fleet - array of trucks with their properties
      // NOTE: Truck IDs use your internal naming (with leading zeros like 000, 007)
      const [fleet, setFleet] = useState([
        { id: '205', type: '', driver: '', notes: '' },
        { id: '1970', type: 'Van', driver: 'Robert Brewer', notes: '' },
        { id: '1225', type: 'Van', driver: 'Earl Bibbs', notes: '' },
        { id: '555', type: 'Flatbed', driver: 'Don Kernan', notes: '' },
        { id: '1776', type: 'Flatbed', driver: 'Delvin Hale', notes: '' },
        { id: '000', type: 'Flatbed', driver: 'Cordarius Williams', notes: '' },
        { id: '001', type: 'Flatbed', driver: '', notes: '' },
        { id: '007', type: 'Flatbed', driver: 'Tyson Magitt', notes: '' },
        { id: '009', type: 'Flatbed', driver: 'Steven Hill', notes: '' },
        { id: '0057', type: 'Flatbed', driver: '', notes: '' },
        { id: '3932', type: 'Flatbed', driver: 'Rodricus Barnett', notes: '' },
        { id: '4649', type: 'Flatbed', driver: '', notes: '' },
        { id: '8463', type: 'Flatbed', driver: 'Jonathan Emison', notes: '' },
        { id: '9239', type: 'Flatbed', driver: '', notes: '' },
      ]);

      // Truck status (keyed by truck ID)
      const [truckStatus, setTruckStatus] = useState({});
      const [truckExpectedReturn, setTruckExpectedReturn] = useState({});

      // Monthly plan - per-truck goal settings for the month
      const [monthlyPlan, setMonthlyPlan] = useState({});

      // Global goals (defaults)
      const [goals, setGoals] = useState({
        workdaysInMonth: 22,
        dailyRevenuePerTruck: 940,
        dailyMilesPerTruck: 412,
        targetRevPerTotalMile: 2.28,
        targetRevPerLoadedMile: 2.75,
        targetUtilization: 0.85,
        dailyICGrossMargin: 150,
        targetICGrossMarginPct: 15,
      });

      const statusOptions = ['Active', 'Shop - Routine', 'Shop - Break/Fix', 'Needs Driver', 'Spare'];
      const truckTypes = ['Van', 'Flatbed'];

      // ============================================
      // HELPER: Update a single fleet truck field immutably
      // ============================================
      const updateFleetField = useCallback((index, field, value) => {
        setFleet(prev => prev.map((truck, i) =>
          i === index ? { ...truck, [field]: value } : truck
        ));
      }, []);

      // ============================================
      // LOAD DATA ON MOUNT
      // ============================================
      useEffect(() => {
        async function loadData() {
          setLoading(true);
          const result = await SheetsDB.readAll();
          const data = result.data || {};

          if (data.Fleet?.length > 0) setFleet(data.Fleet);
          if (data.Goals) setGoals(prev => ({ ...prev, ...data.Goals }));
          if (data.Shipments) setShipments(data.Shipments);
          if (data.DailyLogs) setDailyLogs(data.DailyLogs);
          if (data.MonthlyPlan) setMonthlyPlan(data.MonthlyPlan);
          if (data.TruckStatus) {
            setTruckStatus(data.TruckStatus.status || {});
            setTruckExpectedReturn(data.TruckStatus.expectedReturn || {});
          }

          setConnectionStatus(result.source === 'sheets' ? 'connected' : 'offline');
          setLoading(false);
        }
        loadData();
      }, []);

      // ============================================
      // HELPER: Get truck's monthly plan
      // ============================================
      const getTruckPlan = useCallback((truckId) => {
        const key = `${reportMonth}_${truckId}`;
        const plan = monthlyPlan[key];
        if (plan) return plan;
        // Default: included full month with global targets
        return {
          included: truckStatus[truckId] !== 'Spare',
          startDate: `${reportMonth}-01`,
          endDate: null, // null means end of month
          dailyRevenue: goals.dailyRevenuePerTruck,
          dailyMiles: goals.dailyMilesPerTruck,
        };
      }, [monthlyPlan, reportMonth, truckStatus, goals]);

      const setTruckPlan = useCallback((truckId, updates) => {
        const key = `${reportMonth}_${truckId}`;
        setMonthlyPlan(prev => ({
          ...prev,
          [key]: { ...getTruckPlan(truckId), ...updates }
        }));
      }, [reportMonth, getTruckPlan]);

      // ============================================
      // COMPUTED: Workdays calculation
      // ============================================
      const workdaysCalc = useMemo(() => {
        const year = new Date(reportDate).getFullYear();
        const month = new Date(reportDate).getMonth();
        const currentDate = new Date(reportDate);
        const lastDay = new Date(year, month + 1, 0).getDate();

        let totalWorkdays = 0;
        let workdaysElapsed = 0;

        for (let day = 1; day <= lastDay; day++) {
          const d = new Date(year, month, day);
          const isWeekday = d.getDay() !== 0 && d.getDay() !== 6;
          if (isWeekday) {
            totalWorkdays++;
            if (d <= currentDate) workdaysElapsed++;
          }
        }

        return {
          total: goals.workdaysInMonth || totalWorkdays,
          elapsed: workdaysElapsed,
          percent: workdaysElapsed / (goals.workdaysInMonth || totalWorkdays),
        };
      }, [reportDate, goals.workdaysInMonth]);

      // ============================================
      // COMPUTED: Per-truck goals for the month
      // ============================================
      const truckGoals = useMemo(() => {
        const result = {};
        const year = new Date(reportDate).getFullYear();
        const month = new Date(reportDate).getMonth();

        fleet.forEach(truck => {
          const plan = getTruckPlan(truck.id);
          if (!plan.included) {
            result[truck.id] = { included: false, workdays: 0, revenueGoal: 0, milesGoal: 0 };
            return;
          }

          // Calculate workdays for this truck
          const startDate = plan.startDate ? new Date(plan.startDate) : new Date(year, month, 1);
          const endDate = plan.endDate ? new Date(plan.endDate) : new Date(year, month + 1, 0);
          const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

          let truckWorkdays = 0;
          for (let day = 1; day <= lastDayOfMonth; day++) {
            const d = new Date(year, month, day);
            const isWeekday = d.getDay() !== 0 && d.getDay() !== 6;
            if (isWeekday && d >= startDate && d <= endDate) {
              truckWorkdays++;
            }
          }

          const dailyRev = plan.dailyRevenue || goals.dailyRevenuePerTruck;
          const dailyMi = plan.dailyMiles || goals.dailyMilesPerTruck;

          result[truck.id] = {
            included: true,
            workdays: truckWorkdays,
            revenueGoal: truckWorkdays * dailyRev,
            milesGoal: truckWorkdays * dailyMi,
            dailyRevenue: dailyRev,
            dailyMiles: dailyMi,
            startDate: plan.startDate,
            endDate: plan.endDate,
          };
        });

        return result;
      }, [fleet, getTruckPlan, reportDate, goals]);

      // ============================================
      // COMPUTED: Total monthly goals (sum of truck goals)
      // ============================================
      const totalGoals = useMemo(() => {
        let revenueGoal = 0;
        let milesGoal = 0;
        let trucksIncluded = 0;

        Object.values(truckGoals).forEach(tg => {
          if (tg.included) {
            revenueGoal += tg.revenueGoal;
            milesGoal += tg.milesGoal;
            trucksIncluded++;
          }
        });

        const icGMGoal = goals.dailyICGrossMargin * workdaysCalc.total;

        // Total revenue goal = Company Revenue + IC Revenue (not IC GM)
        // We need a daily IC revenue goal - estimate from GM goal assuming target margin %
        const icRevenueGoal = goals.targetICGrossMarginPct > 0
          ? (icGMGoal / goals.targetICGrossMarginPct) * 100
          : icGMGoal * 5; // Fallback: assume ~20% margin
        const totalRevenueGoal = revenueGoal + icRevenueGoal;

        return {
          revenue: revenueGoal,
          miles: milesGoal,
          trucksIncluded,
          revenuePacing: revenueGoal * workdaysCalc.percent,
          milesPacing: milesGoal * workdaysCalc.percent,
          icGrossMargin: icGMGoal,
          icGMPacing: goals.dailyICGrossMargin * workdaysCalc.elapsed,
          icRevenue: icRevenueGoal,
          icRevenuePacing: icRevenueGoal * workdaysCalc.percent,
          totalRevenue: totalRevenueGoal,
          totalRevenuePacing: totalRevenueGoal * workdaysCalc.percent,
        };
      }, [truckGoals, goals, workdaysCalc]);

      // ============================================
      // COMPUTED: Company truck metrics
      // ============================================
      const companyMetrics = useMemo(() => {
        // Note: No date filtering needed here - TORO export already contains only
        // shipments delivering in the target month. Report date is only used for
        // calculating % through the month for pacing purposes.
        const companyShipments = shipments.filter(s => !s.isIC);

        const totalRevenue = companyShipments.reduce((sum, s) => sum + (s.revenue || 0), 0);
        const totalMiles = companyShipments.reduce((sum, s) => sum + (s.totalMiles || 0), 0);
        const loadedMiles = companyShipments.reduce((sum, s) => sum + (s.loadedMiles || 0), 0);

        return {
          totalRevenue,
          totalMiles,
          loadedMiles,
          loadCount: companyShipments.length,
          revPerTotalMile: totalMiles > 0 ? totalRevenue / totalMiles : 0,
          revPerLoadedMile: loadedMiles > 0 ? totalRevenue / loadedMiles : 0,
          utilization: totalMiles > 0 ? loadedMiles / totalMiles : 0,
          shipments: companyShipments,
        };
      }, [shipments]);

      // ============================================
      // COMPUTED: Per-truck metrics
      // ============================================
      const truckMetrics = useMemo(() => {
        const byTruck = {};
        companyMetrics.shipments.forEach(s => {
          const truckId = normalizeTruckId(s.truck);
          if (!truckId) return;
          if (!byTruck[truckId]) {
            byTruck[truckId] = { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0 };
          }
          byTruck[truckId].revenue += s.revenue || 0;
          byTruck[truckId].totalMiles += s.totalMiles || 0;
          byTruck[truckId].loadedMiles += s.loadedMiles || 0;
          byTruck[truckId].loads += 1;
        });

        // Calculate rates
        Object.keys(byTruck).forEach(id => {
          const t = byTruck[id];
          t.revPerTotalMile = t.totalMiles > 0 ? t.revenue / t.totalMiles : 0;
          t.revPerLoadedMile = t.loadedMiles > 0 ? t.revenue / t.loadedMiles : 0;
          t.utilization = t.totalMiles > 0 ? t.loadedMiles / t.totalMiles : 0;
        });

        return byTruck;
      }, [companyMetrics.shipments]);

      // ============================================
      // COMPUTED: IC metrics
      // ============================================
      const icMetrics = useMemo(() => {
        // Note: No date filtering needed - TORO export already contains only
        // shipments delivering in the target month.
        const icShipments = shipments.filter(s => s.isIC);

        const byCarrier = {};
        icShipments.forEach(s => {
          const carrier = s.carrier || 'Unknown';
          if (!byCarrier[carrier]) {
            byCarrier[carrier] = { carrier, revenue: 0, cost: 0, grossProfit: 0, loads: 0 };
          }
          byCarrier[carrier].revenue += s.revenue || 0;
          byCarrier[carrier].grossProfit += s.grossProfit || 0;
          byCarrier[carrier].cost += (s.revenue || 0) - (s.grossProfit || 0);
          byCarrier[carrier].loads += 1;
        });

        const carriers = Object.values(byCarrier).map(c => ({
          ...c,
          grossMargin: c.revenue > 0 ? (c.grossProfit / c.revenue) * 100 : 0,
        })).sort((a, b) => b.revenue - a.revenue);

        const totalRevenue = icShipments.reduce((sum, s) => sum + (s.revenue || 0), 0);
        const totalGrossProfit = icShipments.reduce((sum, s) => sum + (s.grossProfit || 0), 0);

        // Count unique IC drivers (some carriers have multiple drivers)
        const uniqueDrivers = new Set();
        icShipments.forEach(s => {
          if (s.driver && s.driver !== 'Unassigned') {
            uniqueDrivers.add(s.driver);
          }
        });

        return {
          totalRevenue,
          totalGrossProfit,
          totalCost: totalRevenue - totalGrossProfit,
          avgGrossMargin: totalRevenue > 0 ? (totalGrossProfit / totalRevenue) * 100 : 0,
          loadCount: icShipments.length,
          carriers,
          driverCount: uniqueDrivers.size,
        };
      }, [shipments]);

      // ============================================
      // COMPUTED: Flagged loads (missing cost data)
      // Flag loads with high margin AND significant revenue
      // These likely have missing driver pay or carrier cost
      // ============================================
      const flaggedLoads = useMemo(() => {
        return shipments.filter(s => {
          if (!s.revenue || s.revenue <= CONSTANTS.FLAGGED_REVENUE_THRESHOLD) return false;
          // For IC loads, use grossMargin field
          // For company loads, if grossProfit equals revenue, margin is 100%
          const margin = s.grossMargin || (s.revenue > 0 ? (s.grossProfit / s.revenue) * 100 : 0);
          return margin >= CONSTANTS.FLAGGED_MARGIN_THRESHOLD;
        }).map(s => ({
          orderId: s.orderId,
          type: s.isIC ? 'IC' : 'Company',
          truckOrCarrier: s.isIC ? s.carrier : s.truck,
          driver: s.driver || '‚Äî',
          revenue: s.revenue,
          grossProfit: s.grossProfit,
          margin: s.grossMargin || (s.revenue > 0 ? (s.grossProfit / s.revenue) * 100 : 0),
          status: s.status,
          customer: s.customer,
        }));
      }, [shipments]);

      // State for expanding/collapsing flagged loads
      const [showFlaggedLoads, setShowFlaggedLoads] = useState(false);

      // ============================================
      // COMPUTED: Fleet status counts
      // ============================================
      const fleetCounts = useMemo(() => {
        const counts = {};
        statusOptions.forEach(s => counts[s] = 0);
        counts['Unknown'] = 0;

        fleet.forEach(t => {
          const status = truckStatus[t.id] || 'Unknown';
          if (counts[status] !== undefined) counts[status]++;
          else counts['Unknown']++;
        });

        return counts;
      }, [fleet, truckStatus]);

      // ============================================
      // STATUS HELPERS
      // ============================================
      const showStatus = useCallback((msg, duration = 2000) => {
        // Clear any existing timeout to prevent memory leaks
        if (statusTimeoutRef.current) {
          clearTimeout(statusTimeoutRef.current);
          statusTimeoutRef.current = null;
        }
        setSaveStatus(msg);
        if (duration > 0) {
          statusTimeoutRef.current = setTimeout(() => {
            setSaveStatus('');
            statusTimeoutRef.current = null;
          }, duration);
        }
      }, []);

      // Cleanup timeout on unmount
      useEffect(() => {
        return () => {
          if (statusTimeoutRef.current) {
            clearTimeout(statusTimeoutRef.current);
          }
        };
      }, []);

      // ============================================
      // TRUCK REMOVAL WITH CONFIRMATION
      // ============================================
      const requestRemoveTruck = useCallback((index, truckId) => {
        setConfirmModal({ isOpen: true, truckIndex: index, truckId });
      }, []);

      const confirmRemoveTruck = useCallback(() => {
        if (confirmModal.truckIndex !== null) {
          setFleet(prev => prev.filter((_, i) => i !== confirmModal.truckIndex));
          showStatus(`Truck ${confirmModal.truckId || 'removed'} removed`, 2000);
        }
        setConfirmModal({ isOpen: false, truckIndex: null, truckId: '' });
      }, [confirmModal, showStatus]);

      const cancelRemoveTruck = useCallback(() => {
        setConfirmModal({ isOpen: false, truckIndex: null, truckId: '' });
      }, []);

      // ============================================
      // CSV UPLOAD - Handles split orders
      // ============================================
      const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showStatus('Processing file...', 0);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: async (results) => {
            const parsed = [];
            let splitCount = 0;

            results.data.forEach(row => {
              // Skip summary/total rows (TORO exports include a Total row at the bottom)
              if (row['Group'] === 'Total' || !row['Order #']) return;

              const carrierRaw = row['Carrier'] || '';
              const driverRaw = row['Driver'] || '';
              const truckRaw = row['Truck']?.toString() || '';

              const carriers = carrierRaw.split(',').map(s => s.trim()).filter(Boolean);
              const drivers = driverRaw.split(',').map(s => s.trim()).filter(Boolean);
              const trucks = truckRaw.split(',').map(s => s.trim()).filter(Boolean);

              const numLegs = Math.max(carriers.length, trucks.length, 1);

              const totalRevenue = parseFloat(row['Revenue']?.replace(/[$,]/g, '')) || 0;
              const totalMilesVal = parseFloat(row['Total Miles']?.replace(/[, mi]/g, '')) || 0;
              const loadedMilesVal = parseFloat(row['Loaded Miles']?.replace(/[, mi]/g, '')) || 0;
              const grossProfitVal = parseFloat(row['Gross Profit']?.replace(/[$,]/g, '')) || 0;

              if (numLegs === 1) {
                const carrierVal = carriers[0] || '';
                const driver = drivers[0] || '';
                const truckVal = trucks[0] || '';
                const carrier = carrierVal === 'Unassigned' ? '' : carrierVal;
                const truck = normalizeTruckId(truckVal);
                const isIC = carrier && !truck;

                parsed.push({
                  orderId: row['Order #'],
                  carrier, truck, driver,
                  status: row['Status'],
                  revenue: totalRevenue, totalMiles: totalMilesVal,
                  loadedMiles: loadedMilesVal, grossProfit: grossProfitVal,
                  grossMargin: parseFloat(row['Gross Profit Margin']) || 0,
                  pickupDate: row['Sch. Pickup Date'],
                  customer: row['Customer'],
                  isIC, splitOrder: false,
                });
              } else {
                splitCount++;
                const perLeg = {
                  revenue: totalRevenue / numLegs,
                  miles: totalMilesVal / numLegs,
                  loadedMiles: loadedMilesVal / numLegs,
                  grossProfit: grossProfitVal / numLegs,
                };

                for (let i = 0; i < numLegs; i++) {
                  const carrierVal = carriers[i] || carriers[0] || '';
                  const driver = drivers[i] || drivers[0] || '';
                  const truckVal = trucks[i] || '';
                  const carrier = carrierVal === 'Unassigned' ? '' : carrierVal;
                  const truck = normalizeTruckId(truckVal);
                  const isIC = carrier && !truck;

                  parsed.push({
                    orderId: `${row['Order #']}-L${i + 1}`,
                    originalOrderId: row['Order #'],
                    carrier, truck, driver,
                    status: row['Status'],
                    revenue: perLeg.revenue, totalMiles: perLeg.miles,
                    loadedMiles: perLeg.loadedMiles, grossProfit: perLeg.grossProfit,
                    grossMargin: parseFloat(row['Gross Profit Margin']) || 0,
                    pickupDate: row['Sch. Pickup Date'],
                    customer: row['Customer'],
                    isIC, splitOrder: true, legNumber: i + 1, totalLegs: numLegs,
                  });
                }
              }
            });

            // Exclude Pending and Canceled loads - include all other statuses
            const excludedStatuses = ['Pending', 'Canceled'];
            const filtered = parsed.filter(s => !excludedStatuses.includes(s.status));
            setShipments(filtered);

            const msg = splitCount > 0
              ? `${filtered.length} shipments loaded (${splitCount} split orders)`
              : `${filtered.length} shipments loaded`;
            showStatus(msg + ' ‚úì', 3000);
          }
        });

        event.target.value = '';
      };

      // ============================================
      // SAVE & LOG - Single button for Status page
      // ============================================
      const saveAndLog = useCallback(async () => {
        setSyncing(true);
        showStatus('Saving everything...', 0);

        // Build truck entries for log
        const truckEntries = fleet.map(truck => {
          const tm = truckMetrics[truck.id] || { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0 };
          const tg = truckGoals[truck.id] || { revenueGoal: 0, milesGoal: 0 };
          return {
            truckId: truck.id, type: truck.type, driver: truck.driver,
            status: truckStatus[truck.id] || 'Unknown',
            expectedReturn: truckExpectedReturn[truck.id] || '',
            notes: truck.notes || '',
            revenue: tm.revenue, miles: tm.totalMiles, loadedMiles: tm.loadedMiles, loads: tm.loads,
            revenueGoal: tg.revenueGoal, milesGoal: tg.milesGoal,
          };
        });

        const icEntries = icMetrics.carriers.map(ic => ({
          carrier: ic.carrier, revenue: ic.revenue, cost: ic.cost,
          grossProfit: ic.grossProfit, grossMargin: ic.grossMargin, loads: ic.loads,
        }));

        // Get IC driver list for this snapshot
        const icDriverList = [...new Set(shipments.filter(s => s.isIC && s.driver).map(s => s.driver))];

        const logEntry = {
          date: reportDate,
          timestamp: new Date().toISOString(),
          trucks: truckEntries,
          ics: icEntries,
          summary: {
            // Fleet status
            active: fleetCounts['Active'] || 0,
            routine: fleetCounts['Shop - Routine'] || 0,
            breakfix: fleetCounts['Shop - Break/Fix'] || 0,
            nodriver: fleetCounts['Needs Driver'] || 0,
            spare: fleetCounts['Spare'] || 0,
            // Company metrics
            companyRevenue: companyMetrics.totalRevenue,
            companyMiles: companyMetrics.totalMiles,
            companyLoadedMiles: companyMetrics.loadedMiles,
            companyLoads: companyMetrics.loadCount,
            companyUtilization: companyMetrics.utilization,
            companyRevPerMile: companyMetrics.revPerTotalMile,
            // IC metrics
            icRevenue: icMetrics.totalRevenue,
            icCost: icMetrics.totalCost,
            icGrossProfit: icMetrics.totalGrossProfit,
            icGrossMargin: icMetrics.avgGrossMargin,
            icLoads: icMetrics.loadCount,
            icCarrierCount: icMetrics.carriers.length,
            icDriverCount: icMetrics.driverCount,
            icDrivers: icDriverList,
            // Combined totals
            totalRevenue: companyMetrics.totalRevenue + icMetrics.totalRevenue,
            // Goals & pacing
            revenueGoal: totalGoals.revenue,
            milesGoal: totalGoals.miles,
            icGMGoal: totalGoals.icGrossMargin,
            totalRevenueGoal: totalGoals.totalRevenue,
            workdaysPassed: workdaysCalc.elapsed,
            workdaysTotal: workdaysCalc.total,
            percentThroughMonth: workdaysCalc.percent,
            // Flagged loads
            flaggedLoadCount: flaggedLoads.length,
            flaggedLoadRevenue: flaggedLoads.reduce((sum, l) => sum + l.revenue, 0),
          },
        };

        // Update or add log entry
        const existingIndex = dailyLogs.findIndex(l => l.date === reportDate);
        let newLogs;
        if (existingIndex >= 0) {
          newLogs = [...dailyLogs];
          newLogs[existingIndex] = logEntry;
        } else {
          newLogs = [...dailyLogs, logEntry].sort((a, b) => a.date.localeCompare(b.date));
        }
        setDailyLogs(newLogs);

        // Save all data
        const statusData = { status: truckStatus, expectedReturn: truckExpectedReturn };

        await Promise.all([
          SheetsDB.write('Fleet', fleet, reportDate),
          SheetsDB.write('TruckStatus', statusData, reportDate),
          SheetsDB.write('Shipments', shipments, reportDate),
          SheetsDB.write('DailyLogs', newLogs, reportDate),
          SheetsDB.write('MonthlyPlan', monthlyPlan, reportDate),
        ]);

        const connected = await SheetsDB.checkConnection();
        setConnectionStatus(connected ? 'connected' : 'offline');
        showStatus(connected ? `Saved & logged ${reportDate} ‚úì` : 'Saved locally ‚ö†', 3000);
        setSyncing(false);
      }, [fleet, truckStatus, truckExpectedReturn, shipments, dailyLogs, reportDate, truckMetrics, truckGoals, icMetrics, fleetCounts, companyMetrics, totalGoals, monthlyPlan, workdaysCalc, flaggedLoads]);

      // ============================================
      // SAVE GOALS
      // ============================================
      const saveGoals = useCallback(async () => {
        setSyncing(true);
        showStatus('Saving goals...');
        await SheetsDB.write('Goals', goals);
        await SheetsDB.write('MonthlyPlan', monthlyPlan, reportDate);
        showStatus('Goals saved ‚úì');
        setSyncing(false);
      }, [goals, monthlyPlan, reportDate]);

      // ============================================
      // COPY DASHBOARD TO CLIPBOARD
      // ============================================
      const copyDashboardToClipboard = async () => {
        if (!dashboardRef.current) return;
        showStatus('Capturing dashboard...', 0);

        try {
          const canvas = await html2canvas(dashboardRef.current, {
            backgroundColor: '#f3f4f6',
            scale: 2,
          });

          canvas.toBlob(async (blob) => {
            try {
              await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
              ]);
              showStatus('Dashboard copied to clipboard! ‚úì', 3000);
            } catch (err) {
              // Fallback: open in new tab
              const url = canvas.toDataURL();
              window.open(url, '_blank');
              showStatus('Opened in new tab (clipboard not available)', 3000);
            }
          });
        } catch (err) {
          showStatus('Failed to capture: ' + err.message, 3000);
        }
      };

      // ============================================
      // EXPORT/IMPORT
      // ============================================
      const exportData = () => {
        const data = {
          fleet, goals, monthlyPlan, dailyLogs, shipments,
          truckStatus: { status: truckStatus, expectedReturn: truckExpectedReturn },
          exportedAt: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CTL_DOR_Backup_${reportDate}.json`;
        a.click();
      };

      // ============================================
      // HELPER: Validate imported JSON data structure
      // ============================================
      const validateImportData = (data) => {
        const errors = [];

        if (typeof data !== 'object' || data === null) {
          errors.push('Data must be an object');
          return { valid: false, errors };
        }

        if (data.fleet !== undefined) {
          if (!Array.isArray(data.fleet)) {
            errors.push('fleet must be an array');
          } else {
            data.fleet.forEach((truck, i) => {
              if (typeof truck !== 'object' || truck === null) {
                errors.push(`fleet[${i}] must be an object`);
              }
            });
          }
        }

        if (data.goals !== undefined && (typeof data.goals !== 'object' || data.goals === null)) {
          errors.push('goals must be an object');
        }

        if (data.monthlyPlan !== undefined && (typeof data.monthlyPlan !== 'object' || data.monthlyPlan === null)) {
          errors.push('monthlyPlan must be an object');
        }

        if (data.dailyLogs !== undefined && !Array.isArray(data.dailyLogs)) {
          errors.push('dailyLogs must be an array');
        }

        if (data.shipments !== undefined && !Array.isArray(data.shipments)) {
          errors.push('shipments must be an array');
        }

        if (data.truckStatus !== undefined && (typeof data.truckStatus !== 'object' || data.truckStatus === null)) {
          errors.push('truckStatus must be an object');
        }

        return { valid: errors.length === 0, errors };
      };

      const importData = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            // Validate data structure before importing
            const validation = validateImportData(data);
            if (!validation.valid) {
              showStatus(`Import failed: ${validation.errors.slice(0, 3).join(', ')}`, 5000);
              return;
            }

            if (data.fleet) setFleet(data.fleet);
            if (data.goals) setGoals(prev => ({ ...prev, ...data.goals }));
            if (data.monthlyPlan) setMonthlyPlan(data.monthlyPlan);
            if (data.dailyLogs) setDailyLogs(data.dailyLogs);
            if (data.shipments) setShipments(data.shipments);
            if (data.truckStatus) {
              setTruckStatus(data.truckStatus.status || {});
              setTruckExpectedReturn(data.truckStatus.expectedReturn || {});
            }
            showStatus('Data imported ‚úì');
          } catch (err) {
            showStatus(`Import error: ${err.message}`, 5000);
          }
        };
        reader.readAsText(file);
      };

      // ============================================
      // LOADING STATE
      // ============================================
      if (loading) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-4 text-gray-600">Loading dashboard...</p>
            </div>
          </div>
        );
      }

      // ============================================
      // RENDER
      // ============================================
      return (
        <div className="min-h-screen bg-gray-100">
          {/* HEADER */}
          <header className="bg-blue-900 text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                  <h1 className="text-xl md:text-2xl font-bold">COOLMORE TRUCK LINES</h1>
                  <p className="text-blue-200 text-sm">Daily Operating Report</p>
                </div>
                <div className="flex flex-wrap items-center gap-3">
                  <div>
                    <label htmlFor="report-date" className="block text-xs text-blue-200 mb-1">Report Date</label>
                    <input id="report-date" type="date" value={reportDate} onChange={(e) => setReportDate(e.target.value)}
                      className="border-0 rounded px-3 py-1.5 text-sm font-semibold text-blue-900 bg-white" />
                  </div>
                  {saveStatus && (
                    <span className="text-sm text-green-300 bg-green-900/30 px-2 py-1 rounded">{saveStatus}</span>
                  )}
                  <div className={`text-xs px-3 py-1.5 rounded font-medium ${connectionStatus === 'connected' ? 'bg-green-600' : 'bg-yellow-600'}`}>
                    {connectionStatus === 'connected' ? '‚óè Online' : '‚óã Offline'}
                  </div>
                </div>
              </div>

              {/* TABS */}
              <nav className="flex gap-4 mt-4 border-t border-blue-800 pt-3 overflow-x-auto">
                {[
                  { id: 'dashboard', label: 'Dashboard' },
                  { id: 'trucks', label: 'Company Trucks' },
                  { id: 'ic', label: 'ICs / Carriers' },
                  { id: 'status', label: 'Status' },
                  { id: 'settings', label: 'Settings' },
                ].map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                    className={`text-sm font-medium pb-2 whitespace-nowrap ${activeTab === tab.id ? 'text-white border-b-2 border-white' : 'text-blue-300 hover:text-white'}`}>
                    {tab.label}
                  </button>
                ))}
              </nav>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-6">

            {/* ==================== DASHBOARD TAB ==================== */}
            {activeTab === 'dashboard' && (
              <div className="space-y-6">
                {/* Controls */}
                <div className="flex flex-wrap items-center gap-4">
                  <button onClick={copyDashboardToClipboard}
                    aria-label="Copy dashboard as image to clipboard"
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                    üìã Copy Dashboard
                  </button>
                  <span className="text-sm text-gray-500">
                    Day {workdaysCalc.elapsed} of {workdaysCalc.total} ({Math.round(workdaysCalc.percent * 100)}% through month)
                  </span>
                </div>

                {/* Empty state notice */}
                {shipments.length === 0 && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p className="text-blue-800 font-medium">üìä Getting Started</p>
                    <p className="text-blue-600 text-sm mt-1">
                      Upload a TORO export on the <button onClick={() => setActiveTab('status')} className="underline font-medium">Status tab</button> to populate the dashboard with real data.
                    </p>
                  </div>
                )}

                {/* Missing Cost Data Warning */}
                {flaggedLoads.length > 0 && (
                  <div className="bg-amber-50 border border-amber-300 rounded-lg p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-amber-600 text-xl">‚ö†Ô∏è</span>
                        <div>
                          <p className="text-amber-800 font-medium">
                            {flaggedLoads.length} load{flaggedLoads.length !== 1 ? 's' : ''} may be missing cost data
                          </p>
                          <p className="text-amber-600 text-sm">
                            These loads show 95%+ margin with revenue over $500. They're included in totals but may need driver/carrier pay added.
                          </p>
                        </div>
                      </div>
                      <button
                        onClick={() => setShowFlaggedLoads(!showFlaggedLoads)}
                        className="px-3 py-1 text-sm font-medium text-amber-700 bg-amber-100 hover:bg-amber-200 rounded-lg transition-colors"
                      >
                        {showFlaggedLoads ? 'Hide Details' : 'Show Details'}
                      </button>
                    </div>

                    {showFlaggedLoads && (
                      <div className="mt-4 overflow-x-auto">
                        <table className="min-w-full text-sm">
                          <thead>
                            <tr className="text-left text-amber-700 border-b border-amber-200">
                              <th className="px-3 py-2">Order #</th>
                              <th className="px-3 py-2">Type</th>
                              <th className="px-3 py-2">Truck/Carrier</th>
                              <th className="px-3 py-2">Customer</th>
                              <th className="px-3 py-2 text-right">Revenue</th>
                              <th className="px-3 py-2 text-right">Gross Profit</th>
                              <th className="px-3 py-2 text-right">Margin</th>
                              <th className="px-3 py-2">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {flaggedLoads.map((load, idx) => (
                              <tr key={load.orderId || idx} className="border-b border-amber-100 hover:bg-amber-100/50">
                                <td className="px-3 py-2 font-mono text-xs">{load.orderId}</td>
                                <td className="px-3 py-2">
                                  <span className={`px-2 py-0.5 rounded text-xs font-medium ${load.type === 'IC' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                    {load.type}
                                  </span>
                                </td>
                                <td className="px-3 py-2">{load.truckOrCarrier || '‚Äî'}</td>
                                <td className="px-3 py-2 text-gray-600">{load.customer || '‚Äî'}</td>
                                <td className="px-3 py-2 text-right font-medium">{fmtCurrency(load.revenue)}</td>
                                <td className="px-3 py-2 text-right text-green-600">{fmtCurrency(load.grossProfit)}</td>
                                <td className="px-3 py-2 text-right text-red-600 font-medium">{fmtPercent(load.margin)}</td>
                                <td className="px-3 py-2 text-gray-500">{load.status}</td>
                              </tr>
                            ))}
                          </tbody>
                          <tfoot>
                            <tr className="bg-amber-100 font-medium text-amber-800">
                              <td colSpan="4" className="px-3 py-2">Total Flagged Revenue</td>
                              <td className="px-3 py-2 text-right">{fmtCurrency(flaggedLoads.reduce((sum, l) => sum + l.revenue, 0))}</td>
                              <td className="px-3 py-2 text-right">{fmtCurrency(flaggedLoads.reduce((sum, l) => sum + l.grossProfit, 0))}</td>
                              <td colSpan="2" className="px-3 py-2"></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Dashboard Content (for screenshot) */}
                <div ref={dashboardRef} className="space-y-6 bg-gray-100 p-4 rounded-lg">
                  {/* Combined Plan Status */}
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">üìä Monthly Performance vs. Plan</h2>
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                      <div className="text-center">
                        <div className="text-sm text-gray-500">Company Revenue</div>
                        <div className={`text-2xl font-bold ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmtCurrency(companyMetrics.totalRevenue)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmtCurrency(totalGoals.revenue)} | Pace: {fmtCurrency(totalGoals.revenuePacing)}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm text-gray-500">Company Miles</div>
                        <div className={`text-2xl font-bold ${companyMetrics.totalMiles >= totalGoals.milesPacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmt(companyMetrics.totalMiles)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmt(totalGoals.miles)} | Pace: {fmt(Math.round(totalGoals.milesPacing))}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm text-gray-500">IC Gross Margin $</div>
                        <div className={`text-2xl font-bold ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmtCurrency(icMetrics.totalGrossProfit)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmtCurrency(totalGoals.icGrossMargin)} | Pace: {fmtCurrency(totalGoals.icGMPacing)}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm text-gray-500">Total Revenue</div>
                        <div className={`text-2xl font-bold ${(companyMetrics.totalRevenue + icMetrics.totalRevenue) >= totalGoals.totalRevenuePacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmtCurrency(companyMetrics.totalRevenue + icMetrics.totalRevenue)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmtCurrency(totalGoals.totalRevenue)} | Pace: {fmtCurrency(totalGoals.totalRevenuePacing)}</div>
                      </div>
                    </div>

                    {/* Progress Bars */}
                    <div className="space-y-3">
                      <div>
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                          <span>Company Revenue</span>
                          <span>{Math.round(safeDivide(companyMetrics.totalRevenue, totalGoals.revenue) * 100)}%</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'bg-green-500' : 'bg-red-500'}`}
                            style={{ width: `${Math.min(safeDivide(companyMetrics.totalRevenue, totalGoals.revenue) * 100, 100)}%` }} />
                        </div>
                      </div>
                      <div>
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                          <span>IC Gross Margin $</span>
                          <span>{Math.round(safeDivide(icMetrics.totalGrossProfit, totalGoals.icGrossMargin) * 100)}%</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'bg-green-500' : 'bg-red-500'}`}
                            style={{ width: `${Math.min(safeDivide(icMetrics.totalGrossProfit, totalGoals.icGrossMargin) * 100, 100)}%` }} />
                        </div>
                      </div>
                      <div>
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                          <span>Total Revenue</span>
                          <span>{Math.round(safeDivide(companyMetrics.totalRevenue + icMetrics.totalRevenue, totalGoals.totalRevenue) * 100)}%</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full ${(companyMetrics.totalRevenue + icMetrics.totalRevenue) >= totalGoals.totalRevenuePacing ? 'bg-green-500' : 'bg-red-500'}`}
                            style={{ width: `${Math.min(safeDivide(companyMetrics.totalRevenue + icMetrics.totalRevenue, totalGoals.totalRevenue) * 100, 100)}%` }} />
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Fleet Status */}
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">üöõ Fleet Status</h2>
                    <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-3">
                      {[
                        { key: 'Active', label: 'Active', color: 'bg-green-500' },
                        { key: 'Shop - Routine', label: 'Routine', color: 'bg-yellow-400', dark: true },
                        { key: 'Shop - Break/Fix', label: 'Break/Fix', color: 'bg-orange-500' },
                        { key: 'Needs Driver', label: 'No Driver', color: 'bg-red-500' },
                        { key: 'Spare', label: 'Spare', color: 'bg-gray-400' },
                      ].map(({ key, label, color, dark }) => (
                        <div key={key} className={`${color} rounded-lg p-3 sm:p-4 text-center`}>
                          <div className={`text-2xl sm:text-3xl font-bold ${dark ? 'text-gray-900' : 'text-white'}`}>{fleetCounts[key] || 0}</div>
                          <div className={`text-xs ${dark ? 'text-gray-700' : 'text-white/80'}`}>{label}</div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Company & IC Summary */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Company Summary */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">Company Trucks</h3>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-gray-500">Revenue:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'text-green-600' : 'text-red-600'}`}>
                            {fmtCurrency(companyMetrics.totalRevenue)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Loads:</span>
                          <span className="ml-2 font-semibold">{companyMetrics.loadCount}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">$/Total Mi:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.revPerTotalMile >= goals.targetRevPerTotalMile ? 'text-green-600' : 'text-red-600'}`}>
                            ${fmtDecimal(companyMetrics.revPerTotalMile)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">$/Loaded Mi:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.revPerLoadedMile >= goals.targetRevPerLoadedMile ? 'text-green-600' : 'text-red-600'}`}>
                            ${fmtDecimal(companyMetrics.revPerLoadedMile)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Utilization:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.utilization >= goals.targetUtilization ? 'text-green-600' : 'text-red-600'}`}>
                            {Math.round(companyMetrics.utilization * 100)}%
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Trucks in Plan:</span>
                          <span className="ml-2 font-semibold">{totalGoals.trucksIncluded}</span>
                        </div>
                      </div>
                    </div>

                    {/* IC Summary */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">Independent Contractors</h3>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-gray-500">Revenue:</span>
                          <span className="ml-2 font-semibold">{fmtCurrency(icMetrics.totalRevenue)}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">Loads:</span>
                          <span className="ml-2 font-semibold">{icMetrics.loadCount}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">Gross Margin $:</span>
                          <span className={`ml-2 font-semibold ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'text-green-600' : 'text-red-600'}`}>
                            {fmtCurrency(icMetrics.totalGrossProfit)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">GM %:</span>
                          <span className={`ml-2 font-semibold ${icMetrics.avgGrossMargin >= goals.targetICGrossMarginPct ? 'text-green-600' : 'text-red-600'}`}>
                            {fmtPercent(icMetrics.avgGrossMargin)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Carriers:</span>
                          <span className="ml-2 font-semibold">{icMetrics.carriers.length}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">Drivers:</span>
                          <span className="ml-2 font-semibold">{icMetrics.driverCount}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ==================== COMPANY TRUCKS TAB ==================== */}
            {activeTab === 'trucks' && (
              <div className="space-y-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <h2 className="text-lg font-semibold text-gray-800">Company Truck Performance</h2>
                  <p className="text-sm text-gray-500">Per-truck metrics vs. individual goals. Color coding: üü¢ on/above goal, üü° within 10%, üî¥ below goal.</p>
                </div>

                {shipments.length === 0 && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <p className="text-yellow-800 font-medium">No shipment data loaded</p>
                    <p className="text-yellow-600 text-sm mt-1">Upload a TORO export on the Status tab to see truck performance metrics.</p>
                  </div>
                )}

                <div className="bg-white rounded-lg shadow-sm overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-blue-900 text-white">
                      <tr>
                        <th className="px-3 py-3 text-left">Truck</th>
                        <th className="px-3 py-3 text-left">Type</th>
                        <th className="px-3 py-3 text-left">Status</th>
                        <th className="px-3 py-3 text-right">Revenue</th>
                        <th className="px-3 py-3 text-right">Goal</th>
                        <th className="px-3 py-3 text-right">Miles</th>
                        <th className="px-3 py-3 text-right">Goal</th>
                        <th className="px-3 py-3 text-right">$/Tot Mi</th>
                        <th className="px-3 py-3 text-right">$/Ld Mi</th>
                        <th className="px-3 py-3 text-right">Util</th>
                        <th className="px-3 py-3 text-right">Loads</th>
                      </tr>
                    </thead>
                    <tbody>
                      {fleet.map((truck, idx) => {
                        const tm = truckMetrics[truck.id] || { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0, revPerTotalMile: 0, revPerLoadedMile: 0, utilization: 0 };
                        const tg = truckGoals[truck.id] || { included: false, revenueGoal: 0, milesGoal: 0 };
                        const status = truckStatus[truck.id] || '';
                        const pacedRevGoal = tg.revenueGoal * workdaysCalc.percent;
                        const pacedMiGoal = tg.milesGoal * workdaysCalc.percent;

                        if (!tg.included) {
                          // Still show metrics if this truck has revenue (e.g., assigned loads)
                          const hasActivity = tm.revenue > 0 || tm.loads > 0;
                          return (
                            <tr key={truck.id} className="bg-gray-100 text-gray-400">
                              <td className="px-3 py-2 font-semibold">{truck.id}</td>
                              <td className="px-3 py-2">{truck.type || 'TBD'}</td>
                              <td className="px-3 py-2">{status || 'Spare'}</td>
                              {hasActivity ? (
                                <>
                                  <td className="px-3 py-2 text-right font-semibold text-gray-500">{fmtCurrency(tm.revenue)}</td>
                                  <td className="px-3 py-2 text-right text-xs italic">no goal</td>
                                  <td className="px-3 py-2 text-right font-semibold text-gray-500">{fmt(tm.totalMiles)}</td>
                                  <td className="px-3 py-2 text-right text-xs italic">no goal</td>
                                  <td className="px-3 py-2 text-right text-gray-500">${fmtDecimal(tm.revPerTotalMile)}</td>
                                  <td className="px-3 py-2 text-right text-gray-500">${fmtDecimal(tm.revPerLoadedMile)}</td>
                                  <td className="px-3 py-2 text-right text-gray-500">{Math.round(tm.utilization * 100)}%</td>
                                  <td className="px-3 py-2 text-right text-gray-500">{tm.loads}</td>
                                </>
                              ) : (
                                <td colSpan="8" className="px-3 py-2 text-center italic">Not in plan</td>
                              )}
                            </tr>
                          );
                        }

                        return (
                          <tr key={truck.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-3 py-2 font-semibold">{truck.id}</td>
                            <td className="px-3 py-2 text-gray-600">{truck.type || 'TBD'}</td>
                            <td className="px-3 py-2">
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${getStatusClass(status)}`}>{status || '‚Äî'}</span>
                            </td>
                            <td className={`px-3 py-2 text-right font-semibold ${getColorClass(tm.revenue, pacedRevGoal)}`}>
                              {fmtCurrency(tm.revenue)}
                            </td>
                            <td className="px-3 py-2 text-right text-gray-400 text-xs">{fmtCurrency(tg.revenueGoal)}</td>
                            <td className={`px-3 py-2 text-right font-semibold ${getColorClass(tm.totalMiles, pacedMiGoal)}`}>
                              {fmt(tm.totalMiles)}
                            </td>
                            <td className="px-3 py-2 text-right text-gray-400 text-xs">{fmt(tg.milesGoal)}</td>
                            <td className={`px-3 py-2 text-right ${getColorClass(tm.revPerTotalMile, goals.targetRevPerTotalMile)}`}>
                              ${fmtDecimal(tm.revPerTotalMile)}
                            </td>
                            <td className={`px-3 py-2 text-right ${getColorClass(tm.revPerLoadedMile, goals.targetRevPerLoadedMile)}`}>
                              ${fmtDecimal(tm.revPerLoadedMile)}
                            </td>
                            <td className={`px-3 py-2 text-right ${getColorClass(tm.utilization, goals.targetUtilization)}`}>
                              {Math.round(tm.utilization * 100)}%
                            </td>
                            <td className="px-3 py-2 text-right">{tm.loads}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                    <tfoot className="bg-blue-900 text-white font-semibold">
                      <tr>
                        <td className="px-3 py-3" colSpan="3">TOTAL ({totalGoals.trucksIncluded} trucks)</td>
                        <td className={`px-3 py-3 text-right ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'text-green-300' : 'text-red-300'}`}>
                          {fmtCurrency(companyMetrics.totalRevenue)}
                        </td>
                        <td className="px-3 py-3 text-right text-blue-300">{fmtCurrency(totalGoals.revenue)}</td>
                        <td className={`px-3 py-3 text-right ${companyMetrics.totalMiles >= totalGoals.milesPacing ? 'text-green-300' : 'text-red-300'}`}>
                          {fmt(companyMetrics.totalMiles)}
                        </td>
                        <td className="px-3 py-3 text-right text-blue-300">{fmt(totalGoals.miles)}</td>
                        <td className={`px-3 py-3 text-right ${companyMetrics.revPerTotalMile >= goals.targetRevPerTotalMile ? 'text-green-300' : 'text-red-300'}`}>
                          ${fmtDecimal(companyMetrics.revPerTotalMile)}
                        </td>
                        <td className={`px-3 py-3 text-right ${companyMetrics.revPerLoadedMile >= goals.targetRevPerLoadedMile ? 'text-green-300' : 'text-red-300'}`}>
                          ${fmtDecimal(companyMetrics.revPerLoadedMile)}
                        </td>
                        <td className={`px-3 py-3 text-right ${companyMetrics.utilization >= goals.targetUtilization ? 'text-green-300' : 'text-red-300'}`}>
                          {Math.round(companyMetrics.utilization * 100)}%
                        </td>
                        <td className="px-3 py-3 text-right">{companyMetrics.loadCount}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div className="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
                  <strong>Floors:</strong> $/Total Mile ‚â• ${fmtDecimal(goals.targetRevPerTotalMile)} | $/Loaded Mile ‚â• ${fmtDecimal(goals.targetRevPerLoadedMile)} | Utilization ‚â• {Math.round(goals.targetUtilization * 100)}%
                </div>
              </div>
            )}

            {/* ==================== ICs / CARRIERS TAB ==================== */}
            {activeTab === 'ic' && (
              <div className="space-y-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <h2 className="text-lg font-semibold text-gray-800">Independent Contractors / Carriers</h2>
                  <p className="text-sm text-gray-500">Brokerage performance. GM% floor: {goals.targetICGrossMarginPct}%</p>
                </div>

                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className="text-xl sm:text-2xl font-bold text-gray-900">{fmtCurrency(icMetrics.totalRevenue)}</div>
                    <div className="text-xs text-gray-500">Revenue</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className="text-xl sm:text-2xl font-bold text-red-600">{fmtCurrency(icMetrics.totalCost)}</div>
                    <div className="text-xs text-gray-500">Carrier Cost</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className={`text-xl sm:text-2xl font-bold ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'text-green-600' : 'text-red-600'}`}>
                      {fmtCurrency(icMetrics.totalGrossProfit)}
                    </div>
                    <div className="text-xs text-gray-500">GM $ (Goal: {fmtCurrency(totalGoals.icGrossMargin)})</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className={`text-xl sm:text-2xl font-bold ${icMetrics.avgGrossMargin >= goals.targetICGrossMarginPct ? 'text-green-600' : 'text-red-600'}`}>
                      {fmtPercent(icMetrics.avgGrossMargin)}
                    </div>
                    <div className="text-xs text-gray-500">GM % (Floor: {goals.targetICGrossMarginPct}%)</div>
                  </div>
                </div>

                {icMetrics.carriers.length > 0 ? (
                  <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-blue-900 text-white">
                        <tr>
                          <th className="px-4 py-3 text-left">Carrier</th>
                          <th className="px-4 py-3 text-right">Revenue</th>
                          <th className="px-4 py-3 text-right">Cost</th>
                          <th className="px-4 py-3 text-right">GM $</th>
                          <th className="px-4 py-3 text-right">GM %</th>
                          <th className="px-4 py-3 text-right">Loads</th>
                        </tr>
                      </thead>
                      <tbody>
                        {icMetrics.carriers.map((c, idx) => (
                          <tr key={c.carrier || idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-4 py-3 font-medium">{c.carrier}</td>
                            <td className="px-4 py-3 text-right">{fmtCurrency(c.revenue)}</td>
                            <td className="px-4 py-3 text-right text-red-600">{fmtCurrency(c.cost)}</td>
                            <td className="px-4 py-3 text-right text-green-600 font-medium">{fmtCurrency(c.grossProfit)}</td>
                            <td className={`px-4 py-3 text-right font-medium ${c.grossMargin >= goals.targetICGrossMarginPct ? 'text-green-600' : 'text-red-600'}`}>
                              {fmtPercent(c.grossMargin)}
                            </td>
                            <td className="px-4 py-3 text-right">{c.loads}</td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot className="bg-blue-900 text-white font-semibold">
                        <tr>
                          <td className="px-4 py-3">TOTAL ({icMetrics.carriers.length} carriers)</td>
                          <td className="px-4 py-3 text-right">{fmtCurrency(icMetrics.totalRevenue)}</td>
                          <td className="px-4 py-3 text-right text-red-300">{fmtCurrency(icMetrics.totalCost)}</td>
                          <td className="px-4 py-3 text-right text-green-300">{fmtCurrency(icMetrics.totalGrossProfit)}</td>
                          <td className={`px-4 py-3 text-right ${icMetrics.avgGrossMargin >= goals.targetICGrossMarginPct ? 'text-green-300' : 'text-red-300'}`}>
                            {fmtPercent(icMetrics.avgGrossMargin)}
                          </td>
                          <td className="px-4 py-3 text-right">{icMetrics.loadCount}</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                ) : (
                  <div className="bg-white rounded-lg shadow-sm p-8 text-center text-gray-500">
                    No IC loads found for this month. Upload TORO data on the Status page.
                  </div>
                )}
              </div>
            )}

            {/* ==================== STATUS TAB ==================== */}
            {activeTab === 'status' && (
              <div className="space-y-4">
                <div className="bg-white rounded-lg shadow-sm p-4 flex flex-wrap justify-between items-center gap-3">
                  <div>
                    <h2 className="text-lg font-semibold text-gray-800">Daily Status Update</h2>
                    <p className="text-sm text-gray-500">Upload TORO data, update truck status, then save.</p>
                  </div>
                  <button onClick={saveAndLog} disabled={syncing}
                    className="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                    {syncing ? '‚è≥ Saving...' : 'üíæ Save & Log'}
                  </button>
                </div>

                {/* TORO Upload */}
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex items-center gap-4">
                    <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 text-sm font-medium">
                      üì§ Upload TORO Export
                      <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                    </label>
                    {shipments.length > 0 && (
                      <span className="text-sm text-green-600">‚úì {shipments.length} shipments loaded</span>
                    )}
                  </div>
                </div>

                {/* Truck Status Table */}
                <div className="bg-white rounded-lg shadow-sm overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-800 text-white">
                      <tr>
                        <th className="px-3 py-3 text-left">Truck #</th>
                        <th className="px-3 py-3 text-left">Type</th>
                        <th className="px-3 py-3 text-left">Driver</th>
                        <th className="px-3 py-3 text-left">Status</th>
                        <th className="px-3 py-3 text-left">Exp. Return</th>
                        <th className="px-3 py-3 text-left">Notes</th>
                        <th className="px-3 py-3 text-center">Remove</th>
                      </tr>
                    </thead>
                    <tbody>
                      {fleet.map((truck, idx) => {
                        const status = truckStatus[truck.id] || '';
                        const showExpReturn = status && !['Active', 'Spare', ''].includes(status);

                        return (
                          <tr key={truck.id || idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-3 py-2">
                              <input type="text" value={truck.id}
                                onChange={(e) => updateFleetField(idx, 'id', e.target.value)}
                                className="w-20 border rounded px-2 py-1 font-semibold" />
                            </td>
                            <td className="px-3 py-2">
                              <select value={truck.type}
                                onChange={(e) => updateFleetField(idx, 'type', e.target.value)}
                                className="w-full border rounded px-2 py-1">
                                <option value="">TBD</option>
                                {truckTypes.map(t => <option key={t} value={t}>{t}</option>)}
                              </select>
                            </td>
                            <td className="px-3 py-2">
                              <input type="text" value={truck.driver}
                                onChange={(e) => updateFleetField(idx, 'driver', e.target.value)}
                                className="w-full border rounded px-2 py-1" placeholder="Driver name" />
                            </td>
                            <td className="px-3 py-2">
                              <select value={status}
                                onChange={(e) => setTruckStatus({ ...truckStatus, [truck.id]: e.target.value })}
                                className={`w-full px-2 py-1 rounded text-sm font-medium border-0 ${getStatusClass(status)}`}>
                                <option value="">Select...</option>
                                {statusOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                              </select>
                            </td>
                            <td className="px-3 py-2">
                              {showExpReturn ? (
                                <input type="date" value={truckExpectedReturn[truck.id] || ''}
                                  onChange={(e) => setTruckExpectedReturn({ ...truckExpectedReturn, [truck.id]: e.target.value })}
                                  className="w-full px-2 py-1 border rounded text-sm" />
                              ) : (
                                <span className="text-gray-300">‚Äî</span>
                              )}
                            </td>
                            <td className="px-3 py-2">
                              <input type="text" value={truck.notes || ''}
                                onChange={(e) => updateFleetField(idx, 'notes', e.target.value)}
                                className="w-full border rounded px-2 py-1" placeholder="Notes..." />
                            </td>
                            <td className="px-3 py-2 text-center">
                              <button onClick={() => requestRemoveTruck(idx, truck.id)}
                                className="text-red-500 hover:text-red-700 font-bold"
                                title="Remove truck"
                                aria-label={`Remove truck ${truck.id || 'at row ' + (idx + 1)}`}>‚úï</button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>

                <button onClick={() => setFleet([...fleet, { id: '', type: '', driver: '', notes: '' }])}
                  className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                  + Add Truck
                </button>
              </div>
            )}

            {/* ==================== SETTINGS TAB ==================== */}
            {activeTab === 'settings' && (
              <div className="space-y-6">
                {/* Global Goals */}
                <div className="bg-white rounded-lg shadow-sm p-6">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-lg font-semibold text-gray-800">Goals & Targets</h2>
                    <button onClick={saveGoals} disabled={syncing}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50">
                      üíæ Save Goals
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Workdays in Month</label>
                      <input type="number" min="1" max="31" value={goals.workdaysInMonth}
                        onChange={(e) => setGoals({ ...goals, workdaysInMonth: validateGoalInput(e.target.value, 1, 31, 22) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Daily Revenue / Truck ($)</label>
                      <input type="number" min="1" value={goals.dailyRevenuePerTruck}
                        onChange={(e) => setGoals({ ...goals, dailyRevenuePerTruck: validateGoalInput(e.target.value, 1, null, 940) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Daily Miles / Truck</label>
                      <input type="number" min="1" value={goals.dailyMilesPerTruck}
                        onChange={(e) => setGoals({ ...goals, dailyMilesPerTruck: validateGoalInput(e.target.value, 1, null, 412) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Floor: $/Total Mile</label>
                      <input type="number" step="0.01" min="0.01" value={goals.targetRevPerTotalMile}
                        onChange={(e) => setGoals({ ...goals, targetRevPerTotalMile: validateGoalInput(e.target.value, 0.01, null, 2.28) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Floor: $/Loaded Mile</label>
                      <input type="number" step="0.01" min="0.01" value={goals.targetRevPerLoadedMile}
                        onChange={(e) => setGoals({ ...goals, targetRevPerLoadedMile: validateGoalInput(e.target.value, 0.01, null, 2.75) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Floor: Utilization (%)</label>
                      <input type="number" min="1" max="100" value={Math.round(goals.targetUtilization * 100)}
                        onChange={(e) => setGoals({ ...goals, targetUtilization: validateGoalInput(e.target.value, 1, 100, 85) / 100 })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                  </div>

                  <h3 className="text-md font-semibold text-purple-800 mt-6 mb-3">IC / Carrier Goals</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">Daily IC Gross Margin $ Target</label>
                      <input type="number" min="0" value={goals.dailyICGrossMargin}
                        onChange={(e) => setGoals({ ...goals, dailyICGrossMargin: validateGoalInput(e.target.value, 0, null, 150) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">IC Gross Margin % Floor</label>
                      <input type="number" step="0.1" min="0" max="100" value={goals.targetICGrossMarginPct}
                        onChange={(e) => setGoals({ ...goals, targetICGrossMarginPct: validateGoalInput(e.target.value, 0, 100, 15) })}
                        className="w-full border rounded px-3 py-2" />
                    </div>
                  </div>

                  <div className="mt-4 p-3 bg-gray-100 rounded text-sm space-y-1">
                    <div><strong>Company:</strong> {totalGoals.trucksIncluded} trucks ‚Üí {fmtCurrency(totalGoals.revenue)}/month revenue, {fmt(totalGoals.miles)} miles</div>
                    <div><strong>IC:</strong> ${goals.dailyICGrossMargin}/day √ó {goals.workdaysInMonth} days = {fmtCurrency(totalGoals.icGrossMargin)} GM$/month</div>
                  </div>
                </div>

                {/* Monthly Plan */}
                <div className="bg-white rounded-lg shadow-sm p-6">
                  <h2 className="text-lg font-semibold text-gray-800 mb-4">Monthly Truck Plan ({reportMonth})</h2>
                  <p className="text-sm text-gray-500 mb-4">Include/exclude trucks and set pro-rated dates for this month.</p>

                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-3 py-2 text-left">Truck</th>
                          <th className="px-3 py-2 text-left">Type</th>
                          <th className="px-3 py-2 text-center">In Plan</th>
                          <th className="px-3 py-2 text-left">Start Date</th>
                          <th className="px-3 py-2 text-left">End Date</th>
                          <th className="px-3 py-2 text-right">Daily Rev</th>
                          <th className="px-3 py-2 text-right">Daily Mi</th>
                          <th className="px-3 py-2 text-right">Month Goal</th>
                        </tr>
                      </thead>
                      <tbody>
                        {fleet.map((truck, idx) => {
                          const plan = getTruckPlan(truck.id);
                          const tg = truckGoals[truck.id];

                          return (
                            <tr key={truck.id || idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className="px-3 py-2 font-semibold">{truck.id}</td>
                              <td className="px-3 py-2 text-gray-600">{truck.type || 'TBD'}</td>
                              <td className="px-3 py-2 text-center">
                                <input type="checkbox" checked={plan.included}
                                  onChange={(e) => setTruckPlan(truck.id, { included: e.target.checked })}
                                  className="w-4 h-4" />
                              </td>
                              <td className="px-3 py-2">
                                {plan.included && (
                                  <input type="date" value={plan.startDate || `${reportMonth}-01`}
                                    onChange={(e) => setTruckPlan(truck.id, { startDate: e.target.value })}
                                    className="border rounded px-2 py-1 text-sm" />
                                )}
                              </td>
                              <td className="px-3 py-2">
                                {plan.included && (
                                  <input type="date" value={plan.endDate || ''}
                                    onChange={(e) => setTruckPlan(truck.id, { endDate: e.target.value || null })}
                                    className="border rounded px-2 py-1 text-sm" placeholder="End of month" />
                                )}
                              </td>
                              <td className="px-3 py-2 text-right">
                                {plan.included ? (
                                  <input type="number" value={plan.dailyRevenue || goals.dailyRevenuePerTruck}
                                    onChange={(e) => setTruckPlan(truck.id, { dailyRevenue: parseInt(e.target.value) })}
                                    className="w-20 border rounded px-2 py-1 text-sm text-right" />
                                ) : '‚Äî'}
                              </td>
                              <td className="px-3 py-2 text-right">
                                {plan.included ? (
                                  <input type="number" value={plan.dailyMiles || goals.dailyMilesPerTruck}
                                    onChange={(e) => setTruckPlan(truck.id, { dailyMiles: parseInt(e.target.value) })}
                                    className="w-20 border rounded px-2 py-1 text-sm text-right" />
                                ) : '‚Äî'}
                              </td>
                              <td className="px-3 py-2 text-right font-medium">
                                {tg?.included ? fmtCurrency(tg.revenueGoal) : '‚Äî'}
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                      <tfoot className="bg-gray-100 font-semibold">
                        <tr>
                          <td className="px-3 py-2" colSpan="7">TOTAL</td>
                          <td className="px-3 py-2 text-right">{fmtCurrency(totalGoals.revenue)}</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                {/* Data Management */}
                <div className="bg-white rounded-lg shadow-sm p-6">
                  <h2 className="text-lg font-semibold text-gray-800 mb-4">Data Management</h2>
                  <div className="flex flex-wrap gap-3">
                    <button onClick={exportData}
                      className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                      üì• Export All Data
                    </button>
                    <label className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 cursor-pointer">
                      üì§ Import Data
                      <input type="file" accept=".json" onChange={importData} className="hidden" />
                    </label>
                    <button onClick={() => {
                      if (confirm('This will clear all cached data and reset the fleet to defaults. Are you sure?')) {
                        localStorage.clear();
                        window.location.reload();
                      }
                    }}
                      className="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200">
                      üóëÔ∏è Clear Cache & Reset
                    </button>
                  </div>
                </div>
              </div>
            )}

          </main>

          <footer className="text-center text-xs text-gray-400 py-6">
            Coolmore Truck Lines ¬© 2026
          </footer>

          {/* Confirmation Modal */}
          <ConfirmModal
            isOpen={confirmModal.isOpen}
            title="Remove Truck"
            message={`Are you sure you want to remove truck ${confirmModal.truckId || 'this truck'}? This action cannot be undone.`}
            onConfirm={confirmRemoveTruck}
            onCancel={cancelRemoveTruck}
          />
        </div>
      );
    }

    ReactDOM.render(
      <ErrorBoundary>
        <CTLDashboard />
      </ErrorBoundary>,
      document.getElementById('root')
    );
  </script>
</body>
</html>
