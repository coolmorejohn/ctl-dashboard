<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coolmore Truck Lines - Daily Operating Report</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .status-active { background: #22c55e; color: white; }
    .status-routine { background: #facc15; color: #1f2937; }
    .status-breakfix { background: #f97316; color: white; }
    .status-nodriver { background: #ef4444; color: white; }
    .status-spare { background: #9ca3af; color: white; }

    /* Mobile table improvements */
    @media (max-width: 768px) {
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      .overflow-x-auto::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 20px;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
        pointer-events: none;
      }
      .overflow-x-auto { position: relative; }
    }

    /* Print styles */
    @media print {
      .no-print { display: none !important; }
      body { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useCallback, useRef } = React;

    // ============================================
    // CONSTANTS
    // ============================================
    const CONSTANTS = {
      FLAGGED_MARGIN_THRESHOLD: 95,      // Flag loads with margin >= this %
      FLAGGED_REVENUE_THRESHOLD: 500,    // Only flag if revenue > this $
      CONNECTION_TIMEOUT_MS: 5000,       // API connection check timeout
      WARNING_THRESHOLD_PERCENT: 0.9,    // Yellow warning at 90% of target
    };

    // ============================================
    // GOOGLE SHEETS CONFIGURATION
    // ============================================
    // TODO: Move to environment config for production deployment
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZ0714JE5nUYsEby7oSclteaNo5UsAtk4sAKgB7vjWkAJAvZU8Fnp3UD4ggcaY2D-xuQ/exec';

    const SheetsDB = {
      // Helper: Write a single chunk via GET
      async writeChunk(sheetName, data, chunkIndex = 0) {
        const payload = { action: 'writeChunk', sheet: sheetName, data, chunkIndex };
        const encodedData = encodeURIComponent(JSON.stringify(payload));
        const url = `${SCRIPT_URL}?payload=${encodedData}&t=${Date.now()}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      },

      // Helper: POST data to Google Apps Script (avoids URL length limits)
      async postToSheets(payload) {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      },

      // Helper: Write large data in chunks (SEQUENTIAL via POST)
      async writeChunked(sheetName, dataObj) {
        // For Shipments/DailyLogs: split into chunks of 10 items each
        // Using POST to avoid URL length limits (GET limited to ~2048 chars)
        const isShipments = dataObj.shipments !== undefined;
        const items = isShipments ? (dataObj.shipments || []) : (Array.isArray(dataObj) ? dataObj : []);
        const chunkSize = 10;  // Can be larger with POST (no URL limit)
        const chunks = [];

        for (let i = 0; i < items.length; i += chunkSize) {
          chunks.push(items.slice(i, i + chunkSize));
        }

        console.log(`Writing ${sheetName} in ${chunks.length} chunks via POST...`);

        // Process chunks SEQUENTIALLY
        for (let i = 0; i < chunks.length; i++) {
          const chunk = chunks[i];
          const isFirst = i === 0;
          let payload;

          if (isFirst) {
            // First chunk includes metadata and clears the sheet
            if (isShipments) {
              payload = { action: 'write', sheet: sheetName, data: { dataDate: dataObj.dataDate, shipments: chunk, totalChunks: chunks.length } };
            } else {
              payload = { action: 'write', sheet: sheetName, data: { items: chunk, totalChunks: chunks.length } };
            }
          } else {
            payload = { action: 'appendChunk', sheet: sheetName, data: chunk, chunkIndex: i };
          }

          console.log(`Chunk ${i + 1}/${chunks.length} POSTing...`);

          const result = await this.postToSheets(payload);
          if (result.error) throw new Error(`Server error on chunk ${i + 1}: ${result.error}`);

          console.log(`Chunk ${i + 1}/${chunks.length} written`, result);

          // Small delay between chunks to avoid rate limiting (200ms)
          if (i < chunks.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        }

        console.log(`All ${chunks.length} chunks written successfully`);
        return { success: true, chunks: chunks.length };
      },

      async read(sheetName) {
        try {
          const url = `${SCRIPT_URL}?action=read&sheet=${encodeURIComponent(sheetName)}&t=${Date.now()}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          if (result.data) {
            localStorage.setItem(`CTL_${sheetName}`, JSON.stringify(result.data));
            return result.data;
          }
          return null;
        } catch (error) {
          console.warn(`Sheets read failed for ${sheetName}:`, error.message);
          const cached = localStorage.getItem(`CTL_${sheetName}`);
          return cached ? JSON.parse(cached) : null;
        }
      },

      async write(sheetName, data, reportDate = null) {
        // Always save to localStorage first
        localStorage.setItem(`CTL_${sheetName}`, JSON.stringify(data));

        const payload = { action: 'write', sheet: sheetName, data };
        if (reportDate) payload.reportDate = reportDate;
        const payloadStr = JSON.stringify(payload);

        // Use chunked writes for Shipments (has shipments array) or DailyLogs (array of logs)
        if (payloadStr.length > 4000) {
          if (sheetName === 'Shipments' && data.shipments) {
            try {
              const result = await this.writeChunked(sheetName, data);
              console.log(`Sheets chunked write result for ${sheetName}:`, result);
              return { success: true, synced: true, method: 'CHUNKED' };
            } catch (error) {
              console.warn(`Sheets chunked write failed for ${sheetName}:`, error.message);
              return { success: false, synced: false, error: error.message };
            }
          }
          if (sheetName === 'DailyLogs' && Array.isArray(data)) {
            try {
              const result = await this.writeChunked(sheetName, data);
              console.log(`Sheets chunked write result for ${sheetName}:`, result);
              return { success: true, synced: true, method: 'CHUNKED' };
            } catch (error) {
              console.warn(`Sheets chunked write failed for ${sheetName}:`, error.message);
              return { success: false, synced: false, error: error.message };
            }
          }
          // Other large data - localStorage only
          console.warn(`${sheetName} too large for GET sync (${payloadStr.length} chars), saved to localStorage only`);
          return { success: true, synced: false, method: 'LOCAL_ONLY', reason: 'payload too large' };
        }

        // Use GET for small payloads
        try {
          const encodedData = encodeURIComponent(payloadStr);
          const url = `${SCRIPT_URL}?payload=${encodedData}&t=${Date.now()}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          console.log(`Sheets write result for ${sheetName}:`, result);
          return { success: true, synced: true, method: 'GET' };
        } catch (error) {
          console.warn(`Sheets write failed for ${sheetName}:`, error.message);
          return { success: false, synced: false, error: error.message };
        }
      },

      async readAll() {
        try {
          const url = `${SCRIPT_URL}?action=readAll&t=${Date.now()}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          if (result.data) {
            Object.keys(result.data).forEach(key => {
              localStorage.setItem(`CTL_${key}`, JSON.stringify(result.data[key]));
            });
            return { data: result.data, source: 'sheets' };
          }
        } catch (error) {
          console.warn('Sheets readAll failed:', error.message);
        }
        const sheets = ['Fleet', 'Goals', 'TruckStatus', 'DailyLogs', 'Shipments', 'MonthlyPlan'];
        const data = {};
        sheets.forEach(name => {
          const cached = localStorage.getItem(`CTL_${name}`);
          if (cached) data[name] = JSON.parse(cached);
        });
        return { data, source: 'localStorage' };
      },

      async checkConnection() {
        try {
          const url = `${SCRIPT_URL}?action=init&t=${Date.now()}`;
          const response = await fetch(url, { signal: AbortSignal.timeout(CONSTANTS.CONNECTION_TIMEOUT_MS) });
          return response.ok;
        } catch {
          return false;
        }
      }
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    const fmt = (n) => n?.toLocaleString('en-US', { maximumFractionDigits: 0 }) || '0';
    const fmtCurrency = (n) => '$' + fmt(Math.round(n || 0));
    const fmtDecimal = (n, d = 2) => (n || 0).toFixed(d);
    const fmtPercent = (n) => fmtDecimal(n || 0, 1) + '%';

    // Check if a date is expired or expiring soon
    const getExpirationStatus = (dateStr) => {
      if (!dateStr) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const expDate = new Date(dateStr);
      const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
      if (daysUntil < 0) return 'expired';
      if (daysUntil <= 30) return 'warning';
      return 'ok';
    };

    // Normalize truck ID from TORO format to internal format
    // TORO exports: "0", "7", "9", "57" -> Internal: "000", "007", "009", "0057"
    // This maps single/double digit trucks to their padded versions
    const TRUCK_ID_MAP = {
      '0': '000',
      '1': '001',
      '7': '007',
      '9': '009',
      '57': '0057',
    };

    const normalizeTruckId = (id) => {
      if (!id || id === 'Unassigned') return '';
      const str = String(id).trim();
      // Check if there's a mapping for this truck ID
      if (TRUCK_ID_MAP[str]) {
        return TRUCK_ID_MAP[str];
      }
      // Otherwise return as-is (for trucks like 555, 1970, 4649, etc.)
      return str;
    };

    // Safe division helper to prevent NaN/Infinity
    const safeDivide = (numerator, denominator, fallback = 0) => {
      if (!denominator || denominator === 0) return fallback;
      return numerator / denominator;
    };

    // Validate and clamp numeric inputs
    const validateGoalInput = (value, min, max, defaultVal) => {
      const num = parseFloat(value);
      if (isNaN(num)) return defaultVal;
      if (min !== null && num < min) return min;
      if (max !== null && num > max) return max;
      return num;
    };

    const getStatusClass = (status) => {
      const classes = {
        'Active': 'status-active',
        'Shop - Routine': 'status-routine',
        'Shop - Break/Fix': 'status-breakfix',
        'Needs Driver': 'status-nodriver',
        'Spare': 'status-spare',
      };
      return classes[status] || 'bg-gray-200 text-gray-700';
    };

    const getColorClass = (value, target, floor = null) => {
      if (floor !== null && value < floor) return 'text-red-600';
      if (value >= target) return 'text-green-600';
      if (value >= target * CONSTANTS.WARNING_THRESHOLD_PERCENT) return 'text-yellow-600';
      return 'text-red-600';
    };

    // ============================================
    // ERROR BOUNDARY COMPONENT
    // ============================================
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true };
      }

      componentDidCatch(error, errorInfo) {
        this.setState({ error, errorInfo });
        console.error('Dashboard Error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
                <h1 className="text-xl font-bold text-red-600 mb-4">‚ö†Ô∏è Something went wrong</h1>
                <p className="text-gray-600 mb-4">
                  The dashboard encountered an error. Your data is safe - it's stored locally and will sync when the issue is resolved.
                </p>
                <details className="mb-4">
                  <summary className="cursor-pointer text-sm text-gray-500 hover:text-gray-700">Technical details</summary>
                  <pre className="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-40">
                    {this.state.error?.toString()}
                    {this.state.errorInfo?.componentStack}
                  </pre>
                </details>
                <div className="flex gap-3">
                  <button
                    onClick={() => window.location.reload()}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                  >
                    Reload Dashboard
                  </button>
                  <button
                    onClick={() => {
                      localStorage.clear();
                      window.location.reload();
                    }}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium"
                  >
                    Clear Cache & Reload
                  </button>
                </div>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // ============================================
    // CONFIRMATION MODAL COMPONENT
    // ============================================
    function ConfirmModal({ isOpen, title, message, onConfirm, onCancel }) {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4">
            <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
            <p className="text-gray-600 mb-6">{message}</p>
            <div className="flex justify-end gap-3">
              <button onClick={onCancel}
                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium">
                Cancel
              </button>
              <button onClick={onConfirm}
                className="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 font-medium">
                Remove
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // REPORTS TAB COMPONENT
    // ============================================
    function ReportsTab({ dailyLogs, fleet, goals, truckStatus, truckExpectedReturn }) {
      const [dateRange, setDateRange] = useState(30);
      const [activeReport, setActiveReport] = useState('overview');

      const DAILY_GOAL = goals.dailyRevenuePerTruck || 940;

      // Status colors
      const STATUS_COLORS = {
        'Active': '#22c55e',
        'Needs Driver': '#f59e0b',
        'Shop - Break/Fix': '#ef4444',
        'Shop - Routine': '#3b82f6',
        'Spare': '#9ca3af'
      };

      // Filter logs by date range
      const filteredLogs = useMemo(() => {
        if (!dailyLogs || dailyLogs.length === 0) return [];
        return dailyLogs.slice(-dateRange);
      }, [dailyLogs, dateRange]);

      // Get truck IDs from fleet (excluding spare)
      const truckIds = useMemo(() => {
        return fleet.filter(t => t.id !== '205').map(t => t.id);
      }, [fleet]);

      // Build truck timeline from daily logs
      const truckTimeline = useMemo(() => {
        if (filteredLogs.length === 0) return [];

        return truckIds.map(truckId => {
          const days = filteredLogs.map(log => {
            const truck = log.trucks?.find(t => t.truckId === truckId);
            return {
              date: log.date,
              status: truck?.status || 'Unknown',
              driver: truck?.driver || '',
              expectedReturn: truck?.expectedReturn || '',
              revenue: truck?.revenue || 0,
              notes: truck?.notes || ''
            };
          });

          const activeDays = days.filter(d => d.status === 'Active').length;
          const downDays = days.length - activeDays;
          const lastDay = days[days.length - 1] || {};

          return {
            truckId,
            days,
            activeDays,
            downDays,
            currentStatus: lastDay.status,
            currentDriver: lastDay.driver,
            expectedReturn: lastDay.expectedReturn
          };
        });
      }, [filteredLogs, truckIds]);

      // Calculate metrics
      const metrics = useMemo(() => {
        let totalDowntimeDays = { nodriver: 0, breakfix: 0, routine: 0 };
        let opportunityCost = 0;

        filteredLogs.forEach(log => {
          const summary = log.summary || {};
          totalDowntimeDays.nodriver += summary.nodriver || 0;
          totalDowntimeDays.breakfix += summary.breakfix || 0;
          totalDowntimeDays.routine += summary.routine || 0;
          opportunityCost += ((summary.nodriver || 0) + (summary.breakfix || 0) + (summary.routine || 0)) * DAILY_GOAL;
        });

        const avgActive = filteredLogs.length > 0
          ? filteredLogs.reduce((sum, l) => sum + (l.summary?.active || 0), 0) / filteredLogs.length
          : 0;

        const totalDowntime = totalDowntimeDays.nodriver + totalDowntimeDays.breakfix + totalDowntimeDays.routine;

        return {
          totalDowntimeDays,
          opportunityCost,
          avgActive: avgActive.toFixed(1),
          totalDowntime,
          utilizationRate: truckIds.length > 0 ? ((avgActive / truckIds.length) * 100).toFixed(1) : 0
        };
      }, [filteredLogs, DAILY_GOAL, truckIds]);

      // Weekly trend data
      const weeklyTrend = useMemo(() => {
        const weeks = {};
        filteredLogs.forEach(log => {
          const d = new Date(log.date);
          const weekStart = new Date(d);
          weekStart.setDate(d.getDate() - d.getDay());
          const weekKey = weekStart.toISOString().split('T')[0];

          if (!weeks[weekKey]) {
            weeks[weekKey] = { active: [], down: [], revenue: [] };
          }
          const summary = log.summary || {};
          weeks[weekKey].active.push(summary.active || 0);
          weeks[weekKey].down.push((summary.nodriver || 0) + (summary.breakfix || 0) + (summary.routine || 0));
          weeks[weekKey].revenue.push(summary.totalRevenue || 0);
        });

        return Object.entries(weeks).map(([week, data]) => ({
          week: new Date(week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          avgActive: (data.active.reduce((a,b) => a+b, 0) / data.active.length).toFixed(1),
          avgDown: (data.down.reduce((a,b) => a+b, 0) / data.down.length).toFixed(1),
          totalRevenue: data.revenue.reduce((a,b) => a+b, 0)
        }));
      }, [filteredLogs]);

      // Downtime breakdown for display
      const downtimeBreakdown = useMemo(() => {
        const { totalDowntimeDays } = metrics;
        return [
          { name: 'Needs Driver', value: totalDowntimeDays.nodriver, color: STATUS_COLORS['Needs Driver'], cost: totalDowntimeDays.nodriver * DAILY_GOAL },
          { name: 'Break/Fix', value: totalDowntimeDays.breakfix, color: STATUS_COLORS['Shop - Break/Fix'], cost: totalDowntimeDays.breakfix * DAILY_GOAL },
          { name: 'Routine', value: totalDowntimeDays.routine, color: STATUS_COLORS['Shop - Routine'], cost: totalDowntimeDays.routine * DAILY_GOAL },
        ].filter(d => d.value > 0);
      }, [metrics, DAILY_GOAL]);

      // Find trucks currently down with expected return dates
      const trucksDown = useMemo(() => {
        return truckTimeline
          .filter(t => t.currentStatus && t.currentStatus !== 'Active' && t.currentStatus !== 'Spare')
          .map(truck => {
            // Find when truck went down
            const downStartIndex = truck.days.findIndex(d => d.status !== 'Active' && d.status !== 'Spare');
            const downStartDate = downStartIndex >= 0 ? truck.days[downStartIndex].date : null;
            const daysDown = downStartIndex >= 0 ? truck.days.length - downStartIndex : 0;

            return {
              ...truck,
              downStartDate,
              daysDown,
              opportunityCost: daysDown * DAILY_GOAL
            };
          });
      }, [truckTimeline, DAILY_GOAL]);

      // ===== DRIVER LEADERBOARD DATA =====
      const driverLeaderboard = useMemo(() => {
        const driverStats = {};

        filteredLogs.forEach(log => {
          (log.trucks || []).forEach(truck => {
            if (truck.driver && truck.status === 'Active') {
              if (!driverStats[truck.driver]) {
                driverStats[truck.driver] = {
                  name: truck.driver,
                  daysActive: 0,
                  totalRevenue: 0,
                  trucks: new Set()
                };
              }
              driverStats[truck.driver].daysActive++;
              driverStats[truck.driver].totalRevenue += truck.revenue || 0;
              driverStats[truck.driver].trucks.add(truck.truckId);
            }
          });
        });

        return Object.values(driverStats)
          .map(d => ({
            ...d,
            trucks: Array.from(d.trucks),
            avgRevenue: d.daysActive > 0 ? Math.round(d.totalRevenue / d.daysActive) : 0,
            vsGoal: d.daysActive > 0 ? Math.round(((d.totalRevenue / d.daysActive) / DAILY_GOAL) * 100) : 0
          }))
          .sort((a, b) => b.avgRevenue - a.avgRevenue);
      }, [filteredLogs, DAILY_GOAL]);

      // ===== REVENUE TREND DATA =====
      const revenueTrend = useMemo(() => {
        return filteredLogs.map(log => ({
          date: log.date,
          displayDate: new Date(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          totalRevenue: log.summary?.totalRevenue || 0,
          activeTrucks: log.summary?.active || 0,
          avgPerTruck: log.summary?.active > 0
            ? Math.round((log.summary?.totalRevenue || 0) / log.summary.active)
            : 0,
          goal: (log.summary?.active || 0) * DAILY_GOAL
        }));
      }, [filteredLogs, DAILY_GOAL]);

      const revenueStats = useMemo(() => {
        if (revenueTrend.length === 0) return { total: 0, avg: 0, goalAchievement: 0, bestDay: null, worstDay: null };

        const total = revenueTrend.reduce((sum, d) => sum + d.totalRevenue, 0);
        const totalGoal = revenueTrend.reduce((sum, d) => sum + d.goal, 0);
        const sorted = [...revenueTrend].sort((a, b) => b.totalRevenue - a.totalRevenue);

        return {
          total,
          avg: Math.round(total / revenueTrend.length),
          goalAchievement: totalGoal > 0 ? Math.round((total / totalGoal) * 100) : 0,
          bestDay: sorted[0],
          worstDay: sorted[sorted.length - 1]
        };
      }, [revenueTrend]);

      // ===== IC CARRIER SCORECARD DATA =====
      const icScorecard = useMemo(() => {
        const icStats = {};

        filteredLogs.forEach(log => {
          (log.ics || []).forEach(ic => {
            const name = ic.name || ic.carrier || 'Unknown';
            if (!icStats[name]) {
              icStats[name] = {
                name,
                daysWorked: 0,
                totalLoads: 0,
                totalRevenue: 0,
                truckTypes: new Set()
              };
            }
            icStats[name].daysWorked++;
            icStats[name].totalLoads += ic.loads || 1;
            icStats[name].totalRevenue += ic.revenue || 0;
            if (ic.type) icStats[name].truckTypes.add(ic.type);
          });
        });

        return Object.values(icStats)
          .map(ic => ({
            ...ic,
            truckTypes: Array.from(ic.truckTypes),
            avgRevenuePerDay: ic.daysWorked > 0 ? Math.round(ic.totalRevenue / ic.daysWorked) : 0,
            avgLoadsPerDay: ic.daysWorked > 0 ? (ic.totalLoads / ic.daysWorked).toFixed(1) : 0
          }))
          .sort((a, b) => b.totalRevenue - a.totalRevenue);
      }, [filteredLogs]);

      // ===== MONTH-OVER-MONTH DATA =====
      const monthlyComparison = useMemo(() => {
        const months = {};

        filteredLogs.forEach(log => {
          const monthKey = log.date.substring(0, 7); // YYYY-MM
          if (!months[monthKey]) {
            months[monthKey] = {
              month: monthKey,
              days: 0,
              totalRevenue: 0,
              activeTruckDays: 0,
              downtimeDays: 0,
              opportunityCost: 0
            };
          }
          months[monthKey].days++;
          months[monthKey].totalRevenue += log.summary?.totalRevenue || 0;
          months[monthKey].activeTruckDays += log.summary?.active || 0;
          const downtime = (log.summary?.nodriver || 0) + (log.summary?.breakfix || 0) + (log.summary?.routine || 0);
          months[monthKey].downtimeDays += downtime;
          months[monthKey].opportunityCost += downtime * DAILY_GOAL;
        });

        const monthList = Object.values(months)
          .map(m => ({
            ...m,
            displayMonth: new Date(m.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            avgDailyRevenue: m.days > 0 ? Math.round(m.totalRevenue / m.days) : 0,
            avgActiveTrucks: m.days > 0 ? (m.activeTruckDays / m.days).toFixed(1) : 0,
            utilization: m.days > 0 && truckIds.length > 0
              ? Math.round((m.activeTruckDays / (m.days * truckIds.length)) * 100)
              : 0
          }))
          .sort((a, b) => a.month.localeCompare(b.month));

        // Add MoM changes
        return monthList.map((m, idx) => {
          if (idx === 0) return { ...m, revenueChange: null, utilizationChange: null };
          const prev = monthList[idx - 1];
          return {
            ...m,
            revenueChange: prev.avgDailyRevenue > 0
              ? Math.round(((m.avgDailyRevenue - prev.avgDailyRevenue) / prev.avgDailyRevenue) * 100)
              : null,
            utilizationChange: prev.utilization > 0
              ? m.utilization - prev.utilization
              : null
          };
        });
      }, [filteredLogs, truckIds.length, DAILY_GOAL]);

      // ===== OWNERSHIP BREAKDOWN DATA =====
      const ownershipTrend = useMemo(() => {
        return filteredLogs.map(log => ({
          date: log.date,
          displayDate: new Date(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          companyOwnedActive: log.summary?.companyOwnedActive || 0,
          companyOwnedTotal: log.summary?.companyOwnedTotal || 0,
          ownerOperatorActive: log.summary?.ownerOperatorActive || 0,
          ownerOperatorTotal: log.summary?.ownerOperatorTotal || 0,
        }));
      }, [filteredLogs]);

      const ownershipStats = useMemo(() => {
        if (ownershipTrend.length === 0) return { companyOwned: {}, ownerOperator: {} };

        const avgCompanyActive = ownershipTrend.reduce((sum, d) => sum + d.companyOwnedActive, 0) / ownershipTrend.length;
        const avgOOActive = ownershipTrend.reduce((sum, d) => sum + d.ownerOperatorActive, 0) / ownershipTrend.length;
        const companyTotal = ownershipTrend[ownershipTrend.length - 1]?.companyOwnedTotal || 0;
        const ooTotal = ownershipTrend[ownershipTrend.length - 1]?.ownerOperatorTotal || 0;

        return {
          companyOwned: {
            avgActive: avgCompanyActive.toFixed(1),
            total: companyTotal,
            utilization: companyTotal > 0 ? Math.round((avgCompanyActive / companyTotal) * 100) : 0
          },
          ownerOperator: {
            avgActive: avgOOActive.toFixed(1),
            total: ooTotal,
            utilization: ooTotal > 0 ? Math.round((avgOOActive / ooTotal) * 100) : 0
          }
        };
      }, [ownershipTrend]);

      // ===== TRAILER TYPE BREAKDOWN DATA =====
      const trailerTypeTrend = useMemo(() => {
        return filteredLogs.map(log => ({
          date: log.date,
          displayDate: new Date(log.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          vanRevenue: log.summary?.vanRevenue || 0,
          vanLoads: log.summary?.vanLoads || 0,
          vanMiles: log.summary?.vanMiles || 0,
          flatbedRevenue: log.summary?.flatbedRevenue || 0,
          flatbedLoads: log.summary?.flatbedLoads || 0,
          flatbedMiles: log.summary?.flatbedMiles || 0,
          unknownLoads: log.summary?.unknownTrailerLoads || 0,
        }));
      }, [filteredLogs]);

      const trailerTypeStats = useMemo(() => {
        if (trailerTypeTrend.length === 0) return { van: {}, flatbed: {} };

        const van = {
          totalRevenue: trailerTypeTrend.reduce((sum, d) => sum + d.vanRevenue, 0),
          totalLoads: trailerTypeTrend.reduce((sum, d) => sum + d.vanLoads, 0),
          totalMiles: trailerTypeTrend.reduce((sum, d) => sum + d.vanMiles, 0),
        };
        van.avgRevPerMile = van.totalMiles > 0 ? van.totalRevenue / van.totalMiles : 0;
        van.avgRevenuePerDay = trailerTypeTrend.length > 0 ? van.totalRevenue / trailerTypeTrend.length : 0;

        const flatbed = {
          totalRevenue: trailerTypeTrend.reduce((sum, d) => sum + d.flatbedRevenue, 0),
          totalLoads: trailerTypeTrend.reduce((sum, d) => sum + d.flatbedLoads, 0),
          totalMiles: trailerTypeTrend.reduce((sum, d) => sum + d.flatbedMiles, 0),
        };
        flatbed.avgRevPerMile = flatbed.totalMiles > 0 ? flatbed.totalRevenue / flatbed.totalMiles : 0;
        flatbed.avgRevenuePerDay = trailerTypeTrend.length > 0 ? flatbed.totalRevenue / trailerTypeTrend.length : 0;

        const unknownLoads = trailerTypeTrend.reduce((sum, d) => sum + d.unknownLoads, 0);

        return { van, flatbed, unknownLoads };
      }, [trailerTypeTrend]);

      // ===== TRUCK ROI DATA =====
      const truckROI = useMemo(() => {
        return truckTimeline.map(truck => {
          const totalRevenue = truck.days.reduce((sum, d) => sum + (d.revenue || 0), 0);
          const activeDays = truck.days.filter(d => d.status === 'Active').length;
          const downDays = truck.days.length - activeDays;
          const opportunityCost = downDays * DAILY_GOAL;
          const utilization = truck.days.length > 0 ? Math.round((activeDays / truck.days.length) * 100) : 0;
          const avgDailyRevenue = activeDays > 0 ? Math.round(totalRevenue / activeDays) : 0;

          // Calculate ROI score (weighted: 60% utilization, 40% revenue performance)
          const revenuePerformance = avgDailyRevenue > 0 ? Math.min((avgDailyRevenue / DAILY_GOAL) * 100, 150) : 0;
          const roiScore = Math.round((utilization * 0.6) + (revenuePerformance * 0.4));

          return {
            truckId: truck.truckId,
            currentStatus: truck.currentStatus,
            currentDriver: truck.currentDriver,
            totalRevenue,
            activeDays,
            downDays,
            opportunityCost,
            utilization,
            avgDailyRevenue,
            roiScore,
            netContribution: totalRevenue - opportunityCost
          };
        }).sort((a, b) => b.roiScore - a.roiScore);
      }, [truckTimeline, DAILY_GOAL]);

      // Empty state
      if (!dailyLogs || dailyLogs.length === 0) {
        return (
          <div className="bg-white rounded-lg shadow-sm p-8 text-center">
            <div className="text-6xl mb-4">üìä</div>
            <h2 className="text-xl font-semibold text-gray-800 mb-2">No Historical Data Yet</h2>
            <p className="text-gray-600 mb-4">
              Reports are generated from your daily logs. Start saving daily snapshots on the Status tab to build your reporting history.
            </p>
            <p className="text-sm text-gray-500">
              Each time you click "Save & Log Day", a snapshot is saved that powers these reports.
            </p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="bg-white rounded-lg shadow-sm p-4">
            <div className="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h2 className="text-lg font-semibold text-gray-800">Fleet Performance Reports</h2>
                <p className="text-sm text-gray-500">
                  {filteredLogs.length} days of data ({filteredLogs[0]?.date} to {filteredLogs[filteredLogs.length - 1]?.date})
                </p>
              </div>
              <div className="flex gap-2">
                {[30, 60, 90].map(days => (
                  <button
                    key={days}
                    onClick={() => setDateRange(days)}
                    disabled={dailyLogs.length < days}
                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                      dateRange === days
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    } ${dailyLogs.length < days ? 'opacity-50 cursor-not-allowed' : ''}`}
                  >
                    {days}d
                  </button>
                ))}
              </div>
            </div>

            {/* Sub-tabs */}
            <div className="flex flex-wrap gap-1 mt-4 pt-3 border-t">
              {[
                { id: 'overview', label: 'üìà Overview' },
                { id: 'availability', label: 'üöõ Availability' },
                { id: 'ownership', label: 'üè¢ Ownership' },
                { id: 'trailertype', label: 'üì¶ Trailer Types' },
                { id: 'downtime', label: '‚ö†Ô∏è Downtime' },
                { id: 'tracking', label: 'üìÖ Return Dates' },
                { id: 'leaderboard', label: 'üèÜ Drivers' },
                { id: 'revenue', label: 'üí∞ Revenue' },
                { id: 'icscorecard', label: 'ü§ù ICs' },
                { id: 'momcompare', label: 'üìä MoM' },
                { id: 'roi', label: 'üîß ROI' },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveReport(tab.id)}
                  className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                    activeReport === tab.id
                      ? 'bg-blue-100 text-blue-700'
                      : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* ===== OVERVIEW ===== */}
          {activeReport === 'overview' && (
            <div className="space-y-6">
              {/* KPI Cards */}
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Avg Active Trucks</div>
                  <div className="text-2xl font-bold text-gray-800">{metrics.avgActive}</div>
                  <div className="text-xs text-gray-400">of {truckIds.length} revenue trucks</div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Fleet Utilization</div>
                  <div className={`text-2xl font-bold ${parseFloat(metrics.utilizationRate) >= 80 ? 'text-green-600' : 'text-red-600'}`}>
                    {metrics.utilizationRate}%
                  </div>
                  <div className="text-xs text-gray-400">target: 100%</div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Total Downtime</div>
                  <div className="text-2xl font-bold text-red-600">{metrics.totalDowntime}</div>
                  <div className="text-xs text-gray-400">truck-days lost</div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Opportunity Cost</div>
                  <div className="text-2xl font-bold text-amber-600">${metrics.opportunityCost.toLocaleString()}</div>
                  <div className="text-xs text-gray-400">lost revenue potential</div>
                </div>
              </div>

              {/* Weekly Trend */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Fleet Availability by Week</h3>
                <div className="space-y-3">
                  {weeklyTrend.map((week, idx) => (
                    <div key={idx} className="flex items-center gap-4">
                      <div className="w-20 text-sm text-gray-600">{week.week}</div>
                      <div className="flex-1 flex gap-1 h-6">
                        <div
                          className="bg-green-500 rounded-l"
                          style={{ width: `${(parseFloat(week.avgActive) / truckIds.length) * 100}%` }}
                          title={`${week.avgActive} active`}
                        />
                        <div
                          className="bg-red-500 rounded-r"
                          style={{ width: `${(parseFloat(week.avgDown) / truckIds.length) * 100}%` }}
                          title={`${week.avgDown} down`}
                        />
                      </div>
                      <div className="w-32 text-right text-sm">
                        <span className="text-green-600 font-medium">{week.avgActive}</span>
                        <span className="text-gray-400"> / </span>
                        <span className="text-red-600">{week.avgDown}</span>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex gap-4 mt-4 pt-3 border-t text-xs text-gray-500">
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-green-500 rounded"></span> Active</span>
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-red-500 rounded"></span> Down</span>
                </div>
              </div>

              {/* Downtime Breakdown */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Opportunity Cost by Downtime Type</h3>
                {downtimeBreakdown.length > 0 ? (
                  <div className="space-y-3">
                    {downtimeBreakdown.map((item, idx) => (
                      <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex items-center gap-3">
                          <div className="w-4 h-4 rounded" style={{ backgroundColor: item.color }}></div>
                          <span className="font-medium">{item.name}</span>
                        </div>
                        <div className="text-right">
                          <div className="font-bold" style={{ color: item.color }}>${item.cost.toLocaleString()}</div>
                          <div className="text-xs text-gray-500">{item.value} truck-days</div>
                        </div>
                      </div>
                    ))}
                    <div className="flex items-center justify-between p-3 bg-gray-100 rounded-lg font-semibold">
                      <span>Total Opportunity Cost</span>
                      <span className="text-red-600">${metrics.opportunityCost.toLocaleString()}</span>
                    </div>
                  </div>
                ) : (
                  <p className="text-gray-500 text-center py-4">No downtime recorded in this period üéâ</p>
                )}
              </div>
            </div>
          )}

          {/* ===== AVAILABILITY TIMELINE ===== */}
          {activeReport === 'availability' && (
            <div className="bg-white rounded-lg shadow-sm p-6">
              <h3 className="text-md font-semibold text-gray-800 mb-2">Truck Availability Timeline</h3>
              <p className="text-sm text-gray-500 mb-4">Each cell = one day. Left = most recent, right = oldest. Hover for details.</p>

              <div className="space-y-2 overflow-x-auto">
                {truckTimeline.map(truck => (
                  <div key={truck.truckId} className="flex items-center gap-3 min-w-fit">
                    <div className="w-16 text-right font-mono text-sm font-medium text-gray-700">
                      #{truck.truckId}
                    </div>
                    <div className="flex gap-px">
                      {truck.days.slice().reverse().map((day, i) => (
                        <div
                          key={i}
                          className="w-3 h-6 rounded-sm cursor-pointer hover:opacity-75 transition-opacity"
                          style={{ backgroundColor: STATUS_COLORS[day.status] || '#d1d5db' }}
                          title={`${day.date}: ${day.status}${day.driver ? ` (${day.driver})` : ''}${day.notes ? ` - ${day.notes}` : ''}`}
                        />
                      ))}
                    </div>
                    <div className="w-24 text-right text-sm">
                      <span className="text-green-600 font-medium">{truck.activeDays}</span>
                      <span className="text-gray-400">/{truck.days.length}</span>
                    </div>
                  </div>
                ))}
              </div>

              {/* Legend */}
              <div className="flex flex-wrap gap-4 mt-6 pt-4 border-t">
                {Object.entries(STATUS_COLORS).map(([status, color]) => (
                  <div key={status} className="flex items-center gap-2 text-sm">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: color }}></div>
                    <span className="text-gray-600">{status}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* ===== OWNERSHIP BREAKDOWN ===== */}
          {activeReport === 'ownership' && (
            <div className="space-y-6">
              {/* Summary Cards */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Company-Owned */}
                <div className="bg-blue-50 rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">üè¢</span>
                    <h3 className="text-lg font-semibold text-blue-800">Company-Owned Trucks</h3>
                  </div>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">Total Trucks</div>
                      <div className="text-2xl font-bold text-blue-600">{ownershipStats.companyOwned.total}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Avg Active</div>
                      <div className="text-2xl font-bold text-green-600">{ownershipStats.companyOwned.avgActive}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Utilization</div>
                      <div className={`text-2xl font-bold ${ownershipStats.companyOwned.utilization >= 80 ? 'text-green-600' : 'text-red-600'}`}>
                        {ownershipStats.companyOwned.utilization}%
                      </div>
                    </div>
                  </div>
                </div>

                {/* Owner-Operators */}
                <div className="bg-purple-50 rounded-lg shadow-sm p-6 border-l-4 border-purple-500">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">üë§</span>
                    <h3 className="text-lg font-semibold text-purple-800">Owner-Operators</h3>
                  </div>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">Total Trucks</div>
                      <div className="text-2xl font-bold text-purple-600">{ownershipStats.ownerOperator.total}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Avg Active</div>
                      <div className="text-2xl font-bold text-green-600">{ownershipStats.ownerOperator.avgActive}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Utilization</div>
                      <div className={`text-2xl font-bold ${ownershipStats.ownerOperator.utilization >= 80 ? 'text-green-600' : 'text-red-600'}`}>
                        {ownershipStats.ownerOperator.utilization}%
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Trend Chart */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Daily Active Trucks by Ownership</h3>
                <div className="space-y-2">
                  {ownershipTrend.slice(-14).map((day, idx) => (
                    <div key={idx} className="flex items-center gap-3">
                      <div className="w-16 text-sm text-gray-600">{day.displayDate}</div>
                      <div className="flex-1 flex gap-1 h-5">
                        <div
                          className="bg-blue-500 rounded-l"
                          style={{ width: `${day.companyOwnedTotal > 0 ? (day.companyOwnedActive / (day.companyOwnedTotal + day.ownerOperatorTotal)) * 100 : 0}%` }}
                          title={`Company: ${day.companyOwnedActive} active`}
                        />
                        <div
                          className="bg-purple-500 rounded-r"
                          style={{ width: `${day.ownerOperatorTotal > 0 ? (day.ownerOperatorActive / (day.companyOwnedTotal + day.ownerOperatorTotal)) * 100 : 0}%` }}
                          title={`O/O: ${day.ownerOperatorActive} active`}
                        />
                      </div>
                      <div className="w-24 text-right text-xs">
                        <span className="text-blue-600">{day.companyOwnedActive}</span>
                        <span className="text-gray-400"> + </span>
                        <span className="text-purple-600">{day.ownerOperatorActive}</span>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex gap-4 mt-4 pt-3 border-t text-xs text-gray-500">
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-blue-500 rounded"></span> Company-Owned</span>
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-purple-500 rounded"></span> Owner-Operators</span>
                </div>
              </div>

              {ownershipStats.ownerOperator.total === 0 && (
                <div className="bg-gray-50 rounded-lg p-6 text-center">
                  <p className="text-gray-500">No owner-operators configured. Set ownership type on the Status tab to see comparison data.</p>
                </div>
              )}
            </div>
          )}

          {/* ===== TRAILER TYPE BREAKDOWN ===== */}
          {activeReport === 'trailertype' && (
            <div className="space-y-6">
              {/* Summary Cards */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Van */}
                <div className="bg-cyan-50 rounded-lg shadow-sm p-6 border-l-4 border-cyan-500">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">üöê</span>
                    <h3 className="text-lg font-semibold text-cyan-800">Van Loads</h3>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">Total Revenue</div>
                      <div className="text-xl font-bold text-cyan-600">${trailerTypeStats.van.totalRevenue?.toLocaleString() || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Total Loads</div>
                      <div className="text-xl font-bold text-cyan-600">{trailerTypeStats.van.totalLoads || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Total Miles</div>
                      <div className="text-xl font-bold text-cyan-600">{trailerTypeStats.van.totalMiles?.toLocaleString() || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">$/Mile</div>
                      <div className="text-xl font-bold text-cyan-600">${trailerTypeStats.van.avgRevPerMile?.toFixed(2) || '0.00'}</div>
                    </div>
                  </div>
                </div>

                {/* Flatbed */}
                <div className="bg-amber-50 rounded-lg shadow-sm p-6 border-l-4 border-amber-500">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">üõª</span>
                    <h3 className="text-lg font-semibold text-amber-800">Flatbed Loads</h3>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">Total Revenue</div>
                      <div className="text-xl font-bold text-amber-600">${trailerTypeStats.flatbed.totalRevenue?.toLocaleString() || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Total Loads</div>
                      <div className="text-xl font-bold text-amber-600">{trailerTypeStats.flatbed.totalLoads || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Total Miles</div>
                      <div className="text-xl font-bold text-amber-600">{trailerTypeStats.flatbed.totalMiles?.toLocaleString() || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">$/Mile</div>
                      <div className="text-xl font-bold text-amber-600">${trailerTypeStats.flatbed.avgRevPerMile?.toFixed(2) || '0.00'}</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Comparison */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Van vs Flatbed Comparison</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-4 py-2 text-left">Metric</th>
                        <th className="px-4 py-2 text-right text-cyan-700">Van</th>
                        <th className="px-4 py-2 text-right text-amber-700">Flatbed</th>
                        <th className="px-4 py-2 text-right">Difference</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr className="border-b">
                        <td className="px-4 py-3">Revenue</td>
                        <td className="px-4 py-3 text-right font-medium">${trailerTypeStats.van.totalRevenue?.toLocaleString() || 0}</td>
                        <td className="px-4 py-3 text-right font-medium">${trailerTypeStats.flatbed.totalRevenue?.toLocaleString() || 0}</td>
                        <td className={`px-4 py-3 text-right font-medium ${(trailerTypeStats.van.totalRevenue || 0) > (trailerTypeStats.flatbed.totalRevenue || 0) ? 'text-cyan-600' : 'text-amber-600'}`}>
                          {(trailerTypeStats.van.totalRevenue || 0) > (trailerTypeStats.flatbed.totalRevenue || 0) ? 'Van +' : 'Flatbed +'}
                          ${Math.abs((trailerTypeStats.van.totalRevenue || 0) - (trailerTypeStats.flatbed.totalRevenue || 0)).toLocaleString()}
                        </td>
                      </tr>
                      <tr className="border-b">
                        <td className="px-4 py-3">Loads</td>
                        <td className="px-4 py-3 text-right font-medium">{trailerTypeStats.van.totalLoads || 0}</td>
                        <td className="px-4 py-3 text-right font-medium">{trailerTypeStats.flatbed.totalLoads || 0}</td>
                        <td className={`px-4 py-3 text-right font-medium ${(trailerTypeStats.van.totalLoads || 0) > (trailerTypeStats.flatbed.totalLoads || 0) ? 'text-cyan-600' : 'text-amber-600'}`}>
                          {(trailerTypeStats.van.totalLoads || 0) > (trailerTypeStats.flatbed.totalLoads || 0) ? 'Van +' : 'Flatbed +'}
                          {Math.abs((trailerTypeStats.van.totalLoads || 0) - (trailerTypeStats.flatbed.totalLoads || 0))}
                        </td>
                      </tr>
                      <tr className="border-b">
                        <td className="px-4 py-3">$/Mile</td>
                        <td className="px-4 py-3 text-right font-medium">${trailerTypeStats.van.avgRevPerMile?.toFixed(2) || '0.00'}</td>
                        <td className="px-4 py-3 text-right font-medium">${trailerTypeStats.flatbed.avgRevPerMile?.toFixed(2) || '0.00'}</td>
                        <td className={`px-4 py-3 text-right font-medium ${(trailerTypeStats.van.avgRevPerMile || 0) > (trailerTypeStats.flatbed.avgRevPerMile || 0) ? 'text-cyan-600' : 'text-amber-600'}`}>
                          {(trailerTypeStats.van.avgRevPerMile || 0) > (trailerTypeStats.flatbed.avgRevPerMile || 0) ? 'Van +' : 'Flatbed +'}
                          ${Math.abs((trailerTypeStats.van.avgRevPerMile || 0) - (trailerTypeStats.flatbed.avgRevPerMile || 0)).toFixed(2)}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Daily Trend */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Daily Revenue by Trailer Type</h3>
                <div className="space-y-2">
                  {trailerTypeTrend.slice(-14).map((day, idx) => {
                    const totalRev = day.vanRevenue + day.flatbedRevenue;
                    return (
                      <div key={idx} className="flex items-center gap-3">
                        <div className="w-16 text-sm text-gray-600">{day.displayDate}</div>
                        <div className="flex-1 flex gap-1 h-5">
                          {totalRev > 0 && (
                            <>
                              <div
                                className="bg-cyan-500 rounded-l"
                                style={{ width: `${(day.vanRevenue / totalRev) * 100}%` }}
                                title={`Van: $${day.vanRevenue.toLocaleString()}`}
                              />
                              <div
                                className="bg-amber-500 rounded-r"
                                style={{ width: `${(day.flatbedRevenue / totalRev) * 100}%` }}
                                title={`Flatbed: $${day.flatbedRevenue.toLocaleString()}`}
                              />
                            </>
                          )}
                        </div>
                        <div className="w-32 text-right text-xs">
                          <span className="text-cyan-600">${day.vanRevenue.toLocaleString()}</span>
                          <span className="text-gray-400"> / </span>
                          <span className="text-amber-600">${day.flatbedRevenue.toLocaleString()}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="flex gap-4 mt-4 pt-3 border-t text-xs text-gray-500">
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-cyan-500 rounded"></span> Van</span>
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-amber-500 rounded"></span> Flatbed</span>
                </div>
              </div>

              {trailerTypeStats.unknownLoads > 0 && (
                <div className="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
                  ‚ö†Ô∏è {trailerTypeStats.unknownLoads} loads have unknown trailer type. Check the "Commodities" column in your TORO exports.
                </div>
              )}
            </div>
          )}

          {/* ===== DOWNTIME ANALYSIS ===== */}
          {activeReport === 'downtime' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Downtime Impact by Truck</h3>

                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-3 py-2 text-left">Truck</th>
                        <th className="px-3 py-2 text-left">Current Status</th>
                        <th className="px-3 py-2 text-center">Active Days</th>
                        <th className="px-3 py-2 text-center">Down Days</th>
                        <th className="px-3 py-2 text-right">Opportunity Cost</th>
                        <th className="px-3 py-2 text-center">Utilization</th>
                      </tr>
                    </thead>
                    <tbody>
                      {truckTimeline
                        .sort((a, b) => b.downDays - a.downDays)
                        .map((truck, idx) => {
                          const utilization = truck.days.length > 0 ? Math.round((truck.activeDays / truck.days.length) * 100) : 0;
                          const oppCost = truck.downDays * DAILY_GOAL;

                          return (
                            <tr key={truck.truckId} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className="px-3 py-2">
                                <span className="font-mono font-medium">#{truck.truckId}</span>
                                {truck.currentDriver && (
                                  <span className="text-gray-500 text-xs ml-2">{truck.currentDriver}</span>
                                )}
                              </td>
                              <td className="px-3 py-2">
                                <span
                                  className="px-2 py-0.5 rounded text-xs font-medium"
                                  style={{
                                    backgroundColor: `${STATUS_COLORS[truck.currentStatus]}20`,
                                    color: STATUS_COLORS[truck.currentStatus]
                                  }}
                                >
                                  {truck.currentStatus || 'Unknown'}
                                </span>
                              </td>
                              <td className="px-3 py-2 text-center text-green-600 font-medium">{truck.activeDays}</td>
                              <td className="px-3 py-2 text-center">
                                {truck.downDays > 0 ? (
                                  <span className="text-red-600 font-medium">{truck.downDays}</span>
                                ) : (
                                  <span className="text-gray-400">0</span>
                                )}
                              </td>
                              <td className="px-3 py-2 text-right">
                                {oppCost > 0 ? (
                                  <span className="text-red-600 font-medium">${oppCost.toLocaleString()}</span>
                                ) : (
                                  <span className="text-gray-400">‚Äî</span>
                                )}
                              </td>
                              <td className="px-3 py-2">
                                <div className="flex items-center justify-center gap-2">
                                  <div className="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div
                                      className="h-full rounded-full"
                                      style={{
                                        width: `${utilization}%`,
                                        backgroundColor: utilization >= 90 ? '#22c55e' : utilization >= 70 ? '#f59e0b' : '#ef4444'
                                      }}
                                    />
                                  </div>
                                  <span className="text-xs text-gray-500 w-8">{utilization}%</span>
                                </div>
                              </td>
                            </tr>
                          );
                        })}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Primary Issue Callout */}
              {metrics.totalDowntimeDays.nodriver > 0 && metrics.totalDowntimeDays.nodriver >= metrics.totalDowntimeDays.breakfix && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">‚ö†Ô∏è</span>
                    <div>
                      <h4 className="font-semibold text-amber-800">Primary Issue: Driver Recruiting</h4>
                      <p className="text-amber-700 text-sm mt-1">
                        {metrics.totalDowntimeDays.nodriver} truck-days lost to driver vacancies, representing{' '}
                        <span className="font-bold">
                          {Math.round((metrics.totalDowntimeDays.nodriver / metrics.totalDowntime) * 100)}%
                        </span>{' '}
                        of all downtime. Estimated opportunity cost:{' '}
                        <span className="font-bold">${(metrics.totalDowntimeDays.nodriver * DAILY_GOAL).toLocaleString()}</span>
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ===== RETURN DATE TRACKING ===== */}
          {activeReport === 'tracking' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-2">Expected Return Date Tracking</h3>
                <p className="text-sm text-gray-500 mb-4">
                  Monitor trucks that are down and track whether return dates are being met or pushed out.
                </p>

                {trucksDown.length > 0 ? (
                  <div className="space-y-4">
                    {trucksDown.map(truck => (
                      <div key={truck.truckId} className="bg-gray-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-3">
                            <span className="font-mono font-bold text-lg">#{truck.truckId}</span>
                            <span
                              className="px-2 py-1 rounded text-sm font-medium"
                              style={{
                                backgroundColor: `${STATUS_COLORS[truck.currentStatus]}20`,
                                color: STATUS_COLORS[truck.currentStatus]
                              }}
                            >
                              {truck.currentStatus}
                            </span>
                          </div>
                          <div className="text-right">
                            <div className="text-sm text-gray-500">Days Down</div>
                            <div className="text-2xl font-bold text-red-600">{truck.daysDown}</div>
                          </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <div className="text-gray-500">Down Since</div>
                            <div className="font-medium">{truck.downStartDate || '‚Äî'}</div>
                          </div>
                          <div>
                            <div className="text-gray-500">Expected Return</div>
                            <div className="font-medium text-blue-600">{truck.expectedReturn || 'Not set'}</div>
                          </div>
                          <div>
                            <div className="text-gray-500">Opportunity Cost</div>
                            <div className="font-medium text-red-600">${truck.opportunityCost.toLocaleString()}</div>
                          </div>
                        </div>

                        {/* Progress bar */}
                        {truck.expectedReturn && (
                          <div className="mt-4 pt-3 border-t border-gray-200">
                            <div className="flex justify-between text-xs text-gray-500 mb-1">
                              <span>Down: {truck.downStartDate}</span>
                              <span>Return: {truck.expectedReturn}</span>
                            </div>
                            <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-red-500 rounded-full"
                                style={{ width: `${Math.min((truck.daysDown / 45) * 100, 100)}%` }}
                              />
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    <div className="text-4xl mb-2">üéâ</div>
                    <p>All trucks are currently active or spare. No return dates to track.</p>
                  </div>
                )}
              </div>

              {/* Info box */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <span className="text-xl">üí°</span>
                  <div>
                    <h4 className="font-semibold text-blue-800">Return Date Slippage Detection</h4>
                    <p className="text-blue-700 text-sm mt-1">
                      This report tracks when expected return dates get pushed out. As you log more daily snapshots,
                      any changes to expected return dates will be flagged here, helping you identify patterns
                      where estimates consistently slip.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ===== DRIVER LEADERBOARD ===== */}
          {activeReport === 'leaderboard' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-2">Driver Performance Leaderboard</h3>
                <p className="text-sm text-gray-500 mb-4">
                  Ranked by average daily revenue. Shows drivers who were active during the selected period.
                </p>

                {driverLeaderboard.length > 0 ? (
                  <div className="space-y-3">
                    {driverLeaderboard.map((driver, idx) => (
                      <div
                        key={driver.name}
                        className={`flex items-center gap-4 p-4 rounded-lg ${
                          idx === 0 ? 'bg-yellow-50 border border-yellow-200' :
                          idx === 1 ? 'bg-gray-100 border border-gray-200' :
                          idx === 2 ? 'bg-amber-50 border border-amber-200' :
                          'bg-white border border-gray-100'
                        }`}
                      >
                        <div className="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold" style={{
                          backgroundColor: idx === 0 ? '#fbbf24' : idx === 1 ? '#9ca3af' : idx === 2 ? '#d97706' : '#e5e7eb',
                          color: idx < 3 ? 'white' : '#6b7280'
                        }}>
                          {idx + 1}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold text-gray-800">{driver.name}</div>
                          <div className="text-sm text-gray-500">
                            {driver.daysActive} days active ‚Ä¢ Truck{driver.trucks.length > 1 ? 's' : ''}: #{driver.trucks.join(', #')}
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-xl font-bold text-green-600">${driver.avgRevenue.toLocaleString()}</div>
                          <div className="text-sm" style={{ color: driver.vsGoal >= 100 ? '#22c55e' : '#ef4444' }}>
                            {driver.vsGoal}% of ${DAILY_GOAL} goal
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    <div className="text-4xl mb-2">üë§</div>
                    <p>No driver data available for this period.</p>
                  </div>
                )}
              </div>

              {/* Summary stats */}
              {driverLeaderboard.length > 0 && (
                <div className="grid grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg shadow-sm p-4 text-center">
                    <div className="text-sm text-gray-500 mb-1">Top Performer</div>
                    <div className="font-bold text-gray-800">{driverLeaderboard[0]?.name}</div>
                    <div className="text-sm text-green-600">${driverLeaderboard[0]?.avgRevenue}/day avg</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-4 text-center">
                    <div className="text-sm text-gray-500 mb-1">Fleet Avg Revenue</div>
                    <div className="font-bold text-gray-800">
                      ${Math.round(driverLeaderboard.reduce((s, d) => s + d.avgRevenue, 0) / driverLeaderboard.length).toLocaleString()}
                    </div>
                    <div className="text-sm text-gray-500">per driver per day</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-4 text-center">
                    <div className="text-sm text-gray-500 mb-1">Drivers Above Goal</div>
                    <div className="font-bold text-green-600">
                      {driverLeaderboard.filter(d => d.vsGoal >= 100).length} / {driverLeaderboard.length}
                    </div>
                    <div className="text-sm text-gray-500">meeting ${DAILY_GOAL}/day</div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ===== REVENUE TREND ===== */}
          {activeReport === 'revenue' && (
            <div className="space-y-6">
              {/* KPI Cards */}
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Total Revenue</div>
                  <div className="text-2xl font-bold text-green-600">${revenueStats.total.toLocaleString()}</div>
                  <div className="text-xs text-gray-400">{dateRange} day period</div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Daily Average</div>
                  <div className="text-2xl font-bold text-gray-800">${revenueStats.avg.toLocaleString()}</div>
                  <div className="text-xs text-gray-400">per day</div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Goal Achievement</div>
                  <div className={`text-2xl font-bold ${revenueStats.goalAchievement >= 100 ? 'text-green-600' : 'text-amber-600'}`}>
                    {revenueStats.goalAchievement}%
                  </div>
                  <div className="text-xs text-gray-400">vs ${DAILY_GOAL}/truck target</div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-500 mb-1">Best Day</div>
                  <div className="text-2xl font-bold text-blue-600">${revenueStats.bestDay?.totalRevenue.toLocaleString() || 0}</div>
                  <div className="text-xs text-gray-400">{revenueStats.bestDay?.displayDate || '‚Äî'}</div>
                </div>
              </div>

              {/* Revenue Chart (simplified bar chart) */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Daily Revenue Trend</h3>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {revenueTrend.map((day, idx) => {
                    const maxRevenue = Math.max(...revenueTrend.map(d => d.totalRevenue), 1);
                    const pct = (day.totalRevenue / maxRevenue) * 100;
                    const isAboveGoal = day.totalRevenue >= day.goal;

                    return (
                      <div key={day.date} className="flex items-center gap-3">
                        <div className="w-16 text-sm text-gray-500 text-right">{day.displayDate}</div>
                        <div className="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden relative">
                          <div
                            className={`h-full rounded-full transition-all ${isAboveGoal ? 'bg-green-500' : 'bg-amber-500'}`}
                            style={{ width: `${pct}%` }}
                          />
                          {/* Goal line */}
                          <div
                            className="absolute top-0 bottom-0 w-0.5 bg-red-400"
                            style={{ left: `${(day.goal / maxRevenue) * 100}%` }}
                            title={`Goal: $${day.goal.toLocaleString()}`}
                          />
                        </div>
                        <div className="w-24 text-right">
                          <span className={`font-medium ${isAboveGoal ? 'text-green-600' : 'text-amber-600'}`}>
                            ${day.totalRevenue.toLocaleString()}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="flex gap-4 mt-4 pt-3 border-t text-xs text-gray-500">
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-green-500 rounded"></span> Above Goal</span>
                  <span className="flex items-center gap-1"><span className="w-3 h-3 bg-amber-500 rounded"></span> Below Goal</span>
                  <span className="flex items-center gap-1"><span className="w-3 h-0.5 bg-red-400"></span> Daily Goal Line</span>
                </div>
              </div>

              {/* Weekly Summary */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-4">Weekly Revenue Summary</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-3 py-2 text-left">Week</th>
                        <th className="px-3 py-2 text-right">Total Revenue</th>
                        <th className="px-3 py-2 text-right">Avg Active Trucks</th>
                      </tr>
                    </thead>
                    <tbody>
                      {weeklyTrend.map((week, idx) => (
                        <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-3 py-2 font-medium">{week.week}</td>
                          <td className="px-3 py-2 text-right text-green-600 font-medium">
                            ${week.totalRevenue.toLocaleString()}
                          </td>
                          <td className="px-3 py-2 text-right">{week.avgActive}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* ===== IC CARRIER SCORECARD ===== */}
          {activeReport === 'icscorecard' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-2">IC / Carrier Performance Scorecard</h3>
                <p className="text-sm text-gray-500 mb-4">
                  Track independent contractor and carrier partners. Ranked by total revenue contribution.
                </p>

                {icScorecard.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-3 py-2 text-left">Carrier / IC</th>
                          <th className="px-3 py-2 text-left">Type</th>
                          <th className="px-3 py-2 text-center">Days Worked</th>
                          <th className="px-3 py-2 text-center">Avg Loads/Day</th>
                          <th className="px-3 py-2 text-right">Avg Rev/Day</th>
                          <th className="px-3 py-2 text-right">Total Revenue</th>
                        </tr>
                      </thead>
                      <tbody>
                        {icScorecard.map((ic, idx) => (
                          <tr key={ic.name} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-3 py-2">
                              <span className="font-medium">{ic.name}</span>
                              {idx === 0 && <span className="ml-2 text-yellow-500">‚≠ê</span>}
                            </td>
                            <td className="px-3 py-2 text-gray-500">
                              {ic.truckTypes.length > 0 ? ic.truckTypes.join(', ') : '‚Äî'}
                            </td>
                            <td className="px-3 py-2 text-center">{ic.daysWorked}</td>
                            <td className="px-3 py-2 text-center">{ic.avgLoadsPerDay}</td>
                            <td className="px-3 py-2 text-right text-gray-600">
                              ${ic.avgRevenuePerDay.toLocaleString()}
                            </td>
                            <td className="px-3 py-2 text-right font-medium text-green-600">
                              ${ic.totalRevenue.toLocaleString()}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot className="bg-gray-100">
                        <tr>
                          <td className="px-3 py-2 font-semibold" colSpan="5">Total IC Revenue</td>
                          <td className="px-3 py-2 text-right font-bold text-green-600">
                            ${icScorecard.reduce((s, ic) => s + ic.totalRevenue, 0).toLocaleString()}
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    <div className="text-4xl mb-2">ü§ù</div>
                    <p>No IC/carrier data recorded for this period.</p>
                  </div>
                )}
              </div>

              {/* IC Summary */}
              {icScorecard.length > 0 && (
                <div className="grid grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg shadow-sm p-4 text-center">
                    <div className="text-sm text-gray-500 mb-1">Active ICs/Carriers</div>
                    <div className="text-2xl font-bold text-gray-800">{icScorecard.length}</div>
                    <div className="text-sm text-gray-500">partners</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-4 text-center">
                    <div className="text-sm text-gray-500 mb-1">Top Performer</div>
                    <div className="font-bold text-gray-800">{icScorecard[0]?.name}</div>
                    <div className="text-sm text-green-600">${icScorecard[0]?.totalRevenue.toLocaleString()}</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-4 text-center">
                    <div className="text-sm text-gray-500 mb-1">IC Revenue Share</div>
                    <div className="text-2xl font-bold text-blue-600">
                      {revenueStats.total > 0
                        ? Math.round((icScorecard.reduce((s, ic) => s + ic.totalRevenue, 0) / revenueStats.total) * 100)
                        : 0}%
                    </div>
                    <div className="text-sm text-gray-500">of total revenue</div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ===== MONTH-OVER-MONTH COMPARISON ===== */}
          {activeReport === 'momcompare' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-2">Month-over-Month Comparison</h3>
                <p className="text-sm text-gray-500 mb-4">
                  Compare performance metrics across months to identify trends and seasonal patterns.
                </p>

                {monthlyComparison.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-3 py-2 text-left">Month</th>
                          <th className="px-3 py-2 text-center">Days</th>
                          <th className="px-3 py-2 text-right">Total Revenue</th>
                          <th className="px-3 py-2 text-right">Avg Daily Rev</th>
                          <th className="px-3 py-2 text-center">Utilization</th>
                          <th className="px-3 py-2 text-right">Opp. Cost</th>
                          <th className="px-3 py-2 text-center">MoM Change</th>
                        </tr>
                      </thead>
                      <tbody>
                        {monthlyComparison.map((month, idx) => (
                          <tr key={month.month} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-3 py-2 font-medium">{month.displayMonth}</td>
                            <td className="px-3 py-2 text-center text-gray-500">{month.days}</td>
                            <td className="px-3 py-2 text-right font-medium text-green-600">
                              ${month.totalRevenue.toLocaleString()}
                            </td>
                            <td className="px-3 py-2 text-right">${month.avgDailyRevenue.toLocaleString()}</td>
                            <td className="px-3 py-2 text-center">
                              <div className="flex items-center justify-center gap-2">
                                <div className="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                  <div
                                    className="h-full rounded-full"
                                    style={{
                                      width: `${month.utilization}%`,
                                      backgroundColor: month.utilization >= 85 ? '#22c55e' : month.utilization >= 70 ? '#f59e0b' : '#ef4444'
                                    }}
                                  />
                                </div>
                                <span className="text-xs">{month.utilization}%</span>
                              </div>
                            </td>
                            <td className="px-3 py-2 text-right text-red-600">
                              ${month.opportunityCost.toLocaleString()}
                            </td>
                            <td className="px-3 py-2 text-center">
                              {month.revenueChange !== null ? (
                                <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                  month.revenueChange > 0 ? 'bg-green-100 text-green-700' :
                                  month.revenueChange < 0 ? 'bg-red-100 text-red-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {month.revenueChange > 0 ? '‚Üë' : month.revenueChange < 0 ? '‚Üì' : '‚Üí'}
                                  {Math.abs(month.revenueChange)}%
                                </span>
                              ) : (
                                <span className="text-gray-400">‚Äî</span>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    <div className="text-4xl mb-2">üìÖ</div>
                    <p>Need data from multiple months to show comparison.</p>
                  </div>
                )}
              </div>

              {/* Trend Insight */}
              {monthlyComparison.length >= 2 && (
                <div className={`rounded-lg p-4 ${
                  monthlyComparison[monthlyComparison.length - 1]?.revenueChange > 0
                    ? 'bg-green-50 border border-green-200'
                    : 'bg-amber-50 border border-amber-200'
                }`}>
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">
                      {monthlyComparison[monthlyComparison.length - 1]?.revenueChange > 0 ? 'üìà' : 'üìâ'}
                    </span>
                    <div>
                      <h4 className={`font-semibold ${
                        monthlyComparison[monthlyComparison.length - 1]?.revenueChange > 0
                          ? 'text-green-800'
                          : 'text-amber-800'
                      }`}>
                        {monthlyComparison[monthlyComparison.length - 1]?.revenueChange > 0
                          ? 'Revenue Growing'
                          : 'Revenue Declining'}
                      </h4>
                      <p className={`text-sm mt-1 ${
                        monthlyComparison[monthlyComparison.length - 1]?.revenueChange > 0
                          ? 'text-green-700'
                          : 'text-amber-700'
                      }`}>
                        Latest month shows {Math.abs(monthlyComparison[monthlyComparison.length - 1]?.revenueChange || 0)}%
                        {monthlyComparison[monthlyComparison.length - 1]?.revenueChange > 0 ? ' increase' : ' decrease'}
                        in average daily revenue compared to the previous month.
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ===== TRUCK ROI ANALYSIS ===== */}
          {activeReport === 'roi' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h3 className="text-md font-semibold text-gray-800 mb-2">Truck ROI Analysis</h3>
                <p className="text-sm text-gray-500 mb-4">
                  Evaluate each truck's return on investment. ROI Score combines utilization (60%) and revenue performance (40%).
                </p>

                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-3 py-2 text-left">Truck</th>
                        <th className="px-3 py-2 text-left">Status</th>
                        <th className="px-3 py-2 text-center">ROI Score</th>
                        <th className="px-3 py-2 text-center">Utilization</th>
                        <th className="px-3 py-2 text-right">Avg Rev/Day</th>
                        <th className="px-3 py-2 text-right">Total Revenue</th>
                        <th className="px-3 py-2 text-right">Opp. Cost</th>
                        <th className="px-3 py-2 text-right">Net Contribution</th>
                      </tr>
                    </thead>
                    <tbody>
                      {truckROI.map((truck, idx) => (
                        <tr key={truck.truckId} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-3 py-2">
                            <span className="font-mono font-medium">#{truck.truckId}</span>
                            {truck.currentDriver && (
                              <span className="text-gray-500 text-xs ml-2">{truck.currentDriver}</span>
                            )}
                          </td>
                          <td className="px-3 py-2">
                            <span
                              className="px-2 py-0.5 rounded text-xs font-medium"
                              style={{
                                backgroundColor: `${STATUS_COLORS[truck.currentStatus]}20`,
                                color: STATUS_COLORS[truck.currentStatus]
                              }}
                            >
                              {truck.currentStatus || 'Unknown'}
                            </span>
                          </td>
                          <td className="px-3 py-2 text-center">
                            <div className="inline-flex items-center justify-center w-12 h-12 rounded-full font-bold text-white" style={{
                              backgroundColor: truck.roiScore >= 80 ? '#22c55e' :
                                              truck.roiScore >= 60 ? '#f59e0b' :
                                              truck.roiScore >= 40 ? '#ef4444' : '#9ca3af'
                            }}>
                              {truck.roiScore}
                            </div>
                          </td>
                          <td className="px-3 py-2 text-center">
                            <div className="flex items-center justify-center gap-2">
                              <div className="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div
                                  className="h-full rounded-full"
                                  style={{
                                    width: `${truck.utilization}%`,
                                    backgroundColor: truck.utilization >= 90 ? '#22c55e' : truck.utilization >= 70 ? '#f59e0b' : '#ef4444'
                                  }}
                                />
                              </div>
                              <span className="text-xs w-8">{truck.utilization}%</span>
                            </div>
                          </td>
                          <td className="px-3 py-2 text-right">
                            {truck.avgDailyRevenue > 0 ? (
                              <span className={truck.avgDailyRevenue >= DAILY_GOAL ? 'text-green-600' : 'text-amber-600'}>
                                ${truck.avgDailyRevenue.toLocaleString()}
                              </span>
                            ) : (
                              <span className="text-gray-400">‚Äî</span>
                            )}
                          </td>
                          <td className="px-3 py-2 text-right font-medium text-green-600">
                            ${truck.totalRevenue.toLocaleString()}
                          </td>
                          <td className="px-3 py-2 text-right text-red-600">
                            {truck.opportunityCost > 0 ? `-$${truck.opportunityCost.toLocaleString()}` : '‚Äî'}
                          </td>
                          <td className="px-3 py-2 text-right font-bold" style={{
                            color: truck.netContribution >= 0 ? '#22c55e' : '#ef4444'
                          }}>
                            {truck.netContribution >= 0 ? '' : '-'}${Math.abs(truck.netContribution).toLocaleString()}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-gray-100">
                      <tr>
                        <td className="px-3 py-2 font-semibold" colSpan="5">Fleet Totals</td>
                        <td className="px-3 py-2 text-right font-bold text-green-600">
                          ${truckROI.reduce((s, t) => s + t.totalRevenue, 0).toLocaleString()}
                        </td>
                        <td className="px-3 py-2 text-right font-bold text-red-600">
                          -${truckROI.reduce((s, t) => s + t.opportunityCost, 0).toLocaleString()}
                        </td>
                        <td className="px-3 py-2 text-right font-bold" style={{
                          color: truckROI.reduce((s, t) => s + t.netContribution, 0) >= 0 ? '#22c55e' : '#ef4444'
                        }}>
                          ${truckROI.reduce((s, t) => s + t.netContribution, 0).toLocaleString()}
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              {/* ROI Insights */}
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                  <h4 className="font-semibold text-green-800 mb-2">üèÜ Top Performers</h4>
                  <div className="space-y-2">
                    {truckROI.slice(0, 3).map((truck, idx) => (
                      <div key={truck.truckId} className="flex justify-between text-sm">
                        <span className="text-green-700">#{truck.truckId}</span>
                        <span className="font-medium text-green-800">ROI: {truck.roiScore}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <h4 className="font-semibold text-red-800 mb-2">‚ö†Ô∏è Needs Attention</h4>
                  <div className="space-y-2">
                    {truckROI.slice(-3).reverse().map((truck, idx) => (
                      <div key={truck.truckId} className="flex justify-between text-sm">
                        <span className="text-red-700">#{truck.truckId}</span>
                        <span className="font-medium text-red-800">ROI: {truck.roiScore}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // MAIN DASHBOARD COMPONENT
    // ============================================
    function CTLDashboard() {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [loading, setLoading] = useState(true);
      const [syncing, setSyncing] = useState(false);
      const [connectionStatus, setConnectionStatus] = useState('checking');
      const [saveStatus, setSaveStatus] = useState('');
      const dashboardRef = useRef(null);
      const statusTimeoutRef = useRef(null);

      // Confirmation modal state
      const [confirmModal, setConfirmModal] = useState({ isOpen: false, truckIndex: null, truckId: '' });

      // Report date - use Central Time
      const getCentralDate = () => {
        const now = new Date();
        return now.toLocaleDateString('en-CA', { timeZone: 'America/Chicago' }); // en-CA gives YYYY-MM-DD format
      };
      const [reportDate, setReportDate] = useState(getCentralDate);
      const reportMonth = useMemo(() => {
        const d = new Date(reportDate);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      }, [reportDate]);

      // Core data
      const [shipments, setShipments] = useState([]);
      const [shipmentsDataDate, setShipmentsDataDate] = useState(null); // Track when shipment data was uploaded
      const [dailyLogs, setDailyLogs] = useState([]);

      // Warnings and alerts
      const [missingTrucks, setMissingTrucks] = useState([]); // Truck IDs in TORO data but not in fleet
      const [pendingLogOverride, setPendingLogOverride] = useState(null); // Date being overridden, if any

      // ============================================
      // MONTHLY PROFITABILITY MODULE STATE
      // ============================================
      const [profitabilityMonth, setProfitabilityMonth] = useState(''); // 'YYYY-MM' format
      const [profitabilitySubTab, setProfitabilitySubTab] = useState('uploads');
      const [fuelData, setFuelData] = useState([]); // Parsed fuel CSV data
      const [expenseData, setExpenseData] = useState([]); // Parsed expense CSV data
      const [profitabilityToro, setProfitabilityToro] = useState([]); // TORO data for profitability month
      const [truckFixedCosts, setTruckFixedCosts] = useState({}); // {truckId: {pi, piExpires, liability, liabilityExpires, damage, damageExpires, tolls}}
      const [settingsSubTab, setSettingsSubTab] = useState('goals');
      const [icFixedCosts, setICFixedCosts] = useState({ mode: 'fleet', fleetCosts: { trailerIns: 0, rental: 0, tolls: 0 }, carrierCosts: {} });
      const [monthsClosed, setMonthsClosed] = useState([]); // Array of closed month strings
      const [profitabilitySaving, setProfitabilitySaving] = useState(false);

      // Fleet - array of trucks with their properties
      // NOTE: Truck IDs use your internal naming (with leading zeros like 000, 007)
      // ownershipType: 'Company' = company-owned truck, 'Owner-Operator' = O/O truck
      const [fleet, setFleet] = useState([
        { id: '205', ownershipType: 'Company', driver: '', notes: '' },
        { id: '1970', ownershipType: 'Company', driver: 'Robert Brewer', notes: '' },
        { id: '1225', ownershipType: 'Company', driver: 'Earl Bibbs', notes: '' },
        { id: '555', ownershipType: 'Company', driver: 'Don Kernan', notes: '' },
        { id: '1776', ownershipType: 'Company', driver: 'Delvin Hale', notes: '' },
        { id: '000', ownershipType: 'Company', driver: 'Cordarius Williams', notes: '' },
        { id: '001', ownershipType: 'Company', driver: '', notes: '' },
        { id: '007', ownershipType: 'Company', driver: 'Tyson Magitt', notes: '' },
        { id: '009', ownershipType: 'Company', driver: 'Steven Hill', notes: '' },
        { id: '0057', ownershipType: 'Company', driver: '', notes: '' },
        { id: '3932', ownershipType: 'Company', driver: 'Rodricus Barnett', notes: '' },
        { id: '4649', ownershipType: 'Company', driver: '', notes: '' },
        { id: '8463', ownershipType: 'Company', driver: 'Jonathan Emison', notes: '' },
        { id: '9239', ownershipType: 'Company', driver: '', notes: '' },
      ]);

      // Truck status (keyed by truck ID)
      const [truckStatus, setTruckStatus] = useState({});
      const [truckExpectedReturn, setTruckExpectedReturn] = useState({});

      // Monthly plan - per-truck goal settings for the month
      const [monthlyPlan, setMonthlyPlan] = useState({});

      // Global goals (defaults)
      const [goals, setGoals] = useState({
        workdaysInMonth: 22,
        dailyRevenuePerTruck: 940,
        dailyMilesPerTruck: 412,
        targetRevPerTotalMile: 2.28,
        targetRevPerLoadedMile: 2.75,
        targetUtilization: 0.85,
        dailyICGrossMargin: 150,
        targetICGrossMarginPct: 15,
      });

      const statusOptions = ['Active', 'Shop - Routine', 'Shop - Break/Fix', 'Needs Driver', 'Spare'];
      const ownershipTypes = ['Company', 'Owner-Operator'];
      const trailerTypes = ['Van', 'Flatbed', 'Unknown'];

      // ============================================
      // HELPER: Update a single fleet truck field immutably
      // ============================================
      const updateFleetField = useCallback((index, field, value) => {
        setFleet(prev => prev.map((truck, i) =>
          i === index ? { ...truck, [field]: value } : truck
        ));
      }, []);

      // ============================================
      // LOAD DATA ON MOUNT
      // ============================================
      useEffect(() => {
        async function loadData() {
          setLoading(true);
          const result = await SheetsDB.readAll();
          const data = result.data || {};

          if (data.Fleet?.length > 0) {
            // Normalize fleet data - ensure ownershipType has default value
            setFleet(data.Fleet.map(t => ({
              ...t,
              ownershipType: t.ownershipType || 'Company'
            })));
          }
          if (data.Goals) setGoals(prev => ({ ...prev, ...data.Goals }));
          // Shipments now stored as { dataDate, shipments } object
          if (data.Shipments) {
            if (data.Shipments.shipments) {
              // New format with date tracking
              setShipments(data.Shipments.shipments);
              setShipmentsDataDate(data.Shipments.dataDate || null);
            } else if (Array.isArray(data.Shipments)) {
              // Old format (just array) - no date available
              setShipments(data.Shipments);
              setShipmentsDataDate(null);
            }
          }
          if (data.DailyLogs) {
            // Ensure DailyLogs is always an array
            const logs = Array.isArray(data.DailyLogs) ? data.DailyLogs : [];
            setDailyLogs(logs);
          }
          if (data.MonthlyPlan) setMonthlyPlan(data.MonthlyPlan);
          if (data.TruckStatus) {
            setTruckStatus(data.TruckStatus.status || {});
            setTruckExpectedReturn(data.TruckStatus.expectedReturn || {});
          }

          // Load profitability data
          if (data.TruckFixedCosts) setTruckFixedCosts(data.TruckFixedCosts);
          if (data.ICFixedCosts) setICFixedCosts(data.ICFixedCosts);
          if (data.MonthsClosed) setMonthsClosed(Array.isArray(data.MonthsClosed) ? data.MonthsClosed : []);

          setConnectionStatus(result.source === 'sheets' ? 'connected' : 'offline');
          setLoading(false);
        }
        loadData();
      }, []);

      // Set report date to most recent log date when dailyLogs loads
      useEffect(() => {
        if (dailyLogs && dailyLogs.length > 0) {
          // dailyLogs are sorted oldest to newest, so get the last one
          const mostRecentLog = dailyLogs[dailyLogs.length - 1];
          if (mostRecentLog && mostRecentLog.date) {
            setReportDate(mostRecentLog.date);
          }
        }
      }, [dailyLogs]);

      // ============================================
      // HELPER: Get truck's monthly plan
      // ============================================
      const getTruckPlan = useCallback((truckId) => {
        const key = `${reportMonth}_${truckId}`;
        const plan = monthlyPlan[key];
        if (plan) return plan;
        // Default: included full month with global targets
        return {
          included: truckStatus[truckId] !== 'Spare',
          startDate: `${reportMonth}-01`,
          endDate: null, // null means end of month
          dailyRevenue: goals.dailyRevenuePerTruck,
          dailyMiles: goals.dailyMilesPerTruck,
        };
      }, [monthlyPlan, reportMonth, truckStatus, goals]);

      const setTruckPlan = useCallback((truckId, updates) => {
        const key = `${reportMonth}_${truckId}`;
        setMonthlyPlan(prev => ({
          ...prev,
          [key]: { ...getTruckPlan(truckId), ...updates }
        }));
      }, [reportMonth, getTruckPlan]);

      // ============================================
      // COMPUTED: Workdays calculation
      // ============================================
      const workdaysCalc = useMemo(() => {
        // Parse date parts directly to avoid timezone issues
        // (new Date("2025-02-03") parses as UTC, causing off-by-one in local time)
        const dateParts = reportDate.split('-');
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // 0-indexed for Date constructor
        const currentDay = parseInt(dateParts[2]);
        const lastDay = new Date(year, month + 1, 0).getDate();

        let totalWorkdays = 0;
        let workdaysElapsed = 0;

        for (let day = 1; day <= lastDay; day++) {
          const d = new Date(year, month, day);
          const isWeekday = d.getDay() !== 0 && d.getDay() !== 6;
          if (isWeekday) {
            totalWorkdays++;
            // Compare day numbers directly - reportDate represents END of that day (completed)
            if (day <= currentDay) workdaysElapsed++;
          }
        }

        return {
          total: goals.workdaysInMonth || totalWorkdays,
          elapsed: workdaysElapsed,
          percent: workdaysElapsed / (goals.workdaysInMonth || totalWorkdays),
        };
      }, [reportDate, goals.workdaysInMonth]);

      // ============================================
      // COMPUTED: Per-truck goals for the month
      // ============================================
      const truckGoals = useMemo(() => {
        const result = {};
        const year = new Date(reportDate).getFullYear();
        const month = new Date(reportDate).getMonth();

        fleet.forEach(truck => {
          const plan = getTruckPlan(truck.id);
          if (!plan.included) {
            result[truck.id] = { included: false, workdays: 0, revenueGoal: 0, milesGoal: 0 };
            return;
          }

          // Calculate workdays for this truck
          const startDate = plan.startDate ? new Date(plan.startDate) : new Date(year, month, 1);
          const endDate = plan.endDate ? new Date(plan.endDate) : new Date(year, month + 1, 0);
          const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

          let truckWorkdays = 0;
          for (let day = 1; day <= lastDayOfMonth; day++) {
            const d = new Date(year, month, day);
            const isWeekday = d.getDay() !== 0 && d.getDay() !== 6;
            if (isWeekday && d >= startDate && d <= endDate) {
              truckWorkdays++;
            }
          }

          const dailyRev = plan.dailyRevenue || goals.dailyRevenuePerTruck;
          const dailyMi = plan.dailyMiles || goals.dailyMilesPerTruck;

          result[truck.id] = {
            included: true,
            workdays: truckWorkdays,
            revenueGoal: truckWorkdays * dailyRev,
            milesGoal: truckWorkdays * dailyMi,
            dailyRevenue: dailyRev,
            dailyMiles: dailyMi,
            startDate: plan.startDate,
            endDate: plan.endDate,
          };
        });

        return result;
      }, [fleet, getTruckPlan, reportDate, goals]);

      // ============================================
      // COMPUTED: Total monthly goals (sum of truck goals)
      // ============================================
      const totalGoals = useMemo(() => {
        let revenueGoal = 0;
        let milesGoal = 0;
        let trucksIncluded = 0;

        Object.values(truckGoals).forEach(tg => {
          if (tg.included) {
            revenueGoal += tg.revenueGoal;
            milesGoal += tg.milesGoal;
            trucksIncluded++;
          }
        });

        const icGMGoal = goals.dailyICGrossMargin * workdaysCalc.total;

        // Total revenue goal = Company Revenue + IC Revenue (not IC GM)
        // We need a daily IC revenue goal - estimate from GM goal assuming target margin %
        const icRevenueGoal = goals.targetICGrossMarginPct > 0
          ? (icGMGoal / goals.targetICGrossMarginPct) * 100
          : icGMGoal * 5; // Fallback: assume ~20% margin
        const totalRevenueGoal = revenueGoal + icRevenueGoal;

        return {
          revenue: revenueGoal,
          miles: milesGoal,
          trucksIncluded,
          revenuePacing: revenueGoal * workdaysCalc.percent,
          milesPacing: milesGoal * workdaysCalc.percent,
          icGrossMargin: icGMGoal,
          icGMPacing: goals.dailyICGrossMargin * workdaysCalc.elapsed,
          icRevenue: icRevenueGoal,
          icRevenuePacing: icRevenueGoal * workdaysCalc.percent,
          totalRevenue: totalRevenueGoal,
          totalRevenuePacing: totalRevenueGoal * workdaysCalc.percent,
        };
      }, [truckGoals, goals, workdaysCalc]);

      // ============================================
      // COMPUTED: Company truck metrics
      // ============================================
      const companyMetrics = useMemo(() => {
        // Note: No date filtering needed here - TORO export already contains only
        // shipments delivering in the target month. Report date is only used for
        // calculating % through the month for pacing purposes.
        const companyShipments = shipments.filter(s => !s.isIC);

        const totalRevenue = companyShipments.reduce((sum, s) => sum + (s.revenue || 0), 0);
        const totalMiles = companyShipments.reduce((sum, s) => sum + (s.totalMiles || 0), 0);
        const loadedMiles = companyShipments.reduce((sum, s) => sum + (s.loadedMiles || 0), 0);

        return {
          totalRevenue,
          totalMiles,
          loadedMiles,
          loadCount: companyShipments.length,
          revPerTotalMile: totalMiles > 0 ? totalRevenue / totalMiles : 0,
          revPerLoadedMile: loadedMiles > 0 ? totalRevenue / loadedMiles : 0,
          utilization: totalMiles > 0 ? loadedMiles / totalMiles : 0,
          shipments: companyShipments,
        };
      }, [shipments]);

      // ============================================
      // COMPUTED: Per-truck metrics
      // ============================================
      const truckMetrics = useMemo(() => {
        const byTruck = {};
        companyMetrics.shipments.forEach(s => {
          const truckId = normalizeTruckId(s.truck);
          if (!truckId) return;
          if (!byTruck[truckId]) {
            byTruck[truckId] = { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0 };
          }
          byTruck[truckId].revenue += s.revenue || 0;
          byTruck[truckId].totalMiles += s.totalMiles || 0;
          byTruck[truckId].loadedMiles += s.loadedMiles || 0;
          byTruck[truckId].loads += 1;
        });

        // Calculate rates
        Object.keys(byTruck).forEach(id => {
          const t = byTruck[id];
          t.revPerTotalMile = t.totalMiles > 0 ? t.revenue / t.totalMiles : 0;
          t.revPerLoadedMile = t.loadedMiles > 0 ? t.revenue / t.loadedMiles : 0;
          t.utilization = t.totalMiles > 0 ? t.loadedMiles / t.totalMiles : 0;
        });

        return byTruck;
      }, [companyMetrics.shipments]);

      // ============================================
      // COMPUTED: IC metrics
      // ============================================
      const icMetrics = useMemo(() => {
        // Note: No date filtering needed - TORO export already contains only
        // shipments delivering in the target month.
        const icShipments = shipments.filter(s => s.isIC);

        const byCarrier = {};
        icShipments.forEach(s => {
          const carrier = s.carrier || 'Unknown';
          if (!byCarrier[carrier]) {
            byCarrier[carrier] = { carrier, revenue: 0, cost: 0, grossProfit: 0, loads: 0 };
          }
          byCarrier[carrier].revenue += s.revenue || 0;
          byCarrier[carrier].grossProfit += s.grossProfit || 0;
          byCarrier[carrier].cost += (s.revenue || 0) - (s.grossProfit || 0);
          byCarrier[carrier].loads += 1;
        });

        const carriers = Object.values(byCarrier).map(c => ({
          ...c,
          grossMargin: c.revenue > 0 ? (c.grossProfit / c.revenue) * 100 : 0,
        })).sort((a, b) => b.revenue - a.revenue);

        const totalRevenue = icShipments.reduce((sum, s) => sum + (s.revenue || 0), 0);
        const totalGrossProfit = icShipments.reduce((sum, s) => sum + (s.grossProfit || 0), 0);

        // Count unique IC drivers (some carriers have multiple drivers)
        const uniqueDrivers = new Set();
        icShipments.forEach(s => {
          if (s.driver && s.driver !== 'Unassigned') {
            uniqueDrivers.add(s.driver);
          }
        });

        return {
          totalRevenue,
          totalGrossProfit,
          totalCost: totalRevenue - totalGrossProfit,
          avgGrossMargin: totalRevenue > 0 ? (totalGrossProfit / totalRevenue) * 100 : 0,
          loadCount: icShipments.length,
          carriers,
          driverCount: uniqueDrivers.size,
        };
      }, [shipments]);

      // ============================================
      // COMPUTED: Flagged loads (missing cost data)
      // Flag loads with high margin AND significant revenue
      // These likely have missing driver pay or carrier cost
      // ============================================
      const flaggedLoads = useMemo(() => {
        return shipments.filter(s => {
          if (!s.revenue || s.revenue <= CONSTANTS.FLAGGED_REVENUE_THRESHOLD) return false;
          // For IC loads, use grossMargin field
          // For company loads, if grossProfit equals revenue, margin is 100%
          const margin = s.grossMargin || (s.revenue > 0 ? (s.grossProfit / s.revenue) * 100 : 0);
          return margin >= CONSTANTS.FLAGGED_MARGIN_THRESHOLD;
        }).map(s => ({
          orderId: s.orderId,
          type: s.isIC ? 'IC' : 'Company',
          truckOrCarrier: s.isIC ? s.carrier : s.truck,
          driver: s.driver || '‚Äî',
          revenue: s.revenue,
          grossProfit: s.grossProfit,
          margin: s.grossMargin || (s.revenue > 0 ? (s.grossProfit / s.revenue) * 100 : 0),
          status: s.status,
          customer: s.customer,
        }));
      }, [shipments]);

      // State for expanding/collapsing flagged loads
      const [showFlaggedLoads, setShowFlaggedLoads] = useState(false);

      // ============================================
      // COMPUTED: Status consistency warnings
      // Check if truck status matches in-transit loads for report date
      // ============================================
      const statusWarnings = useMemo(() => {
        const warnings = [];

        // Helper to parse date strings (handles various formats)
        const parseDate = (dateStr) => {
          if (!dateStr) return null;
          // Try parsing as-is first
          const d = new Date(dateStr);
          if (!isNaN(d.getTime())) {
            // Return just the date part to avoid timezone issues
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          }
          return null;
        };

        // Get report date for comparison
        const reportDateStr = reportDate; // Already in YYYY-MM-DD format

        // Check each fleet truck
        fleet.forEach(truck => {
          const status = truckStatus[truck.id];
          if (!status || status === 'Spare') return; // Skip trucks without status or marked Spare

          // Find loads for this truck that are "in transit" on the report date
          // In transit = pickup date <= report date AND delivery date >= report date
          const inTransitLoads = shipments.filter(s => {
            if (s.isIC || s.truck !== truck.id) return false;

            const pickupDate = parseDate(s.pickupDate);
            const deliveryDate = parseDate(s.deliveryDate);

            if (!pickupDate || !deliveryDate) return false;

            return pickupDate <= reportDateStr && deliveryDate >= reportDateStr;
          });

          const hasInTransitLoads = inTransitLoads.length > 0;
          const loadRevenue = inTransitLoads.reduce((sum, s) => sum + (s.revenue || 0), 0);
          const isActiveStatus = status === 'Active';
          const isShopOrDownStatus = ['Shop - Routine', 'Shop - Break/Fix', 'Needs Driver'].includes(status);

          // Warning: Has loads but not marked Active
          if (hasInTransitLoads && isShopOrDownStatus) {
            warnings.push({
              type: 'has_loads_not_active',
              truckId: truck.id,
              driver: truck.driver,
              currentStatus: status,
              loadCount: inTransitLoads.length,
              loadRevenue,
              message: `Truck #${truck.id} is marked "${status}" but has ${inTransitLoads.length} load${inTransitLoads.length > 1 ? 's' : ''} in transit`,
              suggestedStatus: 'Active',
            });
          }

          // Informational: Marked Active but no loads (softer warning)
          if (isActiveStatus && !hasInTransitLoads) {
            warnings.push({
              type: 'active_no_loads',
              truckId: truck.id,
              driver: truck.driver,
              currentStatus: status,
              loadCount: 0,
              loadRevenue: 0,
              message: `Truck #${truck.id} is marked "Active" but has no loads in transit`,
              suggestedStatus: null, // Just informational
            });
          }
        });

        return warnings;
      }, [fleet, shipments, truckStatus, reportDate]);

      // Filter states for Company Trucks tab
      const [ownershipFilter, setOwnershipFilter] = useState('all'); // 'all', 'Company', 'Owner-Operator'
      const [trailerTypeFilter, setTrailerTypeFilter] = useState('all'); // 'all', 'Van', 'Flatbed'

      // Filtered fleet based on ownership filter
      const filteredFleet = useMemo(() => {
        if (ownershipFilter === 'all') return fleet;
        return fleet.filter(t => t.ownershipType === ownershipFilter);
      }, [fleet, ownershipFilter]);

      // Filtered metrics by trailer type
      const filteredCompanyMetrics = useMemo(() => {
        if (trailerTypeFilter === 'all') return companyMetrics;

        const filteredShipments = companyMetrics.shipments.filter(s => s.trailerType === trailerTypeFilter);
        const totalRevenue = filteredShipments.reduce((sum, s) => sum + (s.revenue || 0), 0);
        const totalMiles = filteredShipments.reduce((sum, s) => sum + (s.totalMiles || 0), 0);
        const loadedMiles = filteredShipments.reduce((sum, s) => sum + (s.loadedMiles || 0), 0);

        return {
          totalRevenue,
          totalMiles,
          loadedMiles,
          loadCount: filteredShipments.length,
          revPerTotalMile: totalMiles > 0 ? totalRevenue / totalMiles : 0,
          revPerLoadedMile: loadedMiles > 0 ? totalRevenue / loadedMiles : 0,
          utilization: totalMiles > 0 ? loadedMiles / totalMiles : 0,
          shipments: filteredShipments,
        };
      }, [companyMetrics, trailerTypeFilter]);

      // Filtered truck metrics (recalculated based on trailer type filter)
      const filteredTruckMetrics = useMemo(() => {
        if (trailerTypeFilter === 'all') return truckMetrics;

        const byTruck = {};
        filteredCompanyMetrics.shipments.forEach(s => {
          const truckId = normalizeTruckId(s.truck);
          if (!truckId) return;
          if (!byTruck[truckId]) {
            byTruck[truckId] = { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0 };
          }
          byTruck[truckId].revenue += s.revenue || 0;
          byTruck[truckId].totalMiles += s.totalMiles || 0;
          byTruck[truckId].loadedMiles += s.loadedMiles || 0;
          byTruck[truckId].loads += 1;
        });

        Object.keys(byTruck).forEach(id => {
          const t = byTruck[id];
          t.revPerTotalMile = t.totalMiles > 0 ? t.revenue / t.totalMiles : 0;
          t.revPerLoadedMile = t.loadedMiles > 0 ? t.revenue / t.loadedMiles : 0;
          t.utilization = t.totalMiles > 0 ? t.loadedMiles / t.totalMiles : 0;
        });

        return byTruck;
      }, [truckMetrics, filteredCompanyMetrics, trailerTypeFilter]);

      // ============================================
      // COMPUTED: Fleet status counts
      // ============================================
      const fleetCounts = useMemo(() => {
        const counts = {};
        statusOptions.forEach(s => counts[s] = 0);
        counts['Unknown'] = 0;

        fleet.forEach(t => {
          const status = truckStatus[t.id] || 'Unknown';
          if (counts[status] !== undefined) counts[status]++;
          else counts['Unknown']++;
        });

        return counts;
      }, [fleet, truckStatus]);

      // ============================================
      // COMPUTED: Fleet status counts by ownership type
      // ============================================
      const fleetCountsByOwnership = useMemo(() => {
        const companyOwned = {};
        const ownerOperator = {};
        statusOptions.forEach(s => {
          companyOwned[s] = 0;
          ownerOperator[s] = 0;
        });
        companyOwned['Unknown'] = 0;
        ownerOperator['Unknown'] = 0;

        fleet.forEach(t => {
          const status = truckStatus[t.id] || 'Unknown';
          const bucket = t.ownershipType === 'Owner-Operator' ? ownerOperator : companyOwned;
          if (bucket[status] !== undefined) bucket[status]++;
          else bucket['Unknown']++;
        });

        // Calculate totals for each ownership type
        const companyTotal = Object.values(companyOwned).reduce((a, b) => a + b, 0);
        const ooTotal = Object.values(ownerOperator).reduce((a, b) => a + b, 0);

        return {
          companyOwned,
          ownerOperator,
          companyTotal,
          ooTotal
        };
      }, [fleet, truckStatus]);

      // ============================================
      // COMPUTED: Metrics by trailer type (from shipments)
      // ============================================
      const metricsByTrailerType = useMemo(() => {
        const van = { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0, grossProfit: 0 };
        const flatbed = { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0, grossProfit: 0 };
        const unknown = { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0, grossProfit: 0 };

        // Process company shipments
        const companyShipments = shipments.filter(s => !s.isIC);
        companyShipments.forEach(s => {
          const bucket = s.trailerType === 'Van' ? van :
                         s.trailerType === 'Flatbed' ? flatbed : unknown;
          bucket.revenue += s.revenue || 0;
          bucket.totalMiles += s.totalMiles || 0;
          bucket.loadedMiles += s.loadedMiles || 0;
          bucket.loads += 1;
          bucket.grossProfit += s.grossProfit || 0;
        });

        // Calculate rates
        [van, flatbed, unknown].forEach(bucket => {
          bucket.revPerTotalMile = bucket.totalMiles > 0 ? bucket.revenue / bucket.totalMiles : 0;
          bucket.revPerLoadedMile = bucket.loadedMiles > 0 ? bucket.revenue / bucket.loadedMiles : 0;
          bucket.utilization = bucket.totalMiles > 0 ? bucket.loadedMiles / bucket.totalMiles : 0;
        });

        return { van, flatbed, unknown };
      }, [shipments]);

      // ============================================
      // STATUS HELPERS
      // ============================================
      const showStatus = useCallback((msg, duration = 2000) => {
        // Clear any existing timeout to prevent memory leaks
        if (statusTimeoutRef.current) {
          clearTimeout(statusTimeoutRef.current);
          statusTimeoutRef.current = null;
        }
        setSaveStatus(msg);
        if (duration > 0) {
          statusTimeoutRef.current = setTimeout(() => {
            setSaveStatus('');
            statusTimeoutRef.current = null;
          }, duration);
        }
      }, []);

      // Cleanup timeout on unmount
      useEffect(() => {
        return () => {
          if (statusTimeoutRef.current) {
            clearTimeout(statusTimeoutRef.current);
          }
        };
      }, []);

      // ============================================
      // TRUCK REMOVAL WITH CONFIRMATION
      // ============================================
      const requestRemoveTruck = useCallback((index, truckId) => {
        setConfirmModal({ isOpen: true, truckIndex: index, truckId });
      }, []);

      const confirmRemoveTruck = useCallback(() => {
        if (confirmModal.truckIndex !== null) {
          setFleet(prev => prev.filter((_, i) => i !== confirmModal.truckIndex));
          showStatus(`Truck ${confirmModal.truckId || 'removed'} removed`, 2000);
        }
        setConfirmModal({ isOpen: false, truckIndex: null, truckId: '' });
      }, [confirmModal, showStatus]);

      const cancelRemoveTruck = useCallback(() => {
        setConfirmModal({ isOpen: false, truckIndex: null, truckId: '' });
      }, []);

      // ============================================
      // CSV UPLOAD - Handles split orders
      // ============================================
      const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showStatus('Processing file...', 0);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: async (results) => {
            const parsed = [];
            let splitCount = 0;

            results.data.forEach(row => {
              // Skip summary/total rows (TORO exports include a Total row at the bottom)
              if (row['Group'] === 'Total' || !row['Order #']) return;

              const carrierRaw = row['Carrier'] || '';
              const driverRaw = row['Driver'] || '';
              const truckRaw = row['Truck']?.toString() || '';

              // Parse Commodities column for trailer type
              const commodities = row['Commodities'] || row['Commodity'] || '';
              const commoditiesLower = commodities.toLowerCase();
              let trailerType = 'Unknown';
              if (commoditiesLower.includes('van') || commoditiesLower.includes('fak-v')) {
                trailerType = 'Van';
              } else if (commoditiesLower.includes('flatbed') || commoditiesLower.includes('flat') || commoditiesLower.includes('conestoga')) {
                trailerType = 'Flatbed';
              }

              const carriers = carrierRaw.split(',').map(s => s.trim()).filter(Boolean);
              const drivers = driverRaw.split(',').map(s => s.trim()).filter(Boolean);
              const trucks = truckRaw.split(',').map(s => s.trim()).filter(Boolean);

              const numLegs = Math.max(carriers.length, trucks.length, 1);

              const totalRevenue = parseFloat(row['Revenue']?.replace(/[$,]/g, '')) || 0;
              const totalMilesVal = parseFloat(row['Total Miles']?.replace(/[, mi]/g, '')) || 0;
              const loadedMilesVal = parseFloat(row['Loaded Miles']?.replace(/[, mi]/g, '')) || 0;
              const grossProfitVal = parseFloat(row['Gross Profit']?.replace(/[$,]/g, '')) || 0;

              if (numLegs === 1) {
                const carrierVal = carriers[0] || '';
                const driver = drivers[0] || '';
                const truckVal = trucks[0] || '';
                const carrier = carrierVal === 'Unassigned' ? '' : carrierVal;
                const truck = normalizeTruckId(truckVal);
                const isIC = carrier && !truck;

                parsed.push({
                  orderId: row['Order #'],
                  carrier, truck, driver,
                  status: row['Status'],
                  revenue: totalRevenue, totalMiles: totalMilesVal,
                  loadedMiles: loadedMilesVal, grossProfit: grossProfitVal,
                  grossMargin: parseFloat(row['Gross Profit Margin']) || 0,
                  pickupDate: row['Sch. Pickup Date'],
                  deliveryDate: row['Sch. Delivery Date'],
                  customer: row['Customer'],
                  isIC, splitOrder: false,
                  trailerType, commodities,
                });
              } else {
                splitCount++;
                const perLeg = {
                  revenue: totalRevenue / numLegs,
                  miles: totalMilesVal / numLegs,
                  loadedMiles: loadedMilesVal / numLegs,
                  grossProfit: grossProfitVal / numLegs,
                };

                for (let i = 0; i < numLegs; i++) {
                  const carrierVal = carriers[i] || carriers[0] || '';
                  const driver = drivers[i] || drivers[0] || '';
                  const truckVal = trucks[i] || '';
                  const carrier = carrierVal === 'Unassigned' ? '' : carrierVal;
                  const truck = normalizeTruckId(truckVal);
                  const isIC = carrier && !truck;

                  parsed.push({
                    orderId: `${row['Order #']}-L${i + 1}`,
                    originalOrderId: row['Order #'],
                    carrier, truck, driver,
                    status: row['Status'],
                    revenue: perLeg.revenue, totalMiles: perLeg.miles,
                    loadedMiles: perLeg.loadedMiles, grossProfit: perLeg.grossProfit,
                    grossMargin: parseFloat(row['Gross Profit Margin']) || 0,
                    pickupDate: row['Sch. Pickup Date'],
                    deliveryDate: row['Sch. Delivery Date'],
                    customer: row['Customer'],
                    isIC, splitOrder: true, legNumber: i + 1, totalLegs: numLegs,
                    trailerType, commodities,
                  });
                }
              }
            });

            // Exclude Pending and Canceled loads - include all other statuses
            const excludedStatuses = ['Pending', 'Canceled'];
            const filtered = parsed.filter(s => !excludedStatuses.includes(s.status));
            setShipments(filtered);
            setShipmentsDataDate(reportDate); // Track when this data was uploaded

            // Check for trucks in TORO data that aren't in fleet (company trucks only)
            const fleetTruckIds = new Set(fleet.map(t => t.id));
            const toroTruckIds = new Set(filtered.filter(s => s.truck && !s.isIC).map(s => s.truck));
            const missing = [...toroTruckIds].filter(id => !fleetTruckIds.has(id));
            setMissingTrucks(missing);

            const msg = splitCount > 0
              ? `${filtered.length} shipments loaded (${splitCount} split orders)`
              : `${filtered.length} shipments loaded`;
            showStatus(msg + (missing.length > 0 ? ` ‚ö† ${missing.length} unknown trucks` : ' ‚úì'), 3000);
          }
        });

        event.target.value = '';
      };

      // ============================================
      // PROFITABILITY: TORO Upload Handler
      // ============================================
      const handleProfitabilityToroUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showStatus('Processing TORO data for profitability...', 0);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            const parsed = [];
            results.data.forEach(row => {
              if (!row['Order #'] || row['Order #'] === 'Total') return;

              const status = row['Status'] || '';
              if (['Pending', 'Canceled'].includes(status)) return;

              // Parse values
              const revenue = parseFloat(row['Revenue']?.replace(/[$,]/g, '')) || 0;
              const grossProfit = parseFloat(row['Gross Profit']?.replace(/[$,]/g, '')) || 0;
              const totalMiles = parseFloat(row['Total Miles']?.replace(/,/g, '')) || 0;
              const loadedMiles = parseFloat(row['Loaded Miles']?.replace(/,/g, '')) || 0;

              // Get truck/carrier info
              const trucks = (row['Truck'] || '').split(',').map(s => s.trim()).filter(Boolean);
              const carriers = (row['Carrier'] || '').split(',').map(s => s.trim()).filter(Boolean);
              const trailer = (row['Trailer'] || '').split(',')[0].trim();

              // Determine trailer type from Commodities
              const commodities = row['Commodities'] || '';
              const commoditiesLower = commodities.toLowerCase();
              let trailerType = 'Unknown';
              if (commoditiesLower.includes('van') || commoditiesLower.includes('fak-v')) {
                trailerType = 'Van';
              } else if (commoditiesLower.includes('flatbed') || commoditiesLower.includes('flat') || commoditiesLower.includes('conestoga')) {
                trailerType = 'Flatbed';
              }

              // Determine if IC (carrier present, no truck)
              const truck = trucks[0] ? normalizeTruckId(trucks[0]) : '';
              const carrier = carriers[0] || '';
              const isIC = carrier && carrier !== 'Unassigned' && !truck;

              parsed.push({
                orderId: row['Order #'],
                truck,
                carrier,
                trailer,
                trailerType,
                commodities,
                revenue,
                grossProfit,
                driverPay: revenue - grossProfit,
                totalMiles,
                loadedMiles,
                status,
                isIC,
                pickupDate: row['Sch. Pickup Date'] || '',
                deliveryDate: row['Sch. Delivery Date'] || '',
              });
            });

            // Filter to selected month by delivery date
            const monthFiltered = parsed.filter(s => {
              const deliveryDate = s.deliveryDate || '';
              // Handle format like "1/30/26, 15:00 CST"
              const datePart = deliveryDate.split(',')[0];
              if (!datePart) return false;
              const parts = datePart.split('/');
              if (parts.length < 3) return false;
              const month = parseInt(parts[0]);
              const year = parseInt(parts[2]) + 2000; // Handle 2-digit year
              const shipmentMonth = `${year}-${String(month).padStart(2, '0')}`;
              return shipmentMonth === profitabilityMonth;
            });

            setProfitabilityToro(monthFiltered);
            showStatus(`Loaded ${monthFiltered.length} shipments for ${profitabilityMonth} ‚úì`, 3000);
          }
        });

        event.target.value = '';
      };

      // ============================================
      // PROFITABILITY: Fuel CSV Upload Handler
      // ============================================
      const handleFuelUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showStatus('Processing fuel data...', 0);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            const parsed = [];
            results.data.forEach(row => {
              const truckNumber = row['Truck Number'];
              if (!truckNumber) return;

              const fuelCost = parseFloat(row['Fuel Cost']?.replace(/[$,]/g, '')) || 0;
              const fuel2Cost = parseFloat(row['Fuel 2 Cost']?.replace(/[$,]/g, '')) || 0;
              const otherCost = parseFloat(row['Other Cost']?.replace(/[$,]/g, '')) || 0;
              const gallons = parseFloat(row['Fuel Gallons']?.replace(/,/g, '')) || 0;

              parsed.push({
                truckNumber: normalizeTruckId(truckNumber),
                date: row['Date'] || '',
                fuelCost,
                fuel2Cost,
                otherCost,
                totalCost: fuelCost + fuel2Cost + otherCost,
                gallons,
                merchant: row['Merchant Name'] || '',
                city: row['City'] || '',
                state: row['State/Province'] || '',
              });
            });

            // Filter to selected month
            const monthFiltered = parsed.filter(f => {
              const date = f.date;
              if (!date) return false;
              // Handle format like "2026-01-30" or "1/30/26"
              let year, month;
              if (date.includes('-')) {
                const parts = date.split('-');
                year = parseInt(parts[0]);
                month = parseInt(parts[1]);
              } else if (date.includes('/')) {
                const parts = date.split('/');
                month = parseInt(parts[0]);
                year = parseInt(parts[2]);
                if (year < 100) year += 2000;
              } else {
                return false;
              }
              const fuelMonth = `${year}-${String(month).padStart(2, '0')}`;
              return fuelMonth === profitabilityMonth;
            });

            setFuelData(monthFiltered);
            const totalCost = monthFiltered.reduce((sum, f) => sum + f.totalCost, 0);
            showStatus(`Loaded ${monthFiltered.length} fuel transactions (${fmtCurrency(totalCost)}) ‚úì`, 3000);
          }
        });

        event.target.value = '';
      };

      // ============================================
      // PROFITABILITY: Expense CSV Upload Handler
      // ============================================
      const handleExpenseUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showStatus('Processing expense data...', 0);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            const parsed = [];
            results.data.forEach(row => {
              const amount = parseFloat(row['Amount']?.replace(/[$,]/g, '')) || 0;
              if (!amount) return;

              // Parse attributions - handle various column names
              const truckAttrRaw = row['Truck Attributions'] || row['Truck Attribution'] || '';
              const trailerAttrRaw = row['Trailer Attributions'] || row['Trailer Attribution'] || '';
              const driverAttrRaw = row['Driver Attributions'] || row['Driver Attribution'] || '';

              const truckAttr = truckAttrRaw.split(',').map(s => normalizeTruckId(s.trim())).filter(Boolean);
              const trailerAttr = trailerAttrRaw.split(',').map(s => s.trim()).filter(Boolean);
              const driverAttr = driverAttrRaw.split(',').map(s => s.trim()).filter(Boolean);

              parsed.push({
                expenseId: row['Expense ID (Toro Generated)'] || row['Expense ID'] || '',
                vendor: row['Vendor'] || '',
                expenseDate: row['Expense Date'] || '',
                amount,
                category: row['Expense Category'] || '',
                description: row['Description'] || '',
                truckAttr,
                trailerAttr,
                driverAttr,
              });
            });

            // Filter to selected month
            const monthFiltered = parsed.filter(e => {
              const date = e.expenseDate;
              if (!date) return false;
              // Handle format like "1/30/26"
              const parts = date.split('/');
              if (parts.length < 3) return false;
              const month = parseInt(parts[0]);
              let year = parseInt(parts[2]);
              if (year < 100) year += 2000;
              const expenseMonth = `${year}-${String(month).padStart(2, '0')}`;
              return expenseMonth === profitabilityMonth;
            });

            setExpenseData(monthFiltered);
            const totalAmount = monthFiltered.reduce((sum, e) => sum + e.amount, 0);
            showStatus(`Loaded ${monthFiltered.length} expenses (${fmtCurrency(totalAmount)}) ‚úì`, 3000);
          }
        });

        event.target.value = '';
      };

      // ============================================
      // PROFITABILITY: Warnings Detection
      // ============================================
      const profitabilityWarnings = useMemo(() => {
        const warnings = [];
        const fleetTruckIds = new Set(fleet.map(t => t.id));

        // Warning: Load missing trailer assignment
        profitabilityToro.forEach(load => {
          if (!load.trailer && !load.isIC) {
            warnings.push({
              type: 'missing_trailer',
              severity: 'orange',
              orderId: load.orderId,
              truck: load.truck,
              revenue: load.revenue,
              message: `Load ${load.orderId} (Truck #${load.truck}) has no trailer assignment`
            });
          }
        });

        // Warning: Loads with Unknown trailer type (blank commodities) - RED severity
        const unknownTypeLoads = profitabilityToro.filter(l => l.trailerType === 'Unknown');
        if (unknownTypeLoads.length > 0) {
          const totalRevenue = unknownTypeLoads.reduce((sum, l) => sum + (l.revenue || 0), 0);
          const totalGP = unknownTypeLoads.reduce((sum, l) => sum + (l.grossProfit || 0), 0);
          const orderIds = unknownTypeLoads.slice(0, 5).map(l => l.orderId).join(', ');
          const moreText = unknownTypeLoads.length > 5 ? ` and ${unknownTypeLoads.length - 5} more` : '';
          warnings.push({
            type: 'unknown_trailer_type',
            severity: 'red',
            count: unknownTypeLoads.length,
            revenue: totalRevenue,
            grossProfit: totalGP,
            message: `${unknownTypeLoads.length} load(s) have blank Commodities field - cannot classify as Van or Flatbed`,
            description: `Orders: ${orderIds}${moreText}. Total: ${fmtCurrency(totalRevenue)} revenue, ${fmtCurrency(totalGP)} GP. Please add Commodities (e.g., "FAK - Van Load" or "Flat Bed Load") in TORO.`
          });
        }

        // Warning: Expense with no attribution
        expenseData.forEach((expense, idx) => {
          if (expense.truckAttr.length === 0 && expense.trailerAttr.length === 0 && expense.driverAttr.length === 0) {
            warnings.push({
              type: 'unattributed_expense',
              severity: 'red',
              index: idx,
              amount: expense.amount,
              description: expense.description,
              vendor: expense.vendor,
              message: `Expense ${fmtCurrency(expense.amount)} from ${expense.vendor} has no attribution`
            });
          }
        });

        // Warning: Unknown truck in fuel data
        const fuelTrucks = new Set(fuelData.map(f => f.truckNumber).filter(Boolean));
        fuelTrucks.forEach(truck => {
          if (!fleetTruckIds.has(truck)) {
            const truckFuel = fuelData.filter(f => f.truckNumber === truck);
            const totalCost = truckFuel.reduce((sum, f) => sum + f.totalCost, 0);
            warnings.push({
              type: 'unknown_truck_fuel',
              severity: 'orange',
              truck,
              cost: totalCost,
              message: `Fuel for unknown truck #${truck} (${fmtCurrency(totalCost)})`
            });
          }
        });

        // Warning: Unknown truck in expense data
        expenseData.forEach(expense => {
          expense.truckAttr.forEach(truck => {
            if (truck && !fleetTruckIds.has(truck)) {
              warnings.push({
                type: 'unknown_truck_expense',
                severity: 'orange',
                truck,
                amount: expense.amount,
                message: `Expense attributed to unknown truck #${truck}`
              });
            }
          });
        });

        // Warning: Trailer in expense not found in TORO (deduplicated)
        const toroTrailers = new Set(profitabilityToro.map(l => l.trailer).filter(Boolean));
        const trailerExpensesByTrailer = {};
        expenseData.forEach(expense => {
          expense.trailerAttr.forEach(trailer => {
            if (trailer && !toroTrailers.has(trailer)) {
              if (!trailerExpensesByTrailer[trailer]) {
                trailerExpensesByTrailer[trailer] = { count: 0, totalAmount: 0 };
              }
              trailerExpensesByTrailer[trailer].count += 1;
              trailerExpensesByTrailer[trailer].totalAmount += expense.amount;
            }
          });
        });
        Object.entries(trailerExpensesByTrailer).forEach(([trailer, data]) => {
          warnings.push({
            type: 'unknown_trailer_expense',
            severity: 'orange',
            trailer,
            amount: data.totalAmount,
            message: `${data.count} expense(s) for "${trailer}" (${fmtCurrency(data.totalAmount)}) - trailer not found in TORO data for this month. Costs cannot be allocated to trucks.`
          });
        });

        return warnings;
      }, [fleet, profitabilityToro, fuelData, expenseData]);

      // ============================================
      // FIXED COSTS: Expiration Check
      // ============================================
      const expiredFixedCosts = useMemo(() => {
        const expired = [];
        const expiringSoon = [];

        fleet.filter(t => t.ownershipType !== 'Owner-Operator').forEach(truck => {
          const fc = truckFixedCosts[truck.id] || {};

          // Check P&I expiration
          if (fc.piExpires) {
            const status = getExpirationStatus(fc.piExpires);
            if (status === 'expired') expired.push({ truck: truck.id, type: 'P&I', date: fc.piExpires });
            else if (status === 'warning') expiringSoon.push({ truck: truck.id, type: 'P&I', date: fc.piExpires });
          }

          // Check Liability Insurance expiration
          if (fc.liabilityExpires) {
            const status = getExpirationStatus(fc.liabilityExpires);
            if (status === 'expired') expired.push({ truck: truck.id, type: 'Liability Ins.', date: fc.liabilityExpires });
            else if (status === 'warning') expiringSoon.push({ truck: truck.id, type: 'Liability Ins.', date: fc.liabilityExpires });
          }

          // Check Damage Insurance expiration
          if (fc.damageExpires) {
            const status = getExpirationStatus(fc.damageExpires);
            if (status === 'expired') expired.push({ truck: truck.id, type: 'Damage Ins.', date: fc.damageExpires });
            else if (status === 'warning') expiringSoon.push({ truck: truck.id, type: 'Damage Ins.', date: fc.damageExpires });
          }
        });

        return { expired, expiringSoon, hasExpired: expired.length > 0 };
      }, [fleet, truckFixedCosts]);

      // ============================================
      // PROFITABILITY: Trailer-to-Truck Allocation
      // ============================================
      const trailerAllocation = useMemo(() => {
        // Build map of which trucks pulled which trailers
        const trailerUsage = {}; // {trailerCode: [{orderId, truck, revenue, grossProfit, isIC, carrier}]}

        profitabilityToro.forEach(load => {
          const trailer = load.trailer;
          if (!trailer) return;

          if (!trailerUsage[trailer]) {
            trailerUsage[trailer] = [];
          }
          trailerUsage[trailer].push({
            orderId: load.orderId,
            truck: load.truck || '',
            carrier: load.carrier || '',
            revenue: load.revenue || 0,
            grossProfit: load.grossProfit || 0,
            isIC: load.isIC,
          });
        });

        // For each trailer with expenses, allocate proportionally
        const allocation = {};
        Object.entries(trailerUsage).forEach(([trailer, loads]) => {
          // Find expenses for this trailer
          const trailerExpenses = expenseData.filter(e =>
            e.trailerAttr.some(attr => attr === trailer || attr.includes(trailer.split(' ')[0]))
          );
          const totalExpense = trailerExpenses.reduce((sum, e) => sum + e.amount, 0);

          if (totalExpense === 0) {
            allocation[trailer] = { loads, totalExpense: 0, byTruck: {}, byIC: {} };
            return;
          }

          // Calculate total revenue for this trailer
          const totalRevenue = loads.reduce((sum, l) => sum + l.revenue, 0);

          // Allocate by revenue proportion
          const byTruck = {};
          const byIC = {};
          loads.forEach(load => {
            const proportion = totalRevenue > 0 ? load.revenue / totalRevenue : 1 / loads.length;
            const allocated = totalExpense * proportion;

            if (load.isIC) {
              const carrier = load.carrier || 'Unknown IC';
              byIC[carrier] = (byIC[carrier] || 0) + allocated;
            } else if (load.truck) {
              byTruck[load.truck] = (byTruck[load.truck] || 0) + allocated;
            }
          });

          allocation[trailer] = { loads, totalExpense, byTruck, byIC };
        });

        return allocation;
      }, [profitabilityToro, expenseData]);

      // ============================================
      // PROFITABILITY: Fuel Aggregation by Truck
      // ============================================
      const fuelByTruck = useMemo(() => {
        const byTruck = {};
        fuelData.forEach(f => {
          if (!f.truckNumber) return;
          byTruck[f.truckNumber] = (byTruck[f.truckNumber] || 0) + f.totalCost;
        });
        return byTruck;
      }, [fuelData]);

      // ============================================
      // PROFITABILITY: Direct Truck Expenses
      // ============================================
      const directExpensesByTruck = useMemo(() => {
        const byTruck = {};
        expenseData.forEach(e => {
          if (e.truckAttr.length === 0) return;
          const perTruck = e.amount / e.truckAttr.length;
          e.truckAttr.forEach(truck => {
            byTruck[truck] = (byTruck[truck] || 0) + perTruck;
          });
        });
        return byTruck;
      }, [expenseData]);

      // ============================================
      // PROFITABILITY: Allocated Trailer Maintenance by Truck
      // ============================================
      const allocatedTrailerMaintByTruck = useMemo(() => {
        const byTruck = {};
        Object.values(trailerAllocation).forEach(alloc => {
          Object.entries(alloc.byTruck).forEach(([truck, amount]) => {
            byTruck[truck] = (byTruck[truck] || 0) + amount;
          });
        });
        return byTruck;
      }, [trailerAllocation]);

      // ============================================
      // PROFITABILITY: Full Profit Calculation
      // Organized by: Trailer Type -> Asset Type (Company / Owner-Operator / IC)
      // Gross Profit = Revenue - All Expenses
      // ============================================
      const profitabilityCalc = useMemo(() => {
        const FACTORING_RATE = 0.015; // 1.5%

        // Helper to create empty totals
        const emptyTotals = () => ({
          revenue: 0, driverPay: 0, fuel: 0, truckMaint: 0, trailerMaint: 0,
          fixedCosts: 0, factoring: 0, grossProfit: 0, loads: 0,
        });

        // Helper to sum totals
        const sumTotals = (arr) => arr.reduce((acc, t) => ({
          revenue: acc.revenue + t.revenue,
          driverPay: acc.driverPay + t.driverPay,
          fuel: acc.fuel + (t.fuel || 0),
          truckMaint: acc.truckMaint + (t.truckMaint || 0),
          trailerMaint: acc.trailerMaint + (t.trailerMaint || 0),
          fixedCosts: acc.fixedCosts + t.fixedCosts,
          factoring: acc.factoring + t.factoring,
          grossProfit: acc.grossProfit + t.grossProfit,
          loads: acc.loads + t.loads,
        }), emptyTotals());

        // Build fleet ownership lookup: {truckId: 'Company' | 'Owner-Operator'}
        const fleetOwnership = {};
        fleet.forEach(t => {
          fleetOwnership[t.id] = t.ownershipType || 'Company';
        });

        // Build structure by trailer type - now with THREE asset types
        const trailerTypes = ['Van', 'Flatbed', 'Unknown'];
        const byTrailerType = {};

        trailerTypes.forEach(tt => {
          byTrailerType[tt] = {
            company: { trucks: {}, totals: emptyTotals() },
            ownerOperator: { trucks: {}, totals: emptyTotals() },
            ic: { carriers: {}, totals: emptyTotals() },
            totals: emptyTotals(),
          };
        });

        // Process truck loads by trailer type - route to company or ownerOperator based on fleet
        profitabilityToro.filter(s => !s.isIC).forEach(load => {
          if (!load.truck) return;
          const tt = load.trailerType || 'Unknown';
          const ownership = fleetOwnership[load.truck] || 'Company';
          const section = ownership === 'Owner-Operator'
            ? (byTrailerType[tt]?.ownerOperator || byTrailerType['Unknown'].ownerOperator)
            : (byTrailerType[tt]?.company || byTrailerType['Unknown'].company);

          if (!section.trucks[load.truck]) {
            section.trucks[load.truck] = {
              revenue: 0, driverPay: 0, fuel: 0, truckMaint: 0, trailerMaint: 0,
              fixedCosts: 0, factoring: 0, grossProfit: 0, loads: 0, trailerType: tt,
              ownershipType: ownership,
            };
          }
          section.trucks[load.truck].revenue += load.revenue || 0;
          section.trucks[load.truck].driverPay += load.driverPay || 0;
          section.trucks[load.truck].loads += 1;
        });

        // Add costs to trucks (proportionally split by trailer type based on load count)
        const truckLoadsByType = {}; // {truckId: {Van: n, Flatbed: m, ...}}
        profitabilityToro.filter(s => !s.isIC && s.truck).forEach(load => {
          const tt = load.trailerType || 'Unknown';
          if (!truckLoadsByType[load.truck]) truckLoadsByType[load.truck] = {};
          truckLoadsByType[load.truck][tt] = (truckLoadsByType[load.truck][tt] || 0) + 1;
        });

        // Calculate total loads per truck for proportional allocation
        const truckTotalLoads = {};
        Object.entries(truckLoadsByType).forEach(([truck, byType]) => {
          truckTotalLoads[truck] = Object.values(byType).reduce((a, b) => a + b, 0);
        });

        // Apply costs to each truck/trailer-type combo
        Object.entries(truckLoadsByType).forEach(([truck, byType]) => {
          const totalLoads = truckTotalLoads[truck] || 1;
          const truckFuel = fuelByTruck[truck] || 0;
          const truckMaint = directExpensesByTruck[truck] || 0;
          const truckTrailerMaint = allocatedTrailerMaintByTruck[truck] || 0;
          const fc = truckFixedCosts[truck] || {};
          const truckFixedTotal = (fc.pi || 0) + (fc.liability || 0) + (fc.damage || 0) + (fc.tolls || 0);

          const ownership = fleetOwnership[truck] || 'Company';

          Object.entries(byType).forEach(([tt, loadCount]) => {
            const proportion = loadCount / totalLoads;
            const section = ownership === 'Owner-Operator'
              ? byTrailerType[tt]?.ownerOperator
              : byTrailerType[tt]?.company;
            const rec = section?.trucks[truck];
            if (!rec) return;

            rec.fuel = truckFuel * proportion;
            rec.truckMaint = truckMaint * proportion;
            rec.trailerMaint = truckTrailerMaint * proportion;
            rec.fixedCosts = truckFixedTotal * proportion;
            rec.factoring = rec.revenue * FACTORING_RATE;

            // Gross Profit = Revenue - ALL expenses
            rec.grossProfit = rec.revenue - rec.driverPay - rec.fuel - rec.truckMaint -
                             rec.trailerMaint - rec.fixedCosts - rec.factoring;
          });
        });

        // Process IC loads by trailer type and carrier (external carriers only)
        profitabilityToro.filter(s => s.isIC).forEach(load => {
          const tt = load.trailerType || 'Unknown';
          const carrier = load.carrier || 'Unknown';
          const section = byTrailerType[tt]?.ic || byTrailerType['Unknown'].ic;

          if (!section.carriers[carrier]) {
            section.carriers[carrier] = {
              revenue: 0, driverPay: 0, trailerMaint: 0, fixedCosts: 0,
              factoring: 0, grossProfit: 0, loads: 0, trailerType: tt,
            };
          }
          section.carriers[carrier].revenue += load.revenue || 0;
          section.carriers[carrier].driverPay += load.driverPay || 0;
          section.carriers[carrier].loads += 1;
        });

        // Add IC trailer maintenance and fixed costs
        const carrierLoadsByType = {};
        profitabilityToro.filter(s => s.isIC).forEach(load => {
          const tt = load.trailerType || 'Unknown';
          const carrier = load.carrier || 'Unknown';
          if (!carrierLoadsByType[carrier]) carrierLoadsByType[carrier] = {};
          carrierLoadsByType[carrier][tt] = (carrierLoadsByType[carrier][tt] || 0) + 1;
        });

        const carrierTotalLoads = {};
        Object.entries(carrierLoadsByType).forEach(([carrier, byType]) => {
          carrierTotalLoads[carrier] = Object.values(byType).reduce((a, b) => a + b, 0);
        });

        // Get total IC revenue for fleet-wide allocation
        const totalICRevenue = profitabilityToro.filter(s => s.isIC).reduce((sum, l) => sum + (l.revenue || 0), 0);

        Object.entries(carrierLoadsByType).forEach(([carrier, byType]) => {
          const totalLoads = carrierTotalLoads[carrier] || 1;

          Object.entries(byType).forEach(([tt, loadCount]) => {
            const proportion = loadCount / totalLoads;
            const rec = byTrailerType[tt]?.ic.carriers[carrier];
            if (!rec) return;

            // Trailer maintenance allocation from trailerAllocation
            let carrierTrailerMaint = 0;
            Object.values(trailerAllocation).forEach(alloc => {
              if (alloc.byIC && alloc.byIC[carrier]) {
                carrierTrailerMaint += alloc.byIC[carrier];
              }
            });
            rec.trailerMaint = carrierTrailerMaint * proportion;

            // Fixed costs
            if (icFixedCosts.mode === 'carrier' && icFixedCosts.carrierCosts?.[carrier]) {
              const cc = icFixedCosts.carrierCosts[carrier];
              rec.fixedCosts = ((cc.trailerIns || 0) + (cc.rental || 0) + (cc.tolls || 0)) * proportion;
            } else if (icFixedCosts.mode === 'fleet') {
              const carrierRevenue = profitabilityToro.filter(s => s.isIC && s.carrier === carrier)
                .reduce((sum, l) => sum + (l.revenue || 0), 0);
              const revProportion = totalICRevenue > 0 ? carrierRevenue / totalICRevenue : 0;
              const fc = icFixedCosts.fleetCosts || {};
              rec.fixedCosts = ((fc.trailerIns || 0) + (fc.rental || 0) + (fc.tolls || 0)) * revProportion * proportion;
            }

            rec.factoring = rec.revenue * FACTORING_RATE;

            // Gross Profit = Revenue - ALL expenses
            rec.grossProfit = rec.revenue - rec.driverPay - rec.trailerMaint - rec.fixedCosts - rec.factoring;
          });
        });

        // Calculate subtotals for each section
        trailerTypes.forEach(tt => {
          const section = byTrailerType[tt];
          section.company.totals = sumTotals(Object.values(section.company.trucks));
          section.ownerOperator.totals = sumTotals(Object.values(section.ownerOperator.trucks));
          section.ic.totals = sumTotals(Object.values(section.ic.carriers));
          section.totals = sumTotals([section.company.totals, section.ownerOperator.totals, section.ic.totals]);
        });

        // Grand totals - EXCLUDE Unknown (unclassified loads shown as warning)
        const classifiedTypes = ['Van', 'Flatbed'];
        const grandTotals = sumTotals(classifiedTypes.map(tt => byTrailerType[tt].totals));

        // Asset-type totals - EXCLUDE Unknown
        const companyTotals = sumTotals(classifiedTypes.map(tt => byTrailerType[tt].company.totals));
        const ownerOperatorTotals = sumTotals(classifiedTypes.map(tt => byTrailerType[tt].ownerOperator.totals));
        const icTotals = sumTotals(classifiedTypes.map(tt => byTrailerType[tt].ic.totals));

        return { byTrailerType, grandTotals, companyTotals, ownerOperatorTotals, icTotals };
      }, [profitabilityToro, fuelByTruck, directExpensesByTruck, allocatedTrailerMaintByTruck, truckFixedCosts, icFixedCosts, trailerAllocation, fleet]);

      // ============================================
      // SAVE & LOG - Single button for Status page
      // ============================================

      // Check if log exists and prompt for confirmation
      const saveAndLog = useCallback(() => {
        const existingLog = dailyLogs.find(l => l.date === reportDate);
        if (existingLog) {
          // Show confirmation dialog
          setPendingLogOverride(reportDate);
        } else {
          // No existing log, proceed directly
          performSaveAndLog();
        }
      }, [dailyLogs, reportDate]);

      // Cancel override
      const cancelOverride = useCallback(() => {
        setPendingLogOverride(null);
      }, []);

      // Confirm override and save
      const confirmOverride = useCallback(() => {
        setPendingLogOverride(null);
        performSaveAndLog();
      }, []);

      // Actual save logic
      const performSaveAndLog = useCallback(async () => {
        setSyncing(true);
        showStatus('Saving everything...', 0);

        // Build truck entries for log
        const truckEntries = fleet.map(truck => {
          const tm = truckMetrics[truck.id] || { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0 };
          const tg = truckGoals[truck.id] || { revenueGoal: 0, milesGoal: 0 };
          return {
            truckId: truck.id, ownershipType: truck.ownershipType || 'Company', driver: truck.driver,
            status: truckStatus[truck.id] || 'Unknown',
            expectedReturn: truckExpectedReturn[truck.id] || '',
            notes: truck.notes || '',
            revenue: tm.revenue, miles: tm.totalMiles, loadedMiles: tm.loadedMiles, loads: tm.loads,
            revenueGoal: tg.revenueGoal, milesGoal: tg.milesGoal,
          };
        });

        const icEntries = icMetrics.carriers.map(ic => ({
          carrier: ic.carrier, revenue: ic.revenue, cost: ic.cost,
          grossProfit: ic.grossProfit, grossMargin: ic.grossMargin, loads: ic.loads,
        }));

        // Get IC driver list for this snapshot
        const icDriverList = [...new Set(shipments.filter(s => s.isIC && s.driver).map(s => s.driver))];

        const logEntry = {
          date: reportDate,
          timestamp: new Date().toISOString(),
          trucks: truckEntries,
          ics: icEntries,
          summary: {
            // Fleet status (combined)
            active: fleetCounts['Active'] || 0,
            routine: fleetCounts['Shop - Routine'] || 0,
            breakfix: fleetCounts['Shop - Break/Fix'] || 0,
            nodriver: fleetCounts['Needs Driver'] || 0,
            spare: fleetCounts['Spare'] || 0,
            // Fleet status by ownership
            companyOwnedActive: fleetCountsByOwnership.companyOwned['Active'] || 0,
            companyOwnedTotal: fleetCountsByOwnership.companyTotal,
            ownerOperatorActive: fleetCountsByOwnership.ownerOperator['Active'] || 0,
            ownerOperatorTotal: fleetCountsByOwnership.ooTotal,
            // Company metrics
            companyRevenue: companyMetrics.totalRevenue,
            companyMiles: companyMetrics.totalMiles,
            companyLoadedMiles: companyMetrics.loadedMiles,
            companyLoads: companyMetrics.loadCount,
            companyUtilization: companyMetrics.utilization,
            companyRevPerMile: companyMetrics.revPerTotalMile,
            // Metrics by trailer type
            vanRevenue: metricsByTrailerType.van.revenue,
            vanMiles: metricsByTrailerType.van.totalMiles,
            vanLoads: metricsByTrailerType.van.loads,
            vanRevPerMile: metricsByTrailerType.van.revPerTotalMile,
            flatbedRevenue: metricsByTrailerType.flatbed.revenue,
            flatbedMiles: metricsByTrailerType.flatbed.totalMiles,
            flatbedLoads: metricsByTrailerType.flatbed.loads,
            flatbedRevPerMile: metricsByTrailerType.flatbed.revPerTotalMile,
            unknownTrailerLoads: metricsByTrailerType.unknown.loads,
            // IC metrics
            icRevenue: icMetrics.totalRevenue,
            icCost: icMetrics.totalCost,
            icGrossProfit: icMetrics.totalGrossProfit,
            icGrossMargin: icMetrics.avgGrossMargin,
            icLoads: icMetrics.loadCount,
            icCarrierCount: icMetrics.carriers.length,
            icDriverCount: icMetrics.driverCount,
            icDrivers: icDriverList,
            // Combined totals
            totalRevenue: companyMetrics.totalRevenue + icMetrics.totalRevenue,
            // Goals & pacing
            revenueGoal: totalGoals.revenue,
            milesGoal: totalGoals.miles,
            icGMGoal: totalGoals.icGrossMargin,
            totalRevenueGoal: totalGoals.totalRevenue,
            workdaysPassed: workdaysCalc.elapsed,
            workdaysTotal: workdaysCalc.total,
            percentThroughMonth: workdaysCalc.percent,
            // Flagged loads
            flaggedLoadCount: flaggedLoads.length,
            flaggedLoadRevenue: flaggedLoads.reduce((sum, l) => sum + l.revenue, 0),
          },
        };

        // Update or add log entry
        const existingIndex = dailyLogs.findIndex(l => l.date === reportDate);
        let newLogs;
        if (existingIndex >= 0) {
          newLogs = [...dailyLogs];
          newLogs[existingIndex] = logEntry;
        } else {
          newLogs = [...dailyLogs, logEntry].sort((a, b) => a.date.localeCompare(b.date));
        }
        setDailyLogs(newLogs);

        // Save all data SEQUENTIALLY to avoid Google Apps Script rate limiting
        // IMPORTANT: Do NOT use Promise.all here - it causes concurrent requests that trigger 400/CORS errors
        const statusData = { status: truckStatus, expectedReturn: truckExpectedReturn };
        const shipmentsData = { dataDate: shipmentsDataDate || reportDate, shipments };

        // Small data first (single request each), then chunked data
        console.log('Saving Fleet...');
        await SheetsDB.write('Fleet', fleet, reportDate);

        console.log('Saving TruckStatus...');
        await SheetsDB.write('TruckStatus', statusData, reportDate);

        console.log('Saving MonthlyPlan...');
        await SheetsDB.write('MonthlyPlan', monthlyPlan, reportDate);

        // Chunked data last - these send multiple requests each
        console.log('Saving Shipments...');
        await SheetsDB.write('Shipments', shipmentsData, reportDate);

        console.log('Saving DailyLogs...');
        await SheetsDB.write('DailyLogs', newLogs, reportDate);

        console.log('All saves complete!');

        const connected = await SheetsDB.checkConnection();
        setConnectionStatus(connected ? 'connected' : 'offline');
        showStatus(connected ? `Saved & logged ${reportDate} ‚úì` : 'Saved locally ‚ö†', 3000);
        setSyncing(false);
      }, [fleet, truckStatus, truckExpectedReturn, shipments, shipmentsDataDate, dailyLogs, reportDate, truckMetrics, truckGoals, icMetrics, fleetCounts, fleetCountsByOwnership, metricsByTrailerType, companyMetrics, totalGoals, monthlyPlan, workdaysCalc, flaggedLoads]);

      // ============================================
      // SAVE GOALS
      // ============================================
      const saveGoals = useCallback(async () => {
        setSyncing(true);
        showStatus('Saving goals...');
        await SheetsDB.write('Goals', goals);
        await SheetsDB.write('MonthlyPlan', monthlyPlan, reportDate);
        showStatus('Goals saved ‚úì');
        setSyncing(false);
      }, [goals, monthlyPlan, reportDate]);

      // ============================================
      // SAVE PROFITABILITY DATA
      // ============================================
      const saveProfitabilityData = useCallback(async () => {
        setProfitabilitySaving(true);
        showStatus('Saving profitability data...', 0);

        try {
          await SheetsDB.write('TruckFixedCosts', truckFixedCosts);
          await SheetsDB.write('ICFixedCosts', icFixedCosts);
          await SheetsDB.write('MonthsClosed', monthsClosed);

          // Save month-specific data if a month is selected
          if (profitabilityMonth) {
            const monthData = {
              month: profitabilityMonth,
              lastUpdated: new Date().toISOString(),
              fuelData,
              expenseData,
              toroData: profitabilityToro,
              calculations: profitabilityCalc,
            };
            await SheetsDB.write(`Profitability_${profitabilityMonth}`, monthData);
          }

          showStatus('Profitability data saved ‚úì', 3000);
        } catch (err) {
          showStatus('Error saving: ' + err.message, 5000);
        }

        setProfitabilitySaving(false);
      }, [truckFixedCosts, icFixedCosts, monthsClosed, profitabilityMonth, fuelData, expenseData, profitabilityToro, profitabilityCalc]);

      // ============================================
      // COPY DASHBOARD TO CLIPBOARD
      // ============================================
      const copyDashboardToClipboard = async () => {
        if (!dashboardRef.current) return;
        showStatus('Capturing dashboard...', 0);

        try {
          const canvas = await html2canvas(dashboardRef.current, {
            backgroundColor: '#f3f4f6',
            scale: 2,
          });

          canvas.toBlob(async (blob) => {
            try {
              await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
              ]);
              showStatus('Dashboard copied to clipboard! ‚úì', 3000);
            } catch (err) {
              // Fallback: open in new tab
              const url = canvas.toDataURL();
              window.open(url, '_blank');
              showStatus('Opened in new tab (clipboard not available)', 3000);
            }
          });
        } catch (err) {
          showStatus('Failed to capture: ' + err.message, 3000);
        }
      };

      // ============================================
      // EXPORT/IMPORT
      // ============================================
      const exportData = () => {
        const data = {
          fleet, goals, monthlyPlan, dailyLogs, shipments,
          truckStatus: { status: truckStatus, expectedReturn: truckExpectedReturn },
          exportedAt: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CTL_DOR_Backup_${reportDate}.json`;
        a.click();
      };

      // ============================================
      // HELPER: Validate imported JSON data structure
      // ============================================
      const validateImportData = (data) => {
        const errors = [];

        if (typeof data !== 'object' || data === null) {
          errors.push('Data must be an object');
          return { valid: false, errors };
        }

        if (data.fleet !== undefined) {
          if (!Array.isArray(data.fleet)) {
            errors.push('fleet must be an array');
          } else {
            data.fleet.forEach((truck, i) => {
              if (typeof truck !== 'object' || truck === null) {
                errors.push(`fleet[${i}] must be an object`);
              }
            });
          }
        }

        if (data.goals !== undefined && (typeof data.goals !== 'object' || data.goals === null)) {
          errors.push('goals must be an object');
        }

        if (data.monthlyPlan !== undefined && (typeof data.monthlyPlan !== 'object' || data.monthlyPlan === null)) {
          errors.push('monthlyPlan must be an object');
        }

        if (data.dailyLogs !== undefined && !Array.isArray(data.dailyLogs)) {
          errors.push('dailyLogs must be an array');
        }

        if (data.shipments !== undefined && !Array.isArray(data.shipments)) {
          errors.push('shipments must be an array');
        }

        if (data.truckStatus !== undefined && (typeof data.truckStatus !== 'object' || data.truckStatus === null)) {
          errors.push('truckStatus must be an object');
        }

        return { valid: errors.length === 0, errors };
      };

      const importData = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            // Validate data structure before importing
            const validation = validateImportData(data);
            if (!validation.valid) {
              showStatus(`Import failed: ${validation.errors.slice(0, 3).join(', ')}`, 5000);
              return;
            }

            if (data.fleet) setFleet(data.fleet.map(t => ({ ...t, ownershipType: t.ownershipType || 'Company' })));
            if (data.goals) setGoals(prev => ({ ...prev, ...data.goals }));
            if (data.monthlyPlan) setMonthlyPlan(data.monthlyPlan);
            if (data.dailyLogs) setDailyLogs(Array.isArray(data.dailyLogs) ? data.dailyLogs : []);
            if (data.shipments) setShipments(data.shipments);
            if (data.truckStatus) {
              setTruckStatus(data.truckStatus.status || {});
              setTruckExpectedReturn(data.truckStatus.expectedReturn || {});
            }
            showStatus('Data imported ‚úì');
          } catch (err) {
            showStatus(`Import error: ${err.message}`, 5000);
          }
        };
        reader.readAsText(file);
      };

      // ============================================
      // LOADING STATE
      // ============================================
      if (loading) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-4 text-gray-600">Loading dashboard...</p>
            </div>
          </div>
        );
      }

      // ============================================
      // RENDER
      // ============================================
      return (
        <div className="min-h-screen bg-gray-100">
          {/* HEADER */}
          <header className="bg-blue-900 text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                  <h1 className="text-xl md:text-2xl font-bold">COOLMORE TRUCK LINES</h1>
                  <p className="text-blue-200 text-sm">Daily Operating Report</p>
                </div>
                <div className="flex flex-wrap items-center gap-3">
                  <div>
                    <label htmlFor="report-date" className="block text-xs text-blue-200 mb-1">Report Date</label>
                    <input id="report-date" type="date" value={reportDate} onChange={(e) => setReportDate(e.target.value)}
                      className="border-0 rounded px-3 py-1.5 text-sm font-semibold text-blue-900 bg-white" />
                  </div>
                  {saveStatus && (
                    <span className="text-sm text-green-300 bg-green-900/30 px-2 py-1 rounded">{saveStatus}</span>
                  )}
                  <div className={`text-xs px-3 py-1.5 rounded font-medium ${connectionStatus === 'connected' ? 'bg-green-600' : 'bg-yellow-600'}`}>
                    {connectionStatus === 'connected' ? '‚óè Online' : '‚óã Offline'}
                  </div>
                </div>
              </div>

              {/* TABS */}
              <nav className="flex gap-4 mt-4 border-t border-blue-800 pt-3 overflow-x-auto">
                {[
                  { id: 'dashboard', label: 'Dashboard' },
                  { id: 'trucks', label: 'Company Trucks' },
                  { id: 'ic', label: 'ICs / Carriers' },
                  { id: 'status', label: 'Status' },
                  { id: 'settings', label: 'Settings' },
                  { id: 'reports', label: 'Reports' },
                  { id: 'profitability', label: 'Profitability' },
                ].map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                    className={`text-sm font-medium pb-2 whitespace-nowrap ${activeTab === tab.id ? 'text-white border-b-2 border-white' : 'text-blue-300 hover:text-white'}`}>
                    {tab.label}
                  </button>
                ))}
              </nav>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-6">

            {/* ==================== DASHBOARD TAB ==================== */}
            {activeTab === 'dashboard' && (
              <div className="space-y-6">
                {/* Controls */}
                <div className="flex flex-wrap items-center gap-4">
                  <button onClick={copyDashboardToClipboard}
                    aria-label="Copy dashboard as image to clipboard"
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                    üìã Copy Dashboard
                  </button>
                  <span className="text-sm text-gray-500">
                    Day {workdaysCalc.elapsed} of {workdaysCalc.total} ({Math.round(workdaysCalc.percent * 100)}% through month)
                  </span>
                </div>

                {/* Empty state notice */}
                {shipments.length === 0 && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p className="text-blue-800 font-medium">üìä Getting Started</p>
                    <p className="text-blue-600 text-sm mt-1">
                      Upload a TORO export on the <button onClick={() => setActiveTab('status')} className="underline font-medium">Status tab</button> to populate the dashboard with real data.
                    </p>
                  </div>
                )}

                {/* Stale data warning - shipments from different day than report date */}
                {shipments.length > 0 && shipmentsDataDate && shipmentsDataDate !== reportDate && (
                  <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-yellow-600 text-xl">üìÖ</span>
                        <div>
                          <p className="text-yellow-800 font-medium">
                            Shipment data is from {new Date(shipmentsDataDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                          </p>
                          <p className="text-yellow-600 text-sm">
                            Report date is {new Date(reportDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}. Upload a fresh TORO export if needed.
                          </p>
                        </div>
                      </div>
                      <button onClick={() => setActiveTab('status')}
                        className="px-3 py-1 text-sm font-medium text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors">
                        Go to Status
                      </button>
                    </div>
                  </div>
                )}

                {/* Missing Cost Data Warning */}
                {flaggedLoads.length > 0 && (
                  <div className="bg-amber-50 border border-amber-300 rounded-lg p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-amber-600 text-xl">‚ö†Ô∏è</span>
                        <div>
                          <p className="text-amber-800 font-medium">
                            {flaggedLoads.length} load{flaggedLoads.length !== 1 ? 's' : ''} may be missing cost data
                          </p>
                          <p className="text-amber-600 text-sm">
                            These loads show 95%+ margin with revenue over $500. They're included in totals but may need driver/carrier pay added.
                          </p>
                        </div>
                      </div>
                      <button
                        onClick={() => setShowFlaggedLoads(!showFlaggedLoads)}
                        className="px-3 py-1 text-sm font-medium text-amber-700 bg-amber-100 hover:bg-amber-200 rounded-lg transition-colors"
                      >
                        {showFlaggedLoads ? 'Hide Details' : 'Show Details'}
                      </button>
                    </div>

                    {showFlaggedLoads && (
                      <div className="mt-4 overflow-x-auto">
                        <table className="min-w-full text-sm">
                          <thead>
                            <tr className="text-left text-amber-700 border-b border-amber-200">
                              <th className="px-3 py-2">Order #</th>
                              <th className="px-3 py-2">Type</th>
                              <th className="px-3 py-2">Truck/Carrier</th>
                              <th className="px-3 py-2">Customer</th>
                              <th className="px-3 py-2 text-right">Revenue</th>
                              <th className="px-3 py-2 text-right">Gross Profit</th>
                              <th className="px-3 py-2 text-right">Margin</th>
                              <th className="px-3 py-2">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {flaggedLoads.map((load, idx) => (
                              <tr key={load.orderId || idx} className="border-b border-amber-100 hover:bg-amber-100/50">
                                <td className="px-3 py-2 font-mono text-xs">{load.orderId}</td>
                                <td className="px-3 py-2">
                                  <span className={`px-2 py-0.5 rounded text-xs font-medium ${load.type === 'IC' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                    {load.type}
                                  </span>
                                </td>
                                <td className="px-3 py-2">{load.truckOrCarrier || '‚Äî'}</td>
                                <td className="px-3 py-2 text-gray-600">{load.customer || '‚Äî'}</td>
                                <td className="px-3 py-2 text-right font-medium">{fmtCurrency(load.revenue)}</td>
                                <td className="px-3 py-2 text-right text-green-600">{fmtCurrency(load.grossProfit)}</td>
                                <td className="px-3 py-2 text-right text-red-600 font-medium">{fmtPercent(load.margin)}</td>
                                <td className="px-3 py-2 text-gray-500">{load.status}</td>
                              </tr>
                            ))}
                          </tbody>
                          <tfoot>
                            <tr className="bg-amber-100 font-medium text-amber-800">
                              <td colSpan="4" className="px-3 py-2">Total Flagged Revenue</td>
                              <td className="px-3 py-2 text-right">{fmtCurrency(flaggedLoads.reduce((sum, l) => sum + l.revenue, 0))}</td>
                              <td className="px-3 py-2 text-right">{fmtCurrency(flaggedLoads.reduce((sum, l) => sum + l.grossProfit, 0))}</td>
                              <td colSpan="2" className="px-3 py-2"></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Dashboard Content (for screenshot) */}
                <div ref={dashboardRef} className="space-y-6 bg-gray-100 p-4 rounded-lg">
                  {/* Combined Plan Status */}
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">üìä Monthly Performance vs. Plan</h2>
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                      <div className="text-center">
                        <div className="text-sm text-gray-500">Company Revenue</div>
                        <div className={`text-2xl font-bold ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmtCurrency(companyMetrics.totalRevenue)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmtCurrency(totalGoals.revenue)} | Pace: {fmtCurrency(totalGoals.revenuePacing)}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm text-gray-500">Company Miles</div>
                        <div className={`text-2xl font-bold ${companyMetrics.totalMiles >= totalGoals.milesPacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmt(companyMetrics.totalMiles)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmt(totalGoals.miles)} | Pace: {fmt(Math.round(totalGoals.milesPacing))}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm text-gray-500">IC Gross Margin $</div>
                        <div className={`text-2xl font-bold ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmtCurrency(icMetrics.totalGrossProfit)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmtCurrency(totalGoals.icGrossMargin)} | Pace: {fmtCurrency(totalGoals.icGMPacing)}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-sm text-gray-500">Total Revenue</div>
                        <div className={`text-2xl font-bold ${(companyMetrics.totalRevenue + icMetrics.totalRevenue) >= totalGoals.totalRevenuePacing ? 'text-green-600' : 'text-red-600'}`}>
                          {fmtCurrency(companyMetrics.totalRevenue + icMetrics.totalRevenue)}
                        </div>
                        <div className="text-xs text-gray-400">Goal: {fmtCurrency(totalGoals.totalRevenue)} | Pace: {fmtCurrency(totalGoals.totalRevenuePacing)}</div>
                      </div>
                    </div>

                    {/* Progress Bars */}
                    <div className="space-y-3">
                      <div>
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                          <span>Company Revenue</span>
                          <span>{Math.round(safeDivide(companyMetrics.totalRevenue, totalGoals.revenue) * 100)}%</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'bg-green-500' : 'bg-red-500'}`}
                            style={{ width: `${Math.min(safeDivide(companyMetrics.totalRevenue, totalGoals.revenue) * 100, 100)}%` }} />
                        </div>
                      </div>
                      <div>
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                          <span>IC Gross Margin $</span>
                          <span>{Math.round(safeDivide(icMetrics.totalGrossProfit, totalGoals.icGrossMargin) * 100)}%</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'bg-green-500' : 'bg-red-500'}`}
                            style={{ width: `${Math.min(safeDivide(icMetrics.totalGrossProfit, totalGoals.icGrossMargin) * 100, 100)}%` }} />
                        </div>
                      </div>
                      <div>
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                          <span>Total Revenue</span>
                          <span>{Math.round(safeDivide(companyMetrics.totalRevenue + icMetrics.totalRevenue, totalGoals.totalRevenue) * 100)}%</span>
                        </div>
                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full ${(companyMetrics.totalRevenue + icMetrics.totalRevenue) >= totalGoals.totalRevenuePacing ? 'bg-green-500' : 'bg-red-500'}`}
                            style={{ width: `${Math.min(safeDivide(companyMetrics.totalRevenue + icMetrics.totalRevenue, totalGoals.totalRevenue) * 100, 100)}%` }} />
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Fleet Status - Split by Ownership */}
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">üöõ Fleet Status</h2>

                    {/* Combined Totals Row */}
                    <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-3 mb-4">
                      {[
                        { key: 'Active', label: 'Active', color: 'bg-green-500' },
                        { key: 'Shop - Routine', label: 'Routine', color: 'bg-yellow-400', dark: true },
                        { key: 'Shop - Break/Fix', label: 'Break/Fix', color: 'bg-orange-500' },
                        { key: 'Needs Driver', label: 'No Driver', color: 'bg-red-500' },
                        { key: 'Spare', label: 'Spare', color: 'bg-gray-400' },
                      ].map(({ key, label, color, dark }) => (
                        <div key={key} className={`${color} rounded-lg p-3 sm:p-4 text-center`}>
                          <div className={`text-2xl sm:text-3xl font-bold ${dark ? 'text-gray-900' : 'text-white'}`}>{fleetCounts[key] || 0}</div>
                          <div className={`text-xs ${dark ? 'text-gray-700' : 'text-white/80'}`}>{label}</div>
                        </div>
                      ))}
                    </div>

                    {/* Ownership Breakdown */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                      {/* Company-Owned */}
                      <div className="bg-blue-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-semibold text-blue-800">üè¢ Company-Owned</h3>
                          <span className="text-sm text-blue-600">{fleetCountsByOwnership.companyTotal} trucks</span>
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {[
                            { key: 'Active', label: 'Active', color: 'bg-green-500' },
                            { key: 'Shop - Routine', label: 'Routine', color: 'bg-yellow-400', dark: true },
                            { key: 'Shop - Break/Fix', label: 'Break/Fix', color: 'bg-orange-500' },
                            { key: 'Needs Driver', label: 'No Driver', color: 'bg-red-500' },
                            { key: 'Spare', label: 'Spare', color: 'bg-gray-400' },
                          ].filter(({ key }) => fleetCountsByOwnership.companyOwned[key] > 0).map(({ key, label, color, dark }) => (
                            <div key={key} className={`${color} rounded px-3 py-1.5 text-center`}>
                              <span className={`text-lg font-bold ${dark ? 'text-gray-900' : 'text-white'}`}>{fleetCountsByOwnership.companyOwned[key]}</span>
                              <span className={`text-xs ml-1 ${dark ? 'text-gray-700' : 'text-white/80'}`}>{label}</span>
                            </div>
                          ))}
                          {fleetCountsByOwnership.companyTotal === 0 && (
                            <span className="text-sm text-gray-400">No trucks</span>
                          )}
                        </div>
                      </div>

                      {/* Owner-Operators */}
                      <div className="bg-purple-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-semibold text-purple-800">üë§ Owner-Operators</h3>
                          <span className="text-sm text-purple-600">{fleetCountsByOwnership.ooTotal} trucks</span>
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {[
                            { key: 'Active', label: 'Active', color: 'bg-green-500' },
                            { key: 'Shop - Routine', label: 'Routine', color: 'bg-yellow-400', dark: true },
                            { key: 'Shop - Break/Fix', label: 'Break/Fix', color: 'bg-orange-500' },
                            { key: 'Needs Driver', label: 'No Driver', color: 'bg-red-500' },
                            { key: 'Spare', label: 'Spare', color: 'bg-gray-400' },
                          ].filter(({ key }) => fleetCountsByOwnership.ownerOperator[key] > 0).map(({ key, label, color, dark }) => (
                            <div key={key} className={`${color} rounded px-3 py-1.5 text-center`}>
                              <span className={`text-lg font-bold ${dark ? 'text-gray-900' : 'text-white'}`}>{fleetCountsByOwnership.ownerOperator[key]}</span>
                              <span className={`text-xs ml-1 ${dark ? 'text-gray-700' : 'text-white/80'}`}>{label}</span>
                            </div>
                          ))}
                          {fleetCountsByOwnership.ooTotal === 0 && (
                            <span className="text-sm text-gray-400">No owner-operators</span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Performance by Trailer Type */}
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">üì¶ Performance by Trailer Type</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Van */}
                      <div className="bg-cyan-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-semibold text-cyan-800">üöê Van Loads</h3>
                          <span className="px-2 py-0.5 bg-cyan-200 text-cyan-800 rounded text-sm font-medium">{metricsByTrailerType.van.loads} loads</span>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div>
                            <span className="text-gray-500">Revenue:</span>
                            <span className="ml-2 font-semibold text-gray-800">{fmtCurrency(metricsByTrailerType.van.revenue)}</span>
                          </div>
                          <div>
                            <span className="text-gray-500">Miles:</span>
                            <span className="ml-2 font-semibold text-gray-800">{fmt(metricsByTrailerType.van.totalMiles)}</span>
                          </div>
                          <div>
                            <span className="text-gray-500">$/Total Mi:</span>
                            <span className={`ml-2 font-semibold ${metricsByTrailerType.van.revPerTotalMile >= goals.targetRevPerTotalMile ? 'text-green-600' : 'text-red-600'}`}>
                              ${fmtDecimal(metricsByTrailerType.van.revPerTotalMile)}
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-500">Utilization:</span>
                            <span className={`ml-2 font-semibold ${metricsByTrailerType.van.utilization >= goals.targetUtilization ? 'text-green-600' : 'text-red-600'}`}>
                              {Math.round(metricsByTrailerType.van.utilization * 100)}%
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Flatbed */}
                      <div className="bg-amber-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-semibold text-amber-800">üõª Flatbed Loads</h3>
                          <span className="px-2 py-0.5 bg-amber-200 text-amber-800 rounded text-sm font-medium">{metricsByTrailerType.flatbed.loads} loads</span>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div>
                            <span className="text-gray-500">Revenue:</span>
                            <span className="ml-2 font-semibold text-gray-800">{fmtCurrency(metricsByTrailerType.flatbed.revenue)}</span>
                          </div>
                          <div>
                            <span className="text-gray-500">Miles:</span>
                            <span className="ml-2 font-semibold text-gray-800">{fmt(metricsByTrailerType.flatbed.totalMiles)}</span>
                          </div>
                          <div>
                            <span className="text-gray-500">$/Total Mi:</span>
                            <span className={`ml-2 font-semibold ${metricsByTrailerType.flatbed.revPerTotalMile >= goals.targetRevPerTotalMile ? 'text-green-600' : 'text-red-600'}`}>
                              ${fmtDecimal(metricsByTrailerType.flatbed.revPerTotalMile)}
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-500">Utilization:</span>
                            <span className={`ml-2 font-semibold ${metricsByTrailerType.flatbed.utilization >= goals.targetUtilization ? 'text-green-600' : 'text-red-600'}`}>
                              {Math.round(metricsByTrailerType.flatbed.utilization * 100)}%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    {metricsByTrailerType.unknown.loads > 0 && (
                      <div className="mt-3 text-sm text-gray-500">
                        ‚ö†Ô∏è {metricsByTrailerType.unknown.loads} loads with unknown trailer type ({fmtCurrency(metricsByTrailerType.unknown.revenue)} revenue)
                      </div>
                    )}
                  </div>

                  {/* Company & IC Summary */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Company Summary */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">Company Trucks</h3>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-gray-500">Revenue:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'text-green-600' : 'text-red-600'}`}>
                            {fmtCurrency(companyMetrics.totalRevenue)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Loads:</span>
                          <span className="ml-2 font-semibold">{companyMetrics.loadCount}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">$/Total Mi:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.revPerTotalMile >= goals.targetRevPerTotalMile ? 'text-green-600' : 'text-red-600'}`}>
                            ${fmtDecimal(companyMetrics.revPerTotalMile)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">$/Loaded Mi:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.revPerLoadedMile >= goals.targetRevPerLoadedMile ? 'text-green-600' : 'text-red-600'}`}>
                            ${fmtDecimal(companyMetrics.revPerLoadedMile)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Utilization:</span>
                          <span className={`ml-2 font-semibold ${companyMetrics.utilization >= goals.targetUtilization ? 'text-green-600' : 'text-red-600'}`}>
                            {Math.round(companyMetrics.utilization * 100)}%
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Trucks in Plan:</span>
                          <span className="ml-2 font-semibold">{totalGoals.trucksIncluded}</span>
                        </div>
                      </div>
                    </div>

                    {/* IC Summary */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">Independent Contractors</h3>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-gray-500">Revenue:</span>
                          <span className="ml-2 font-semibold">{fmtCurrency(icMetrics.totalRevenue)}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">Loads:</span>
                          <span className="ml-2 font-semibold">{icMetrics.loadCount}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">Gross Margin $:</span>
                          <span className={`ml-2 font-semibold ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'text-green-600' : 'text-red-600'}`}>
                            {fmtCurrency(icMetrics.totalGrossProfit)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">GM %:</span>
                          <span className={`ml-2 font-semibold ${icMetrics.avgGrossMargin >= goals.targetICGrossMarginPct ? 'text-green-600' : 'text-red-600'}`}>
                            {fmtPercent(icMetrics.avgGrossMargin)}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500">Carriers:</span>
                          <span className="ml-2 font-semibold">{icMetrics.carriers.length}</span>
                        </div>
                        <div>
                          <span className="text-gray-500">Drivers:</span>
                          <span className="ml-2 font-semibold">{icMetrics.driverCount}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ==================== COMPANY TRUCKS TAB ==================== */}
            {activeTab === 'trucks' && (
              <div className="space-y-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex flex-wrap justify-between items-start gap-4">
                    <div>
                      <h2 className="text-lg font-semibold text-gray-800">Company Truck Performance</h2>
                      <p className="text-sm text-gray-500">Per-truck metrics vs. individual goals. Color coding: üü¢ on/above goal, üü° within 10%, üî¥ below goal.</p>
                    </div>

                    {/* Filters */}
                    <div className="flex flex-wrap gap-3">
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Ownership</label>
                        <select value={ownershipFilter} onChange={(e) => setOwnershipFilter(e.target.value)}
                          className="border rounded px-3 py-1.5 text-sm">
                          <option value="all">All Trucks</option>
                          <option value="Company">Company-Owned</option>
                          <option value="Owner-Operator">Owner-Operators</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">Trailer Type</label>
                        <select value={trailerTypeFilter} onChange={(e) => setTrailerTypeFilter(e.target.value)}
                          className="border rounded px-3 py-1.5 text-sm">
                          <option value="all">All Loads</option>
                          <option value="Van">Van Loads</option>
                          <option value="Flatbed">Flatbed Loads</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {/* Active filters indicator */}
                  {(ownershipFilter !== 'all' || trailerTypeFilter !== 'all') && (
                    <div className="mt-3 flex items-center gap-2 text-sm">
                      <span className="text-gray-500">Filtering:</span>
                      {ownershipFilter !== 'all' && (
                        <span className={`px-2 py-0.5 rounded ${ownershipFilter === 'Owner-Operator' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                          {ownershipFilter}
                        </span>
                      )}
                      {trailerTypeFilter !== 'all' && (
                        <span className={`px-2 py-0.5 rounded ${trailerTypeFilter === 'Van' ? 'bg-cyan-100 text-cyan-700' : 'bg-amber-100 text-amber-700'}`}>
                          {trailerTypeFilter} loads
                        </span>
                      )}
                      <button onClick={() => { setOwnershipFilter('all'); setTrailerTypeFilter('all'); }}
                        className="text-gray-400 hover:text-gray-600 ml-2">‚úï Clear</button>
                    </div>
                  )}
                </div>

                {shipments.length === 0 && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <p className="text-yellow-800 font-medium">No shipment data loaded</p>
                    <p className="text-yellow-600 text-sm mt-1">Upload a TORO export on the Status tab to see truck performance metrics.</p>
                  </div>
                )}

                <div className="bg-white rounded-lg shadow-sm overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-blue-900 text-white">
                      <tr>
                        <th className="px-3 py-3 text-left">Truck</th>
                        <th className="px-3 py-3 text-left">Ownership</th>
                        <th className="px-3 py-3 text-left">Status</th>
                        <th className="px-3 py-3 text-right">Revenue</th>
                        <th className="px-3 py-3 text-right">Goal</th>
                        <th className="px-3 py-3 text-right">Miles</th>
                        <th className="px-3 py-3 text-right">Goal</th>
                        <th className="px-3 py-3 text-right">$/Tot Mi</th>
                        <th className="px-3 py-3 text-right">$/Ld Mi</th>
                        <th className="px-3 py-3 text-right">Util</th>
                        <th className="px-3 py-3 text-right">Loads</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredFleet.map((truck, idx) => {
                        const tm = filteredTruckMetrics[truck.id] || { revenue: 0, totalMiles: 0, loadedMiles: 0, loads: 0, revPerTotalMile: 0, revPerLoadedMile: 0, utilization: 0 };
                        const tg = truckGoals[truck.id] || { included: false, revenueGoal: 0, milesGoal: 0 };
                        const status = truckStatus[truck.id] || '';
                        const pacedRevGoal = tg.revenueGoal * workdaysCalc.percent;
                        const pacedMiGoal = tg.milesGoal * workdaysCalc.percent;

                        if (!tg.included) {
                          // Still show metrics if this truck has revenue (e.g., assigned loads)
                          const hasActivity = tm.revenue > 0 || tm.loads > 0;
                          return (
                            <tr key={truck.id} className="bg-gray-100 text-gray-400">
                              <td className="px-3 py-2 font-semibold">{truck.id}</td>
                              <td className="px-3 py-2">
                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${truck.ownershipType === 'Owner-Operator' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                  {truck.ownershipType === 'Owner-Operator' ? 'O/O' : 'Co'}
                                </span>
                              </td>
                              <td className="px-3 py-2">{status || 'Spare'}</td>
                              {hasActivity ? (
                                <>
                                  <td className="px-3 py-2 text-right font-semibold text-gray-500">{fmtCurrency(tm.revenue)}</td>
                                  <td className="px-3 py-2 text-right text-xs italic">no goal</td>
                                  <td className="px-3 py-2 text-right font-semibold text-gray-500">{fmt(tm.totalMiles)}</td>
                                  <td className="px-3 py-2 text-right text-xs italic">no goal</td>
                                  <td className="px-3 py-2 text-right text-gray-500">${fmtDecimal(tm.revPerTotalMile)}</td>
                                  <td className="px-3 py-2 text-right text-gray-500">${fmtDecimal(tm.revPerLoadedMile)}</td>
                                  <td className="px-3 py-2 text-right text-gray-500">{Math.round(tm.utilization * 100)}%</td>
                                  <td className="px-3 py-2 text-right text-gray-500">{tm.loads}</td>
                                </>
                              ) : (
                                <td colSpan="8" className="px-3 py-2 text-center italic">Not in plan</td>
                              )}
                            </tr>
                          );
                        }

                        return (
                          <tr key={truck.id} className={`${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} ${truck.ownershipType === 'Owner-Operator' ? 'border-l-4 border-purple-400' : ''}`}>
                            <td className="px-3 py-2 font-semibold">{truck.id}</td>
                            <td className="px-3 py-2">
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${truck.ownershipType === 'Owner-Operator' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                {truck.ownershipType === 'Owner-Operator' ? 'O/O' : 'Co'}
                              </span>
                            </td>
                            <td className="px-3 py-2">
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${getStatusClass(status)}`}>{status || '‚Äî'}</span>
                            </td>
                            <td className={`px-3 py-2 text-right font-semibold ${getColorClass(tm.revenue, pacedRevGoal)}`}>
                              {fmtCurrency(tm.revenue)}
                            </td>
                            <td className="px-3 py-2 text-right text-gray-400 text-xs">{fmtCurrency(tg.revenueGoal)}</td>
                            <td className={`px-3 py-2 text-right font-semibold ${getColorClass(tm.totalMiles, pacedMiGoal)}`}>
                              {fmt(tm.totalMiles)}
                            </td>
                            <td className="px-3 py-2 text-right text-gray-400 text-xs">{fmt(tg.milesGoal)}</td>
                            <td className={`px-3 py-2 text-right ${getColorClass(tm.revPerTotalMile, goals.targetRevPerTotalMile)}`}>
                              ${fmtDecimal(tm.revPerTotalMile)}
                            </td>
                            <td className={`px-3 py-2 text-right ${getColorClass(tm.revPerLoadedMile, goals.targetRevPerLoadedMile)}`}>
                              ${fmtDecimal(tm.revPerLoadedMile)}
                            </td>
                            <td className={`px-3 py-2 text-right ${getColorClass(tm.utilization, goals.targetUtilization)}`}>
                              {Math.round(tm.utilization * 100)}%
                            </td>
                            <td className="px-3 py-2 text-right">{tm.loads}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                    <tfoot className="bg-blue-900 text-white font-semibold">
                      <tr>
                        <td className="px-3 py-3" colSpan="3">
                          {trailerTypeFilter !== 'all' || ownershipFilter !== 'all'
                            ? `FILTERED (${filteredFleet.length} trucks)`
                            : `TOTAL (${totalGoals.trucksIncluded} trucks)`}
                        </td>
                        <td className={`px-3 py-3 text-right ${filteredCompanyMetrics.totalRevenue >= totalGoals.revenuePacing ? 'text-green-300' : 'text-red-300'}`}>
                          {fmtCurrency(filteredCompanyMetrics.totalRevenue)}
                        </td>
                        <td className="px-3 py-3 text-right text-blue-300">{fmtCurrency(totalGoals.revenue)}</td>
                        <td className={`px-3 py-3 text-right ${filteredCompanyMetrics.totalMiles >= totalGoals.milesPacing ? 'text-green-300' : 'text-red-300'}`}>
                          {fmt(filteredCompanyMetrics.totalMiles)}
                        </td>
                        <td className="px-3 py-3 text-right text-blue-300">{fmt(totalGoals.miles)}</td>
                        <td className={`px-3 py-3 text-right ${filteredCompanyMetrics.revPerTotalMile >= goals.targetRevPerTotalMile ? 'text-green-300' : 'text-red-300'}`}>
                          ${fmtDecimal(filteredCompanyMetrics.revPerTotalMile)}
                        </td>
                        <td className={`px-3 py-3 text-right ${filteredCompanyMetrics.revPerLoadedMile >= goals.targetRevPerLoadedMile ? 'text-green-300' : 'text-red-300'}`}>
                          ${fmtDecimal(filteredCompanyMetrics.revPerLoadedMile)}
                        </td>
                        <td className={`px-3 py-3 text-right ${filteredCompanyMetrics.utilization >= goals.targetUtilization ? 'text-green-300' : 'text-red-300'}`}>
                          {Math.round(filteredCompanyMetrics.utilization * 100)}%
                        </td>
                        <td className="px-3 py-3 text-right">{filteredCompanyMetrics.loadCount}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div className="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
                  <strong>Floors:</strong> $/Total Mile ‚â• ${fmtDecimal(goals.targetRevPerTotalMile)} | $/Loaded Mile ‚â• ${fmtDecimal(goals.targetRevPerLoadedMile)} | Utilization ‚â• {Math.round(goals.targetUtilization * 100)}%
                </div>
              </div>
            )}

            {/* ==================== ICs / CARRIERS TAB ==================== */}
            {activeTab === 'ic' && (
              <div className="space-y-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <h2 className="text-lg font-semibold text-gray-800">Independent Contractors / Carriers</h2>
                  <p className="text-sm text-gray-500">Brokerage performance. GM% floor: {goals.targetICGrossMarginPct}%</p>
                </div>

                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className="text-xl sm:text-2xl font-bold text-gray-900">{fmtCurrency(icMetrics.totalRevenue)}</div>
                    <div className="text-xs text-gray-500">Revenue</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className="text-xl sm:text-2xl font-bold text-red-600">{fmtCurrency(icMetrics.totalCost)}</div>
                    <div className="text-xs text-gray-500">Carrier Cost</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className={`text-xl sm:text-2xl font-bold ${icMetrics.totalGrossProfit >= totalGoals.icGMPacing ? 'text-green-600' : 'text-red-600'}`}>
                      {fmtCurrency(icMetrics.totalGrossProfit)}
                    </div>
                    <div className="text-xs text-gray-500">GM $ (Goal: {fmtCurrency(totalGoals.icGrossMargin)})</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-sm p-3 sm:p-4 text-center">
                    <div className={`text-xl sm:text-2xl font-bold ${icMetrics.avgGrossMargin >= goals.targetICGrossMarginPct ? 'text-green-600' : 'text-red-600'}`}>
                      {fmtPercent(icMetrics.avgGrossMargin)}
                    </div>
                    <div className="text-xs text-gray-500">GM % (Floor: {goals.targetICGrossMarginPct}%)</div>
                  </div>
                </div>

                {icMetrics.carriers.length > 0 ? (
                  <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-blue-900 text-white">
                        <tr>
                          <th className="px-4 py-3 text-left">Carrier</th>
                          <th className="px-4 py-3 text-right">Revenue</th>
                          <th className="px-4 py-3 text-right">Cost</th>
                          <th className="px-4 py-3 text-right">GM $</th>
                          <th className="px-4 py-3 text-right">GM %</th>
                          <th className="px-4 py-3 text-right">Loads</th>
                        </tr>
                      </thead>
                      <tbody>
                        {icMetrics.carriers.map((c, idx) => (
                          <tr key={c.carrier || idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-4 py-3 font-medium">{c.carrier}</td>
                            <td className="px-4 py-3 text-right">{fmtCurrency(c.revenue)}</td>
                            <td className="px-4 py-3 text-right text-red-600">{fmtCurrency(c.cost)}</td>
                            <td className="px-4 py-3 text-right text-green-600 font-medium">{fmtCurrency(c.grossProfit)}</td>
                            <td className={`px-4 py-3 text-right font-medium ${c.grossMargin >= goals.targetICGrossMarginPct ? 'text-green-600' : 'text-red-600'}`}>
                              {fmtPercent(c.grossMargin)}
                            </td>
                            <td className="px-4 py-3 text-right">{c.loads}</td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot className="bg-blue-900 text-white font-semibold">
                        <tr>
                          <td className="px-4 py-3">TOTAL ({icMetrics.carriers.length} carriers)</td>
                          <td className="px-4 py-3 text-right">{fmtCurrency(icMetrics.totalRevenue)}</td>
                          <td className="px-4 py-3 text-right text-red-300">{fmtCurrency(icMetrics.totalCost)}</td>
                          <td className="px-4 py-3 text-right text-green-300">{fmtCurrency(icMetrics.totalGrossProfit)}</td>
                          <td className={`px-4 py-3 text-right ${icMetrics.avgGrossMargin >= goals.targetICGrossMarginPct ? 'text-green-300' : 'text-red-300'}`}>
                            {fmtPercent(icMetrics.avgGrossMargin)}
                          </td>
                          <td className="px-4 py-3 text-right">{icMetrics.loadCount}</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                ) : (
                  <div className="bg-white rounded-lg shadow-sm p-8 text-center text-gray-500">
                    No IC loads found for this month. Upload TORO data on the Status page.
                  </div>
                )}
              </div>
            )}

            {/* ==================== STATUS TAB ==================== */}
            {activeTab === 'status' && (
              <div className="space-y-4">
                {/* Override Confirmation Dialog */}
                {pendingLogOverride && (
                  <div className="bg-amber-50 border-2 border-amber-400 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">‚ö†Ô∏è</span>
                      <div className="flex-1">
                        <h3 className="font-semibold text-amber-800">Overwrite Existing Log?</h3>
                        <p className="text-sm text-amber-700 mt-1">
                          You already have data logged for <strong>{pendingLogOverride}</strong>.
                          Saving now will replace that log entry.
                        </p>
                        <div className="mt-3 flex gap-3">
                          <button onClick={confirmOverride}
                            className="px-4 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700">
                            Yes, Overwrite
                          </button>
                          <button onClick={cancelOverride}
                            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                <div className="bg-white rounded-lg shadow-sm p-4 flex flex-wrap justify-between items-center gap-3">
                  <div>
                    <h2 className="text-lg font-semibold text-gray-800">Daily Status Update</h2>
                    <p className="text-sm text-gray-500">Upload TORO data, update truck status, then save.</p>
                  </div>
                  <button onClick={saveAndLog} disabled={syncing || pendingLogOverride}
                    className="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50">
                    {syncing ? '‚è≥ Saving...' : 'üíæ Save & Log'}
                  </button>
                </div>

                {/* Missing Trucks Warning */}
                {missingTrucks.length > 0 && (
                  <div className="bg-red-50 border-2 border-red-400 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">üöõ</span>
                      <div className="flex-1">
                        <h3 className="font-semibold text-red-800">Unknown Trucks in TORO Data</h3>
                        <p className="text-sm text-red-700 mt-1">
                          The following truck IDs appear in your TORO export but aren't in your fleet list.
                          Their revenue/miles are counted in totals but won't appear in truck breakdowns.
                        </p>
                        <div className="mt-2 flex flex-wrap gap-2">
                          {missingTrucks.map(id => (
                            <span key={id} className="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                              #{id}
                            </span>
                          ))}
                        </div>
                        <p className="text-sm text-red-600 mt-2">
                          Add these trucks to your fleet below, then re-upload the TORO data.
                        </p>
                      </div>
                      <button onClick={() => setMissingTrucks([])} className="text-red-400 hover:text-red-600">‚úï</button>
                    </div>
                  </div>
                )}

                {/* Status Consistency Warnings */}
                {statusWarnings.length > 0 && shipments.length > 0 && (
                  <div className="bg-orange-50 border-2 border-orange-400 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">üìã</span>
                      <div className="flex-1">
                        <h3 className="font-semibold text-orange-800">Status Mismatches Detected</h3>
                        <p className="text-sm text-orange-700 mt-1">
                          The following trucks have statuses that don't match their load data for {reportDate}:
                        </p>
                        <div className="mt-3 space-y-2">
                          {statusWarnings.filter(w => w.type === 'has_loads_not_active').map(w => (
                            <div key={w.truckId} className="flex items-center justify-between bg-orange-100 rounded-lg px-3 py-2">
                              <div>
                                <span className="font-medium text-orange-900">#{w.truckId}</span>
                                {w.driver && <span className="text-orange-700 ml-2">({w.driver})</span>}
                                <span className="text-orange-700 ml-2">
                                  ‚Äî {w.loadCount} load{w.loadCount > 1 ? 's' : ''} in transit ({fmtCurrency(w.loadRevenue)})
                                  but marked "{w.currentStatus}"
                                </span>
                              </div>
                              <button
                                onClick={() => setTruckStatus(prev => ({ ...prev, [w.truckId]: 'Active' }))}
                                className="px-3 py-1 bg-orange-600 text-white rounded text-sm font-medium hover:bg-orange-700">
                                Set Active
                              </button>
                            </div>
                          ))}
                          {statusWarnings.filter(w => w.type === 'active_no_loads').length > 0 && (
                            <div className="mt-2 pt-2 border-t border-orange-200">
                              <p className="text-sm text-orange-600 mb-2">
                                These trucks are marked Active but have no loads in transit (may be correct):
                              </p>
                              <div className="flex flex-wrap gap-2">
                                {statusWarnings.filter(w => w.type === 'active_no_loads').map(w => (
                                  <span key={w.truckId} className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">
                                    #{w.truckId} {w.driver && `(${w.driver})`}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* TORO Upload */}
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex items-center gap-4">
                    <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 text-sm font-medium">
                      üì§ Upload TORO Export
                      <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                    </label>
                    {shipments.length > 0 && (
                      <span className="text-sm text-green-600">‚úì {shipments.length} shipments loaded</span>
                    )}
                  </div>
                </div>

                {/* Truck Status Table */}
                <div className="bg-white rounded-lg shadow-sm overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-800 text-white">
                      <tr>
                        <th className="px-3 py-3 text-left">Truck #</th>
                        <th className="px-3 py-3 text-left">Ownership</th>
                        <th className="px-3 py-3 text-left">Driver</th>
                        <th className="px-3 py-3 text-left">Status</th>
                        <th className="px-3 py-3 text-left">Exp. Return</th>
                        <th className="px-3 py-3 text-left">Notes</th>
                        <th className="px-3 py-3 text-center">Remove</th>
                      </tr>
                    </thead>
                    <tbody>
                      {fleet.map((truck, idx) => {
                        const status = truckStatus[truck.id] || '';
                        const showExpReturn = status && !['Active', 'Spare', ''].includes(status);

                        return (
                          <tr key={truck.id || idx} className={`${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} ${truck.ownershipType === 'Owner-Operator' ? 'border-l-4 border-purple-400' : ''}`}>
                            <td className="px-3 py-2">
                              <input type="text" value={truck.id}
                                onChange={(e) => updateFleetField(idx, 'id', e.target.value)}
                                className="w-20 border rounded px-2 py-1 font-semibold" />
                            </td>
                            <td className="px-3 py-2">
                              <select value={truck.ownershipType || 'Company'}
                                onChange={(e) => updateFleetField(idx, 'ownershipType', e.target.value)}
                                className={`w-full border rounded px-2 py-1 ${truck.ownershipType === 'Owner-Operator' ? 'bg-purple-50 text-purple-800' : 'bg-blue-50 text-blue-800'}`}>
                                {ownershipTypes.map(t => <option key={t} value={t}>{t}</option>)}
                              </select>
                            </td>
                            <td className="px-3 py-2">
                              <input type="text" value={truck.driver}
                                onChange={(e) => updateFleetField(idx, 'driver', e.target.value)}
                                className="w-full border rounded px-2 py-1" placeholder="Driver name" />
                            </td>
                            <td className="px-3 py-2">
                              <select value={status}
                                onChange={(e) => setTruckStatus({ ...truckStatus, [truck.id]: e.target.value })}
                                className={`w-full px-2 py-1 rounded text-sm font-medium border-0 ${getStatusClass(status)}`}>
                                <option value="">Select...</option>
                                {statusOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                              </select>
                            </td>
                            <td className="px-3 py-2">
                              {showExpReturn ? (
                                <input type="date" value={truckExpectedReturn[truck.id] || ''}
                                  onChange={(e) => setTruckExpectedReturn({ ...truckExpectedReturn, [truck.id]: e.target.value })}
                                  className="w-full px-2 py-1 border rounded text-sm" />
                              ) : (
                                <span className="text-gray-300">‚Äî</span>
                              )}
                            </td>
                            <td className="px-3 py-2">
                              <input type="text" value={truck.notes || ''}
                                onChange={(e) => updateFleetField(idx, 'notes', e.target.value)}
                                className="w-full border rounded px-2 py-1" placeholder="Notes..." />
                            </td>
                            <td className="px-3 py-2 text-center">
                              <button onClick={() => requestRemoveTruck(idx, truck.id)}
                                className="text-red-500 hover:text-red-700 font-bold"
                                title="Remove truck"
                                aria-label={`Remove truck ${truck.id || 'at row ' + (idx + 1)}`}>‚úï</button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>

                <button onClick={() => setFleet([...fleet, { id: '', ownershipType: 'Company', driver: '', notes: '' }])}
                  className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                  + Add Truck
                </button>
              </div>
            )}

            {/* ==================== REPORTS TAB ==================== */}
            {activeTab === 'reports' && (
              <ReportsTab
                dailyLogs={dailyLogs}
                fleet={fleet}
                goals={goals}
                truckStatus={truckStatus}
                truckExpectedReturn={truckExpectedReturn}
              />
            )}

            {/* ==================== SETTINGS TAB ==================== */}
            {activeTab === 'settings' && (
              <div className="space-y-4">
                {/* Settings Sub-tabs */}
                <div className="flex gap-1 border-b border-gray-200">
                  {[
                    { id: 'goals', label: 'Goals & Targets' },
                    { id: 'monthly', label: 'Monthly Plan' },
                    { id: 'fixedcosts', label: 'Fixed Costs', badge: expiredFixedCosts.hasExpired ? 'red' : expiredFixedCosts.expiringSoon.length > 0 ? 'yellow' : null },
                    { id: 'data', label: 'Data Management' }
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setSettingsSubTab(tab.id)}
                      className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 ${
                        settingsSubTab === tab.id
                          ? 'border-blue-600 text-blue-600'
                          : 'border-transparent text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      {tab.label}
                      {tab.badge === 'red' && <span className="w-2 h-2 rounded-full bg-red-500"></span>}
                      {tab.badge === 'yellow' && <span className="w-2 h-2 rounded-full bg-yellow-500"></span>}
                    </button>
                  ))}
                </div>

                {/* Goals & Targets Sub-tab */}
                {settingsSubTab === 'goals' && (
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-lg font-semibold text-gray-800">Goals & Targets</h2>
                      <button onClick={saveGoals} disabled={syncing}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50">
                        üíæ Save Goals
                      </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Workdays in Month</label>
                        <input type="number" min="1" max="31" value={goals.workdaysInMonth}
                          onChange={(e) => setGoals({ ...goals, workdaysInMonth: validateGoalInput(e.target.value, 1, 31, 22) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Daily Revenue / Truck ($)</label>
                        <input type="number" min="1" value={goals.dailyRevenuePerTruck}
                          onChange={(e) => setGoals({ ...goals, dailyRevenuePerTruck: validateGoalInput(e.target.value, 1, null, 940) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Daily Miles / Truck</label>
                        <input type="number" min="1" value={goals.dailyMilesPerTruck}
                          onChange={(e) => setGoals({ ...goals, dailyMilesPerTruck: validateGoalInput(e.target.value, 1, null, 412) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Floor: $/Total Mile</label>
                        <input type="number" step="0.01" min="0.01" value={goals.targetRevPerTotalMile}
                          onChange={(e) => setGoals({ ...goals, targetRevPerTotalMile: validateGoalInput(e.target.value, 0.01, null, 2.28) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Floor: $/Loaded Mile</label>
                        <input type="number" step="0.01" min="0.01" value={goals.targetRevPerLoadedMile}
                          onChange={(e) => setGoals({ ...goals, targetRevPerLoadedMile: validateGoalInput(e.target.value, 0.01, null, 2.75) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Floor: Utilization (%)</label>
                        <input type="number" min="1" max="100" value={Math.round(goals.targetUtilization * 100)}
                          onChange={(e) => setGoals({ ...goals, targetUtilization: validateGoalInput(e.target.value, 1, 100, 85) / 100 })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                    </div>

                    <h3 className="text-md font-semibold text-purple-800 mt-6 mb-3">IC / Carrier Goals</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Daily IC Gross Margin $ Target</label>
                        <input type="number" min="0" value={goals.dailyICGrossMargin}
                          onChange={(e) => setGoals({ ...goals, dailyICGrossMargin: validateGoalInput(e.target.value, 0, null, 150) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">IC Gross Margin % Floor</label>
                        <input type="number" step="0.1" min="0" max="100" value={goals.targetICGrossMarginPct}
                          onChange={(e) => setGoals({ ...goals, targetICGrossMarginPct: validateGoalInput(e.target.value, 0, 100, 15) })}
                          className="w-full border rounded px-3 py-2" />
                      </div>
                    </div>

                    <div className="mt-4 p-3 bg-gray-100 rounded text-sm space-y-1">
                      <div><strong>Company:</strong> {totalGoals.trucksIncluded} trucks ‚Üí {fmtCurrency(totalGoals.revenue)}/month revenue, {fmt(totalGoals.miles)} miles</div>
                      <div><strong>IC:</strong> ${goals.dailyICGrossMargin}/day √ó {goals.workdaysInMonth} days = {fmtCurrency(totalGoals.icGrossMargin)} GM$/month</div>
                    </div>
                  </div>
                )}

                {/* Monthly Plan Sub-tab */}
                {settingsSubTab === 'monthly' && (
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">Monthly Truck Plan ({reportMonth})</h2>
                    <p className="text-sm text-gray-500 mb-4">Include/exclude trucks and set pro-rated dates for this month.</p>

                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-100">
                          <tr>
                            <th className="px-3 py-2 text-left">Truck</th>
                            <th className="px-3 py-2 text-left">Ownership</th>
                            <th className="px-3 py-2 text-center">In Plan</th>
                            <th className="px-3 py-2 text-left">Start Date</th>
                            <th className="px-3 py-2 text-left">End Date</th>
                            <th className="px-3 py-2 text-right">Daily Rev</th>
                            <th className="px-3 py-2 text-right">Daily Mi</th>
                            <th className="px-3 py-2 text-right">Month Goal</th>
                          </tr>
                        </thead>
                        <tbody>
                          {fleet.map((truck, idx) => {
                            const plan = getTruckPlan(truck.id);
                            const tg = truckGoals[truck.id];

                            return (
                              <tr key={truck.id || idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                <td className="px-3 py-2 font-semibold">{truck.id}</td>
                                <td className="px-3 py-2">
                                  <span className={`px-2 py-0.5 rounded text-xs font-medium ${truck.ownershipType === 'Owner-Operator' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                    {truck.ownershipType === 'Owner-Operator' ? 'O/O' : 'Company'}
                                  </span>
                                </td>
                                <td className="px-3 py-2 text-center">
                                  <input type="checkbox" checked={plan.included}
                                    onChange={(e) => setTruckPlan(truck.id, { included: e.target.checked })}
                                    className="w-4 h-4" />
                                </td>
                                <td className="px-3 py-2">
                                  {plan.included && (
                                    <input type="date" value={plan.startDate || `${reportMonth}-01`}
                                      onChange={(e) => setTruckPlan(truck.id, { startDate: e.target.value })}
                                      className="border rounded px-2 py-1 text-sm" />
                                  )}
                                </td>
                                <td className="px-3 py-2">
                                  {plan.included && (
                                    <input type="date" value={plan.endDate || ''}
                                      onChange={(e) => setTruckPlan(truck.id, { endDate: e.target.value || null })}
                                      className="border rounded px-2 py-1 text-sm" placeholder="End of month" />
                                  )}
                                </td>
                                <td className="px-3 py-2 text-right">
                                  {plan.included ? (
                                    <input type="number" value={plan.dailyRevenue || goals.dailyRevenuePerTruck}
                                      onChange={(e) => setTruckPlan(truck.id, { dailyRevenue: parseInt(e.target.value) })}
                                      className="w-20 border rounded px-2 py-1 text-sm text-right" />
                                  ) : '‚Äî'}
                                </td>
                                <td className="px-3 py-2 text-right">
                                  {plan.included ? (
                                    <input type="number" value={plan.dailyMiles || goals.dailyMilesPerTruck}
                                      onChange={(e) => setTruckPlan(truck.id, { dailyMiles: parseInt(e.target.value) })}
                                      className="w-20 border rounded px-2 py-1 text-sm text-right" />
                                  ) : '‚Äî'}
                                </td>
                                <td className="px-3 py-2 text-right font-medium">
                                  {tg?.included ? fmtCurrency(tg.revenueGoal) : '‚Äî'}
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                        <tfoot className="bg-gray-100 font-semibold">
                          <tr>
                            <td className="px-3 py-2" colSpan="7">TOTAL</td>
                            <td className="px-3 py-2 text-right">{fmtCurrency(totalGoals.revenue)}</td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                )}

                {/* Fixed Costs Sub-tab */}
                {settingsSubTab === 'fixedcosts' && (
                  <div className="space-y-6">
                    {/* Expiration Warnings */}
                    {(expiredFixedCosts.hasExpired || expiredFixedCosts.expiringSoon.length > 0) && (
                      <div className={`rounded-lg p-4 ${expiredFixedCosts.hasExpired ? 'bg-red-50 border-2 border-red-300' : 'bg-yellow-50 border border-yellow-300'}`}>
                        {expiredFixedCosts.hasExpired && (
                          <div className="mb-2">
                            <h3 className="font-semibold text-red-800 flex items-center gap-2">
                              <span className="text-lg">üö®</span> Expired Fixed Costs
                            </h3>
                            <p className="text-sm text-red-700 mt-1">These must be updated before you can use the Profitability module:</p>
                            <ul className="list-disc list-inside text-sm text-red-700 mt-1">
                              {expiredFixedCosts.expired.map((item, i) => (
                                <li key={i}>Truck #{item.truck} - {item.type} (expired {item.date})</li>
                              ))}
                            </ul>
                          </div>
                        )}
                        {expiredFixedCosts.expiringSoon.length > 0 && (
                          <div>
                            <h3 className="font-semibold text-yellow-800 flex items-center gap-2">
                              <span className="text-lg">‚ö†Ô∏è</span> Expiring Within 30 Days
                            </h3>
                            <ul className="list-disc list-inside text-sm text-yellow-700 mt-1">
                              {expiredFixedCosts.expiringSoon.map((item, i) => (
                                <li key={i}>Truck #{item.truck} - {item.type} (expires {item.date})</li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    )}

                    <div className="bg-white rounded-lg shadow-sm p-6">
                      <div className="flex justify-between items-center mb-4">
                        <div>
                          <h2 className="text-lg font-semibold text-gray-800">Company Truck Fixed Costs (Monthly)</h2>
                          <p className="text-sm text-gray-500">Set once - applies to all monthly profitability calculations</p>
                        </div>
                        <button onClick={saveProfitabilityConfig} disabled={profitabilitySaving}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50">
                          {profitabilitySaving ? '‚è≥ Saving...' : 'üíæ Save Fixed Costs'}
                        </button>
                      </div>

                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-100">
                            <tr>
                              <th className="px-2 py-2 text-left">Truck</th>
                              <th className="px-2 py-2 text-left">Driver</th>
                              <th className="px-2 py-2 text-right">P&I</th>
                              <th className="px-2 py-2 text-center">P&I Exp.</th>
                              <th className="px-2 py-2 text-right">Liability</th>
                              <th className="px-2 py-2 text-center">Liab. Exp.</th>
                              <th className="px-2 py-2 text-right">Damage</th>
                              <th className="px-2 py-2 text-center">Dmg. Exp.</th>
                              <th className="px-2 py-2 text-right">Tolls</th>
                              <th className="px-2 py-2 text-right font-bold">Total</th>
                            </tr>
                          </thead>
                          <tbody>
                            {fleet.filter(t => t.ownershipType !== 'Owner-Operator').map((truck, idx) => {
                              const fc = truckFixedCosts[truck.id] || {};
                              const total = (fc.pi || 0) + (fc.liability || 0) + (fc.damage || 0) + (fc.tolls || 0);
                              const piStatus = getExpirationStatus(fc.piExpires);
                              const liabStatus = getExpirationStatus(fc.liabilityExpires);
                              const dmgStatus = getExpirationStatus(fc.damageExpires);

                              return (
                                <tr key={truck.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                  <td className="px-2 py-2 font-medium">#{truck.id}</td>
                                  <td className="px-2 py-2 text-gray-600 text-xs">{truck.driver || '‚Äî'}</td>
                                  <td className="px-2 py-2">
                                    <input type="number" value={fc.pi || ''} placeholder="0"
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], pi: parseFloat(e.target.value) || 0 }
                                      }))}
                                      className="w-16 border rounded px-1 py-1 text-right text-sm" />
                                  </td>
                                  <td className="px-2 py-2">
                                    <input type="date" value={fc.piExpires || ''}
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], piExpires: e.target.value }
                                      }))}
                                      className={`w-28 border rounded px-1 py-1 text-xs ${piStatus === 'expired' ? 'bg-red-100 border-red-400' : piStatus === 'warning' ? 'bg-yellow-100 border-yellow-400' : ''}`} />
                                  </td>
                                  <td className="px-2 py-2">
                                    <input type="number" value={fc.liability || ''} placeholder="0"
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], liability: parseFloat(e.target.value) || 0 }
                                      }))}
                                      className="w-16 border rounded px-1 py-1 text-right text-sm" />
                                  </td>
                                  <td className="px-2 py-2">
                                    <input type="date" value={fc.liabilityExpires || ''}
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], liabilityExpires: e.target.value }
                                      }))}
                                      className={`w-28 border rounded px-1 py-1 text-xs ${liabStatus === 'expired' ? 'bg-red-100 border-red-400' : liabStatus === 'warning' ? 'bg-yellow-100 border-yellow-400' : ''}`} />
                                  </td>
                                  <td className="px-2 py-2">
                                    <input type="number" value={fc.damage || ''} placeholder="0"
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], damage: parseFloat(e.target.value) || 0 }
                                      }))}
                                      className="w-16 border rounded px-1 py-1 text-right text-sm" />
                                  </td>
                                  <td className="px-2 py-2">
                                    <input type="date" value={fc.damageExpires || ''}
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], damageExpires: e.target.value }
                                      }))}
                                      className={`w-28 border rounded px-1 py-1 text-xs ${dmgStatus === 'expired' ? 'bg-red-100 border-red-400' : dmgStatus === 'warning' ? 'bg-yellow-100 border-yellow-400' : ''}`} />
                                  </td>
                                  <td className="px-2 py-2">
                                    <input type="number" value={fc.tolls || ''} placeholder="0"
                                      onChange={(e) => setTruckFixedCosts(prev => ({
                                        ...prev,
                                        [truck.id]: { ...prev[truck.id], tolls: parseFloat(e.target.value) || 0 }
                                      }))}
                                      className="w-16 border rounded px-1 py-1 text-right text-sm" />
                                  </td>
                                  <td className="px-2 py-2 text-right font-medium">{fmtCurrency(total)}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                          <tfoot className="bg-gray-200 font-semibold">
                            <tr>
                              <td colSpan="9" className="px-2 py-2">Total Fixed Costs</td>
                              <td className="px-2 py-2 text-right">
                                {fmtCurrency(Object.values(truckFixedCosts).reduce((sum, fc) =>
                                  sum + (fc.pi || 0) + (fc.liability || 0) + (fc.damage || 0) + (fc.tolls || 0), 0))}
                              </td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>

                    {/* IC Fixed Costs */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                      <h3 className="font-semibold text-gray-800 mb-3">IC Fixed Costs (Monthly)</h3>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="flex gap-4 mb-4">
                          <label className="flex items-center gap-2">
                            <input type="radio" name="icCostModeSettings" checked={icFixedCosts.mode === 'fleet'}
                              onChange={() => setICFixedCosts(prev => ({ ...prev, mode: 'fleet' }))} />
                            <span className="text-sm">Fleet-wide (split by revenue)</span>
                          </label>
                          <label className="flex items-center gap-2">
                            <input type="radio" name="icCostModeSettings" checked={icFixedCosts.mode === 'carrier'}
                              onChange={() => setICFixedCosts(prev => ({ ...prev, mode: 'carrier' }))} />
                            <span className="text-sm">Per-carrier</span>
                          </label>
                        </div>

                        {icFixedCosts.mode === 'fleet' && (
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Trailer Insurance</label>
                              <input type="number" value={icFixedCosts.fleetCosts?.trailerIns || ''} placeholder="0"
                                onChange={(e) => setICFixedCosts(prev => ({
                                  ...prev,
                                  fleetCosts: { ...prev.fleetCosts, trailerIns: parseFloat(e.target.value) || 0 }
                                }))}
                                className="w-full border rounded px-2 py-1 text-sm" />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Trailer Rental</label>
                              <input type="number" value={icFixedCosts.fleetCosts?.rental || ''} placeholder="0"
                                onChange={(e) => setICFixedCosts(prev => ({
                                  ...prev,
                                  fleetCosts: { ...prev.fleetCosts, rental: parseFloat(e.target.value) || 0 }
                                }))}
                                className="w-full border rounded px-2 py-1 text-sm" />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Tolls/Fees</label>
                              <input type="number" value={icFixedCosts.fleetCosts?.tolls || ''} placeholder="0"
                                onChange={(e) => setICFixedCosts(prev => ({
                                  ...prev,
                                  fleetCosts: { ...prev.fleetCosts, tolls: parseFloat(e.target.value) || 0 }
                                }))}
                                className="w-full border rounded px-2 py-1 text-sm" />
                            </div>
                          </div>
                        )}

                        {icFixedCosts.mode === 'carrier' && (
                          <p className="text-sm text-gray-500">Per-carrier costs will be entered when processing profitability data.</p>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {/* Data Management Sub-tab */}
                {settingsSubTab === 'data' && (
                  <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">Data Management</h2>
                    <div className="flex flex-wrap gap-3">
                      <button onClick={exportData}
                        className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                        üì• Export All Data
                      </button>
                      <label className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 cursor-pointer">
                        üì§ Import Data
                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                      </label>
                      <button onClick={() => {
                        if (confirm('This will clear all cached data and reset the fleet to defaults. Are you sure?')) {
                          localStorage.clear();
                          window.location.reload();
                        }
                      }}
                        className="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200">
                        üóëÔ∏è Clear Cache & Reset
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ==================== PROFITABILITY TAB ==================== */}
            {activeTab === 'profitability' && (
              <div className="space-y-6">
                {/* Header with Month Selector */}
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex flex-wrap items-center justify-between gap-4">
                    <div>
                      <h2 className="text-lg font-semibold text-gray-800">Monthly Profitability Close</h2>
                      <p className="text-sm text-gray-500">Calculate truck profitability and bonuses for month-end close</p>
                    </div>
                    <div className="flex items-center gap-3">
                      <select
                        value={profitabilityMonth}
                        onChange={(e) => setProfitabilityMonth(e.target.value)}
                        disabled={monthsClosed.includes(profitabilityMonth)}
                        className="border rounded-lg px-3 py-2 text-sm font-medium"
                      >
                        <option value="">Select Month...</option>
                        {(() => {
                          const options = [];
                          const now = new Date();
                          for (let i = 0; i < 6; i++) {
                            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                            const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                            options.push(<option key={val} value={val}>{label}</option>);
                          }
                          return options;
                        })()}
                      </select>
                      {profitabilityMonth && monthsClosed.includes(profitabilityMonth) && (
                        <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                          üîí Closed
                        </span>
                      )}
                    </div>
                  </div>
                </div>

                {!profitabilityMonth ? (
                  <div className="bg-blue-50 rounded-lg p-8 text-center">
                    <div className="text-4xl mb-3">üìä</div>
                    <h3 className="font-semibold text-blue-800">Select a Month to Begin</h3>
                    <p className="text-blue-600 text-sm mt-1">Choose a month above to upload data and calculate profitability</p>
                  </div>
                ) : (
                  <>
                    {/* Sub-tab Navigation */}
                    <div className="bg-white rounded-lg shadow-sm">
                      <div className="flex border-b">
                        {[
                          { id: 'uploads', label: 'üì§ Data Uploads' },
                          { id: 'calculations', label: 'üìä Calculations' },
                          { id: 'warnings', label: `‚ö†Ô∏è Warnings (${profitabilityWarnings.length})` },
                        ].map(tab => (
                          <button
                            key={tab.id}
                            onClick={() => setProfitabilitySubTab(tab.id)}
                            className={`px-4 py-3 text-sm font-medium transition-colors ${
                              profitabilitySubTab === tab.id
                                ? 'border-b-2 border-blue-600 text-blue-600 bg-blue-50'
                                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                            }`}
                          >
                            {tab.label}
                          </button>
                        ))}
                      </div>

                      <div className="p-4">
                        {/* UPLOADS SUB-TAB */}
                        {profitabilitySubTab === 'uploads' && (
                          <div className="space-y-6">
                            {/* TORO Data Summary */}
                            <div>
                              <h3 className="font-semibold text-gray-800 mb-3">TORO Booked Order Summary</h3>
                              <div className="bg-gray-50 rounded-lg p-4">
                                {profitabilityToro.length > 0 ? (
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                      <div className="text-gray-500">Total Loads</div>
                                      <div className="font-semibold text-lg">{profitabilityToro.length}</div>
                                    </div>
                                    <div>
                                      <div className="text-gray-500">Company Loads</div>
                                      <div className="font-semibold text-lg">{profitabilityToro.filter(s => !s.isIC).length}</div>
                                    </div>
                                    <div>
                                      <div className="text-gray-500">IC Loads</div>
                                      <div className="font-semibold text-lg">{profitabilityToro.filter(s => s.isIC).length}</div>
                                    </div>
                                    <div>
                                      <div className="text-gray-500">Total Revenue</div>
                                      <div className="font-semibold text-lg">{fmtCurrency(profitabilityToro.reduce((sum, s) => sum + (s.revenue || 0), 0))}</div>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="text-center text-gray-500 py-4">
                                    <p>No TORO data loaded for {profitabilityMonth}</p>
                                    <label className="mt-2 inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 text-sm font-medium">
                                      üì§ Upload TORO Export
                                      <input type="file" accept=".csv" onChange={handleProfitabilityToroUpload} className="hidden" />
                                    </label>
                                  </div>
                                )}
                              </div>
                              {profitabilityToro.length > 0 && (
                                <div className="mt-2 flex gap-2">
                                  <label className="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg cursor-pointer hover:bg-blue-200 text-sm font-medium">
                                    üîÑ Re-upload
                                    <input type="file" accept=".csv" onChange={handleProfitabilityToroUpload} className="hidden" />
                                  </label>
                                  <button onClick={() => setProfitabilityToro([])} className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200">
                                    Clear
                                  </button>
                                </div>
                              )}
                            </div>

                            {/* Fuel Data */}
                            <div>
                              <h3 className="font-semibold text-gray-800 mb-3">Fuel Data</h3>
                              <div className="bg-gray-50 rounded-lg p-4">
                                {fuelData.length > 0 ? (
                                  <div className="space-y-3">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                      <div>
                                        <div className="text-gray-500">Total Transactions</div>
                                        <div className="font-semibold text-lg">{fuelData.length}</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-500">Unique Trucks</div>
                                        <div className="font-semibold text-lg">{new Set(fuelData.map(f => f.truckNumber)).size}</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-500">Total Fuel Cost</div>
                                        <div className="font-semibold text-lg text-red-600">{fmtCurrency(fuelData.reduce((sum, f) => sum + f.totalCost, 0))}</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-500">Total Gallons</div>
                                        <div className="font-semibold text-lg">{fmtDecimal(fuelData.reduce((sum, f) => sum + f.gallons, 0), 1)}</div>
                                      </div>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="text-center text-gray-500 py-4">
                                    <p>No fuel data loaded</p>
                                    <label className="mt-2 inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 text-sm font-medium">
                                      üì§ Upload Fuel CSV
                                      <input type="file" accept=".csv" onChange={handleFuelUpload} className="hidden" />
                                    </label>
                                  </div>
                                )}
                              </div>
                              {fuelData.length > 0 && (
                                <div className="mt-2 flex gap-2">
                                  <label className="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg cursor-pointer hover:bg-blue-200 text-sm font-medium">
                                    üîÑ Re-upload
                                    <input type="file" accept=".csv" onChange={handleFuelUpload} className="hidden" />
                                  </label>
                                  <button onClick={() => setFuelData([])} className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200">
                                    Clear
                                  </button>
                                </div>
                              )}
                            </div>

                            {/* Expense/Maintenance Data */}
                            <div>
                              <h3 className="font-semibold text-gray-800 mb-3">Expense / Maintenance Data</h3>
                              <div className="bg-gray-50 rounded-lg p-4">
                                {expenseData.length > 0 ? (
                                  <div className="space-y-3">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                      <div>
                                        <div className="text-gray-500">Total Expenses</div>
                                        <div className="font-semibold text-lg">{expenseData.length}</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-500">With Truck Attr.</div>
                                        <div className="font-semibold text-lg">{expenseData.filter(e => e.truckAttr.length > 0).length}</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-500">With Trailer Attr.</div>
                                        <div className="font-semibold text-lg">{expenseData.filter(e => e.trailerAttr.length > 0).length}</div>
                                      </div>
                                      <div>
                                        <div className="text-gray-500">Total Amount</div>
                                        <div className="font-semibold text-lg text-red-600">{fmtCurrency(expenseData.reduce((sum, e) => sum + e.amount, 0))}</div>
                                      </div>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="text-center text-gray-500 py-4">
                                    <p>No expense data loaded</p>
                                    <label className="mt-2 inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 text-sm font-medium">
                                      üì§ Upload Expense CSV
                                      <input type="file" accept=".csv" onChange={handleExpenseUpload} className="hidden" />
                                    </label>
                                  </div>
                                )}
                              </div>
                              {expenseData.length > 0 && (
                                <div className="mt-2 flex gap-2">
                                  <label className="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg cursor-pointer hover:bg-blue-200 text-sm font-medium">
                                    üîÑ Re-upload
                                    <input type="file" accept=".csv" onChange={handleExpenseUpload} className="hidden" />
                                  </label>
                                  <button onClick={() => setExpenseData([])} className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200">
                                    Clear
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {/* CALCULATIONS SUB-TAB */}
                        {profitabilitySubTab === 'calculations' && (
                          <div className="space-y-6">
                            {/* BLOCKING CHECK FOR EXPIRED FIXED COSTS */}
                            {expiredFixedCosts.hasExpired ? (
                              <div className="bg-red-50 border-2 border-red-300 rounded-xl p-8 text-center">
                                <div className="text-5xl mb-4">üö®</div>
                                <h2 className="text-xl font-bold text-red-800 mb-2">Expired Fixed Costs Detected</h2>
                                <p className="text-red-700 mb-4">
                                  You have {expiredFixedCosts.expired.length} expired fixed cost{expiredFixedCosts.expired.length > 1 ? 's' : ''} that must be updated before you can run profitability calculations.
                                </p>
                                <div className="bg-white rounded-lg p-4 mb-4 inline-block text-left">
                                  <ul className="text-sm text-red-700 space-y-1">
                                    {expiredFixedCosts.expired.map((item, i) => (
                                      <li key={i}>‚Ä¢ Truck #{item.truck} - {item.type} (expired {item.date})</li>
                                    ))}
                                  </ul>
                                </div>
                                <div>
                                  <button
                                    onClick={() => { setActiveTab('settings'); setSettingsSubTab('fixedcosts'); }}
                                    className="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors"
                                  >
                                    Go to Settings ‚Üí Fixed Costs
                                  </button>
                                </div>
                              </div>
                            ) : profitabilityToro.length === 0 ? (
                              <div className="text-center py-8 text-gray-500">
                                <div className="text-4xl mb-2">üìä</div>
                                <p>Upload TORO data to see profitability calculations</p>
                              </div>
                            ) : (
                              <>
                                {/* COMPANY-WIDE SUMMARY */}
                                <div className="bg-gradient-to-r from-gray-800 to-gray-700 rounded-xl p-6 text-white">
                                  <h2 className="text-xl font-bold mb-4">Company-Wide Summary</h2>
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                      <div className="text-gray-300 text-sm">Total Revenue</div>
                                      <div className="text-2xl font-bold">{fmtCurrency(profitabilityCalc.grandTotals.revenue)}</div>
                                    </div>
                                    <div>
                                      <div className="text-gray-300 text-sm">Total Expenses</div>
                                      <div className="text-2xl font-bold text-red-300">
                                        {fmtCurrency(profitabilityCalc.grandTotals.revenue - profitabilityCalc.grandTotals.grossProfit)}
                                      </div>
                                    </div>
                                    <div>
                                      <div className="text-gray-300 text-sm">Gross Profit</div>
                                      <div className={`text-2xl font-bold ${profitabilityCalc.grandTotals.grossProfit >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                        {fmtCurrency(profitabilityCalc.grandTotals.grossProfit)}
                                      </div>
                                    </div>
                                    <div>
                                      <div className="text-gray-300 text-sm">Gross Margin</div>
                                      <div className="text-2xl font-bold">
                                        {profitabilityCalc.grandTotals.revenue > 0
                                          ? ((profitabilityCalc.grandTotals.grossProfit / profitabilityCalc.grandTotals.revenue) * 100).toFixed(1) + '%'
                                          : '‚Äî'}
                                      </div>
                                    </div>
                                  </div>
                                  <div className="mt-4 pt-4 border-t border-gray-600 grid grid-cols-3 gap-4 text-sm">
                                    <div className="flex justify-between">
                                      <span className="text-gray-400">Company Trucks:</span>
                                      <span className="font-semibold">{fmtCurrency(profitabilityCalc.companyTotals.grossProfit)} GP</span>
                                    </div>
                                    <div className="flex justify-between">
                                      <span className="text-gray-400">Owner-Operators:</span>
                                      <span className="font-semibold">{fmtCurrency(profitabilityCalc.ownerOperatorTotals.grossProfit)} GP</span>
                                    </div>
                                    <div className="flex justify-between">
                                      <span className="text-gray-400">ICs:</span>
                                      <span className="font-semibold">{fmtCurrency(profitabilityCalc.icTotals.grossProfit)} GP</span>
                                    </div>
                                  </div>
                                </div>

                                {/* VAN SECTION */}
                                {profitabilityCalc.byTrailerType.Van.totals.loads > 0 && (
                                  <div className="border-2 border-cyan-200 rounded-xl overflow-hidden">
                                    <div className="bg-cyan-600 text-white px-4 py-3 flex justify-between items-center">
                                      <h3 className="text-lg font-bold">üì¶ Van</h3>
                                      <div className="flex gap-6 text-sm">
                                        <span>Revenue: {fmtCurrency(profitabilityCalc.byTrailerType.Van.totals.revenue)}</span>
                                        <span className={profitabilityCalc.byTrailerType.Van.totals.grossProfit >= 0 ? 'text-green-200' : 'text-red-200'}>
                                          GP: {fmtCurrency(profitabilityCalc.byTrailerType.Van.totals.grossProfit)}
                                        </span>
                                        <span>{profitabilityCalc.byTrailerType.Van.totals.loads} loads</span>
                                      </div>
                                    </div>

                                    {/* Van - Company Trucks */}
                                    {Object.keys(profitabilityCalc.byTrailerType.Van.company.trucks).length > 0 && (
                                      <div className="p-4 border-b border-cyan-100">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                          <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">COMPANY</span>
                                          Company Trucks
                                        </h4>
                                        <div className="overflow-x-auto">
                                          <table className="w-full text-sm">
                                            <thead className="bg-blue-50">
                                              <tr>
                                                <th className="px-2 py-1 text-left">Truck</th>
                                                <th className="px-2 py-1 text-right">Revenue</th>
                                                <th className="px-2 py-1 text-right">Driver</th>
                                                <th className="px-2 py-1 text-right">Fuel</th>
                                                <th className="px-2 py-1 text-right">Maint</th>
                                                <th className="px-2 py-1 text-right">Fixed</th>
                                                <th className="px-2 py-1 text-right">Factor</th>
                                                <th className="px-2 py-1 text-right font-bold">Gross Profit</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {Object.entries(profitabilityCalc.byTrailerType.Van.company.trucks)
                                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                                .map(([truck, data], idx) => (
                                                <tr key={truck} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                  <td className="px-2 py-1 font-medium">#{truck}</td>
                                                  <td className="px-2 py-1 text-right">{fmtCurrency(data.revenue)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.driverPay)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fuel)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.truckMaint + data.trailerMaint)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fixedCosts)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.factoring)}</td>
                                                  <td className={`px-2 py-1 text-right font-bold ${data.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {fmtCurrency(data.grossProfit)}
                                                  </td>
                                                </tr>
                                              ))}
                                            </tbody>
                                            <tfoot className="bg-blue-100 font-semibold">
                                              <tr>
                                                <td className="px-2 py-1">Subtotal</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.revenue)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.driverPay)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.fuel)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.truckMaint + profitabilityCalc.byTrailerType.Van.company.totals.trailerMaint)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.fixedCosts)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.factoring)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.company.totals.grossProfit)}</td>
                                              </tr>
                                            </tfoot>
                                          </table>
                                        </div>
                                      </div>
                                    )}

                                    {/* Van - Owner-Operators */}
                                    {Object.keys(profitabilityCalc.byTrailerType.Van.ownerOperator.trucks).length > 0 && (
                                      <div className="p-4 border-b border-cyan-100">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                          <span className="bg-teal-100 text-teal-700 px-2 py-0.5 rounded text-xs">O/O</span>
                                          Owner-Operators
                                        </h4>
                                        <div className="overflow-x-auto">
                                          <table className="w-full text-sm">
                                            <thead className="bg-teal-50">
                                              <tr>
                                                <th className="px-2 py-1 text-left">Truck</th>
                                                <th className="px-2 py-1 text-right">Revenue</th>
                                                <th className="px-2 py-1 text-right">Driver</th>
                                                <th className="px-2 py-1 text-right">Fuel</th>
                                                <th className="px-2 py-1 text-right">Maint</th>
                                                <th className="px-2 py-1 text-right">Fixed</th>
                                                <th className="px-2 py-1 text-right">Factor</th>
                                                <th className="px-2 py-1 text-right font-bold">Gross Profit</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {Object.entries(profitabilityCalc.byTrailerType.Van.ownerOperator.trucks)
                                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                                .map(([truck, data], idx) => (
                                                <tr key={truck} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                  <td className="px-2 py-1 font-medium">#{truck}</td>
                                                  <td className="px-2 py-1 text-right">{fmtCurrency(data.revenue)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.driverPay)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fuel)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.truckMaint + data.trailerMaint)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fixedCosts)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.factoring)}</td>
                                                  <td className={`px-2 py-1 text-right font-bold ${data.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {fmtCurrency(data.grossProfit)}
                                                  </td>
                                                </tr>
                                              ))}
                                            </tbody>
                                            <tfoot className="bg-teal-100 font-semibold">
                                              <tr>
                                                <td className="px-2 py-1">Subtotal</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.revenue)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.driverPay)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.fuel)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.truckMaint + profitabilityCalc.byTrailerType.Van.ownerOperator.totals.trailerMaint)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.fixedCosts)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.factoring)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ownerOperator.totals.grossProfit)}</td>
                                              </tr>
                                            </tfoot>
                                          </table>
                                        </div>
                                      </div>
                                    )}

                                    {/* Van - ICs */}
                                    {Object.keys(profitabilityCalc.byTrailerType.Van.ic.carriers).length > 0 && (
                                      <div className="p-4">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                          <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs">IC</span>
                                          Independent Contractors
                                        </h4>
                                        <div className="overflow-x-auto">
                                          <table className="w-full text-sm">
                                            <thead className="bg-purple-50">
                                              <tr>
                                                <th className="px-2 py-1 text-left">Carrier</th>
                                                <th className="px-2 py-1 text-right">Revenue</th>
                                                <th className="px-2 py-1 text-right">Driver</th>
                                                <th className="px-2 py-1 text-right">Maint</th>
                                                <th className="px-2 py-1 text-right">Fixed</th>
                                                <th className="px-2 py-1 text-right">Factor</th>
                                                <th className="px-2 py-1 text-right font-bold">Gross Profit</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {Object.entries(profitabilityCalc.byTrailerType.Van.ic.carriers)
                                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                                .map(([carrier, data], idx) => (
                                                <tr key={carrier} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                  <td className="px-2 py-1 font-medium">{carrier}</td>
                                                  <td className="px-2 py-1 text-right">{fmtCurrency(data.revenue)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.driverPay)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.trailerMaint)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fixedCosts)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.factoring)}</td>
                                                  <td className={`px-2 py-1 text-right font-bold ${data.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {fmtCurrency(data.grossProfit)}
                                                  </td>
                                                </tr>
                                              ))}
                                            </tbody>
                                            <tfoot className="bg-purple-100 font-semibold">
                                              <tr>
                                                <td className="px-2 py-1">Subtotal</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ic.totals.revenue)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ic.totals.driverPay)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ic.totals.trailerMaint)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ic.totals.fixedCosts)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ic.totals.factoring)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Van.ic.totals.grossProfit)}</td>
                                              </tr>
                                            </tfoot>
                                          </table>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                )}

                                {/* FLATBED SECTION */}
                                {profitabilityCalc.byTrailerType.Flatbed.totals.loads > 0 && (
                                  <div className="border-2 border-orange-200 rounded-xl overflow-hidden">
                                    <div className="bg-orange-600 text-white px-4 py-3 flex justify-between items-center">
                                      <h3 className="text-lg font-bold">üöö Flatbed</h3>
                                      <div className="flex gap-6 text-sm">
                                        <span>Revenue: {fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.totals.revenue)}</span>
                                        <span className={profitabilityCalc.byTrailerType.Flatbed.totals.grossProfit >= 0 ? 'text-green-200' : 'text-red-200'}>
                                          GP: {fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.totals.grossProfit)}
                                        </span>
                                        <span>{profitabilityCalc.byTrailerType.Flatbed.totals.loads} loads</span>
                                      </div>
                                    </div>

                                    {/* Flatbed - Company Trucks */}
                                    {Object.keys(profitabilityCalc.byTrailerType.Flatbed.company.trucks).length > 0 && (
                                      <div className="p-4 border-b border-orange-100">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                          <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">COMPANY</span>
                                          Company Trucks
                                        </h4>
                                        <div className="overflow-x-auto">
                                          <table className="w-full text-sm">
                                            <thead className="bg-blue-50">
                                              <tr>
                                                <th className="px-2 py-1 text-left">Truck</th>
                                                <th className="px-2 py-1 text-right">Revenue</th>
                                                <th className="px-2 py-1 text-right">Driver</th>
                                                <th className="px-2 py-1 text-right">Fuel</th>
                                                <th className="px-2 py-1 text-right">Maint</th>
                                                <th className="px-2 py-1 text-right">Fixed</th>
                                                <th className="px-2 py-1 text-right">Factor</th>
                                                <th className="px-2 py-1 text-right font-bold">Gross Profit</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {Object.entries(profitabilityCalc.byTrailerType.Flatbed.company.trucks)
                                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                                .map(([truck, data], idx) => (
                                                <tr key={truck} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                  <td className="px-2 py-1 font-medium">#{truck}</td>
                                                  <td className="px-2 py-1 text-right">{fmtCurrency(data.revenue)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.driverPay)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fuel)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.truckMaint + data.trailerMaint)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fixedCosts)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.factoring)}</td>
                                                  <td className={`px-2 py-1 text-right font-bold ${data.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {fmtCurrency(data.grossProfit)}
                                                  </td>
                                                </tr>
                                              ))}
                                            </tbody>
                                            <tfoot className="bg-blue-100 font-semibold">
                                              <tr>
                                                <td className="px-2 py-1">Subtotal</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.revenue)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.driverPay)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.fuel)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.truckMaint + profitabilityCalc.byTrailerType.Flatbed.company.totals.trailerMaint)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.fixedCosts)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.factoring)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.company.totals.grossProfit)}</td>
                                              </tr>
                                            </tfoot>
                                          </table>
                                        </div>
                                      </div>
                                    )}

                                    {/* Flatbed - Owner-Operators */}
                                    {Object.keys(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.trucks).length > 0 && (
                                      <div className="p-4 border-b border-orange-100">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                          <span className="bg-teal-100 text-teal-700 px-2 py-0.5 rounded text-xs">O/O</span>
                                          Owner-Operators
                                        </h4>
                                        <div className="overflow-x-auto">
                                          <table className="w-full text-sm">
                                            <thead className="bg-teal-50">
                                              <tr>
                                                <th className="px-2 py-1 text-left">Truck</th>
                                                <th className="px-2 py-1 text-right">Revenue</th>
                                                <th className="px-2 py-1 text-right">Driver</th>
                                                <th className="px-2 py-1 text-right">Fuel</th>
                                                <th className="px-2 py-1 text-right">Maint</th>
                                                <th className="px-2 py-1 text-right">Fixed</th>
                                                <th className="px-2 py-1 text-right">Factor</th>
                                                <th className="px-2 py-1 text-right font-bold">Gross Profit</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {Object.entries(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.trucks)
                                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                                .map(([truck, data], idx) => (
                                                <tr key={truck} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                  <td className="px-2 py-1 font-medium">#{truck}</td>
                                                  <td className="px-2 py-1 text-right">{fmtCurrency(data.revenue)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.driverPay)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fuel)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.truckMaint + data.trailerMaint)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fixedCosts)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.factoring)}</td>
                                                  <td className={`px-2 py-1 text-right font-bold ${data.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {fmtCurrency(data.grossProfit)}
                                                  </td>
                                                </tr>
                                              ))}
                                            </tbody>
                                            <tfoot className="bg-teal-100 font-semibold">
                                              <tr>
                                                <td className="px-2 py-1">Subtotal</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.revenue)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.driverPay)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.fuel)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.truckMaint + profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.trailerMaint)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.fixedCosts)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.factoring)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ownerOperator.totals.grossProfit)}</td>
                                              </tr>
                                            </tfoot>
                                          </table>
                                        </div>
                                      </div>
                                    )}

                                    {/* Flatbed - ICs */}
                                    {Object.keys(profitabilityCalc.byTrailerType.Flatbed.ic.carriers).length > 0 && (
                                      <div className="p-4">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                          <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs">IC</span>
                                          Independent Contractors
                                        </h4>
                                        <div className="overflow-x-auto">
                                          <table className="w-full text-sm">
                                            <thead className="bg-purple-50">
                                              <tr>
                                                <th className="px-2 py-1 text-left">Carrier</th>
                                                <th className="px-2 py-1 text-right">Revenue</th>
                                                <th className="px-2 py-1 text-right">Driver</th>
                                                <th className="px-2 py-1 text-right">Maint</th>
                                                <th className="px-2 py-1 text-right">Fixed</th>
                                                <th className="px-2 py-1 text-right">Factor</th>
                                                <th className="px-2 py-1 text-right font-bold">Gross Profit</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {Object.entries(profitabilityCalc.byTrailerType.Flatbed.ic.carriers)
                                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                                .map(([carrier, data], idx) => (
                                                <tr key={carrier} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                  <td className="px-2 py-1 font-medium">{carrier}</td>
                                                  <td className="px-2 py-1 text-right">{fmtCurrency(data.revenue)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.driverPay)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.trailerMaint)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.fixedCosts)}</td>
                                                  <td className="px-2 py-1 text-right text-red-600">{fmtCurrency(data.factoring)}</td>
                                                  <td className={`px-2 py-1 text-right font-bold ${data.grossProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {fmtCurrency(data.grossProfit)}
                                                  </td>
                                                </tr>
                                              ))}
                                            </tbody>
                                            <tfoot className="bg-purple-100 font-semibold">
                                              <tr>
                                                <td className="px-2 py-1">Subtotal</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ic.totals.revenue)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ic.totals.driverPay)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ic.totals.trailerMaint)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ic.totals.fixedCosts)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ic.totals.factoring)}</td>
                                                <td className="px-2 py-1 text-right">{fmtCurrency(profitabilityCalc.byTrailerType.Flatbed.ic.totals.grossProfit)}</td>
                                              </tr>
                                            </tfoot>
                                          </table>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                )}

                                {/* Unknown trailer type loads are shown as a warning, not in calculations */}

                                {/* Close Month Section */}
                                <div className="bg-gray-50 rounded-xl p-6 border border-gray-200 mt-6">
                                  <h3 className="font-semibold text-gray-800 mb-2">Finalize Month</h3>
                                  <p className="text-sm text-gray-600 mb-4">
                                    Once you've verified all data and calculations, save or close the month for historical records.
                                  </p>
                                  {monthsClosed.includes(profitabilityMonth) ? (
                                    <div className="flex items-center gap-2 text-green-600">
                                      <span>üîí</span>
                                      <span className="font-medium">This month has been closed</span>
                                    </div>
                                  ) : (
                                    <div className="flex gap-3">
                                      <button
                                        onClick={saveProfitabilityData}
                                        disabled={profitabilitySaving}
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
                                      >
                                        {profitabilitySaving ? '‚è≥ Saving...' : 'üíæ Save Progress'}
                                      </button>
                                      <button
                                        onClick={async () => {
                                          if (confirm(`Are you sure you want to close ${profitabilityMonth}? This will save all data and lock the month.`)) {
                                            setMonthsClosed(prev => [...prev, profitabilityMonth]);
                                            await saveProfitabilityData();
                                            showStatus(`${profitabilityMonth} closed and saved ‚úì`, 3000);
                                          }
                                        }}
                                        className="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"
                                      >
                                        üîí Close Month
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </>
                            )}
                          </div>
                        )}

                        {/* WARNINGS SUB-TAB */}
                        {profitabilitySubTab === 'warnings' && (
                          <div className="space-y-4">
                            {profitabilityWarnings.length === 0 ? (
                              <div className="text-center py-8 text-gray-500">
                                <div className="text-4xl mb-2">‚úÖ</div>
                                <p>No warnings - data looks good!</p>
                              </div>
                            ) : (
                              <>
                                {/* Red warnings (critical) */}
                                {profitabilityWarnings.filter(w => w.severity === 'red').map((w, idx) => (
                                  <div key={`red-${idx}`} className="bg-red-50 border-2 border-red-400 rounded-lg p-4">
                                    <div className="flex items-start gap-3">
                                      <span className="text-xl">üö®</span>
                                      <div className="flex-1">
                                        <div className="font-medium text-red-800">{w.message}</div>
                                        {w.description && <div className="text-sm text-red-600 mt-1">{w.description}</div>}
                                        {w.vendor && <div className="text-sm text-red-600 mt-1">Vendor: {w.vendor}</div>}
                                      </div>
                                    </div>
                                  </div>
                                ))}

                                {/* Orange warnings (attention needed) */}
                                {profitabilityWarnings.filter(w => w.severity === 'orange').map((w, idx) => (
                                  <div key={`orange-${idx}`} className="bg-orange-50 border-2 border-orange-400 rounded-lg p-4">
                                    <div className="flex items-start gap-3">
                                      <span className="text-xl">‚ö†Ô∏è</span>
                                      <div className="flex-1">
                                        <div className="font-medium text-orange-800">{w.message}</div>
                                        {w.orderId && <div className="text-sm text-orange-600 mt-1">Order: {w.orderId}</div>}
                                        {w.trailer && <div className="text-sm text-orange-600 mt-1">Trailer: {w.trailer}</div>}
                                      </div>
                                    </div>
                                  </div>
                                ))}

                                {/* Yellow warnings (informational) */}
                                {profitabilityWarnings.filter(w => w.severity === 'yellow').map((w, idx) => (
                                  <div key={`yellow-${idx}`} className="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                                    <div className="flex items-start gap-3">
                                      <span className="text-xl">üí°</span>
                                      <div className="flex-1">
                                        <div className="font-medium text-yellow-800">{w.message}</div>
                                      </div>
                                    </div>
                                  </div>
                                ))}

                                <div className="text-sm text-gray-500 mt-4">
                                  Total: {profitabilityWarnings.length} warning(s) -
                                  {profitabilityWarnings.filter(w => w.severity === 'red').length} critical,
                                  {profitabilityWarnings.filter(w => w.severity === 'orange').length} attention needed,
                                  {profitabilityWarnings.filter(w => w.severity === 'yellow').length} informational
                                </div>
                              </>
                            )}
                          </div>
                        )}

                      </div>
                    </div>
                  </>
                )}
              </div>
            )}

          </main>

          <footer className="text-center text-xs text-gray-400 py-6">
            Coolmore Truck Lines ¬© 2026
          </footer>

          {/* Confirmation Modal */}
          <ConfirmModal
            isOpen={confirmModal.isOpen}
            title="Remove Truck"
            message={`Are you sure you want to remove truck ${confirmModal.truckId || 'this truck'}? This action cannot be undone.`}
            onConfirm={confirmRemoveTruck}
            onCancel={cancelRemoveTruck}
          />
        </div>
      );
    }

    ReactDOM.render(
      <ErrorBoundary>
        <CTLDashboard />
      </ErrorBoundary>,
      document.getElementById('root')
    );
  </script>
</body>
</html>
