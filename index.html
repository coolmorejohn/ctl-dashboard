// ============================================
// CTL Dashboard - Google Apps Script V2.2
// ============================================
// Deploy as Web App with:
// - Execute as: Me
// - Who has access: Anyone
// ============================================
// CHANGELOG:
// v2.2 - Fixed CORS for GitHub Pages by using GET with payload param
// v2.1 - Added MonthlyPlan to readAll and init
// ============================================

// Handle GET requests (for both reading AND writing now)
function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    // Check if this is a write request via payload parameter
    if (e.parameter.payload) {
      const payload = JSON.parse(e.parameter.payload);
      const output = handleRequest({ parameter: payload }, ss);
      return ContentService.createTextOutput(JSON.stringify(output))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // Otherwise handle as normal GET request
    const output = handleRequest(e, ss);
    return ContentService.createTextOutput(JSON.stringify(output))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: error.message,
      stack: error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Handle POST requests (kept for backwards compatibility)
function doPost(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let params;

    try {
      params = JSON.parse(e.postData.contents);
    } catch (err) {
      return ContentService.createTextOutput(JSON.stringify({
        error: 'Invalid JSON',
        details: err.message
      })).setMimeType(ContentService.MimeType.JSON);
    }

    const output = handleRequest({ parameter: params }, ss);
    return ContentService.createTextOutput(JSON.stringify(output))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: error.message,
      stack: error.stack
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleRequest(e, ss) {
  const action = e.parameter.action;
  const sheetName = e.parameter.sheet;

  switch (action) {
    case 'read':
      return readSheet(ss, sheetName);

    case 'write':
      const data = e.parameter.data;
      return writeSheet(ss, sheetName, data);

    case 'init':
      return initializeSheets(ss);

    case 'readAll':
      return readAllSheets(ss);

    default:
      return { error: 'Unknown action', action: action };
  }
}

// Read a single sheet
function readSheet(ss, sheetName) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    return { data: null, exists: false };
  }

  const data = sheet.getDataRange().getValues();
  if (data.length === 0) {
    return { data: null, exists: true, empty: true };
  }

  // For JSON storage, we store everything in cell A1
  const firstCell = data[0][0];
  if (typeof firstCell === 'string' && (firstCell.startsWith('{') || firstCell.startsWith('['))) {
    try {
      return { data: JSON.parse(firstCell), exists: true, format: 'json' };
    } catch (e) {
      // Not valid JSON, return as-is
    }
  }

  return { data: data, exists: true, format: 'array' };
}

// Write to a sheet (stores as JSON in cell A1)
function writeSheet(ss, sheetName, data) {
  let sheet = ss.getSheetByName(sheetName);

  // Create sheet if it doesn't exist
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
  }

  // Clear existing content
  sheet.clear();

  // Store as JSON string in A1
  const jsonString = JSON.stringify(data);
  sheet.getRange('A1').setValue(jsonString);

  // Also set a timestamp in B1
  sheet.getRange('B1').setValue(new Date().toISOString());

  return {
    success: true,
    sheet: sheetName,
    timestamp: new Date().toISOString(),
    size: jsonString.length
  };
}

// Read all sheets at once
function readAllSheets(ss) {
  const sheets = ['Fleet', 'Goals', 'TruckStatus', 'DailyLogs', 'Shipments', 'MonthlyPlan'];
  const result = {};

  sheets.forEach(name => {
    const data = readSheet(ss, name);
    if (data.data) {
      result[name] = data.data;
    }
  });

  return { data: result, timestamp: new Date().toISOString() };
}

// Initialize sheets with headers
function initializeSheets(ss) {
  const sheets = ['Fleet', 'Goals', 'TruckStatus', 'DailyLogs', 'Shipments', 'MonthlyPlan'];
  const created = [];

  sheets.forEach(name => {
    let sheet = ss.getSheetByName(name);
    if (!sheet) {
      sheet = ss.insertSheet(name);
      created.push(name);
    }
  });

  return {
    success: true,
    created: created,
    existing: sheets.filter(s => !created.includes(s)),
    timestamp: new Date().toISOString()
  };
}

// ============================================
// DEPLOYMENT INSTRUCTIONS:
// ============================================
// 1. Go to Extensions > Apps Script in your Google Sheet
// 2. Delete ALL existing code
// 3. Paste this entire file
// 4. Save (Ctrl+S)
// 5. Click Deploy > Manage deployments
// 6. Click the pencil icon to edit
// 7. Change "Version" to "New version"
// 8. Ensure "Execute as" = Me
// 9. Ensure "Who has access" = Anyone
// 10. Click Deploy
//
// CRITICAL: You MUST select "New version" for changes to work!
// ============================================
